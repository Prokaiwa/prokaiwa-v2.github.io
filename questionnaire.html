<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KLVF2ZG1WX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-KLVF2ZG1WX');
</script>
  <meta charset="UTF-8">
  <title>Prokaiwa | Questionnaire</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Complete your Prokaiwa profile to start your English learning journey.">
  <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    /* Loading spinner styles */
    .btn-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.7;
    }
    .btn-loading::after {
      content: "";
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin-left: -8px;
      margin-top: -8px;
      border: 2px solid transparent;
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .btn-text { transition: opacity 0.2s; }
    .btn-loading .btn-text { opacity: 0; }
    
    /* Helper text styles */
    .field-hint {
      font-size: 0.85rem;
      color: var(--color-text-muted);
      margin-top: 0.25rem;
    }
    .field-hint a {
      color: var(--color-primary);
    }
    
    /* Progress indicator (optional visual enhancement) */
    .form-progress {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 2rem;
    }
    .form-progress-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: var(--color-border);
    }
    .form-progress-dot.active {
      background-color: var(--color-primary);
    }
    
    /* Terms section styling */
    .terms-intro {
      font-size: 0.95rem;
      color: var(--color-text-light);
      margin-bottom: 1rem;
      padding: 1rem;
      background-color: var(--color-bg);
      border-radius: 8px;
      border-left: 3px solid var(--color-primary);
    }
    
    /* Page loading overlay */
    .page-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--color-bg, #fff);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .page-loading-overlay.hidden {
      display: none;
    }
    .page-loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--color-border, #e0e0e0);
      border-top-color: var(--color-primary, #007bff);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
  </style>
</head>
<body>
    <!-- Page loading overlay - shown while checking auth -->
    <div id="page-loading" class="page-loading-overlay">
      <div class="page-loading-spinner"></div>
    </div>

    <header class="site-header">
        <div class="container">
            <a href="index.html"><img src="assets/images/prokaiwa-logo.jpg" alt="Prokaiwa Logo" class="logo" /></a>
            <button class="burger-menu" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><a href="login.html">Log In</a></li>
                    <li>
                        <div class="nav-lang-toggle">
                            <button data-lang="ja" aria-label="日本語に切り替え">日本語</button>
                            <button data-lang="en" aria-label="Switch to English">English</button>
                        </div>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <!-- JAPANESE VERSION -->
        <section id="ja-questionnaire" class="lang-section" lang="ja">
            <div class="questionnaire-container">
                <h1 class="page-title">Prokaiwaへようこそ！</h1>
                <p class="page-subtitle">レッスン開始前に、簡単なアンケートにお答えください。</p>
                
                <div id="ja-message-box" class="message-box"></div>

                <form id="ja-questionnaire-form" data-lang="ja">
                    <!-- Personal Info Section -->
                    <fieldset>
                        <legend class="section-heading" style="margin-top: 0;">基本情報</legend>
                        
                        <div class="form-group">
                            <label for="ja-user-id">ユーザーID</label>
                            <input type="text" id="ja-user-id" name="user-id" readonly placeholder="ログイン後に自動入力されます">
                        </div>
                        <div class="form-group">
                            <label for="ja-full-name">氏名（日本語）</label>
                            <input type="text" id="ja-full-name" name="full-name" required placeholder="例：山田 太郎">
                        </div>
                        <div class="form-group">
                            <label for="ja-given-name-romaji">名前（ローマ字）</label>
                            <input type="text" id="ja-given-name-romaji" name="given-name-romaji" required placeholder="例：Taro">
                            <p class="field-hint">※レッスン中に使用するお名前です</p>
                        </div>
                        <div class="form-group">
                            <label for="ja-email">メールアドレス</label>
                            <input type="email" id="ja-email" name="email" required placeholder="example@email.com">
                        </div>
                        <div class="form-group">
                            <label for="ja-line-id">LINE ID</label>
                            <input type="text" id="ja-line-id" name="line-id" required placeholder="例：prokaiwa_user">
                            <p class="field-hint">※LINE IDの確認方法：LINEアプリ → 設定 → プロフィール → ID</p>
                        </div>
                    </fieldset>

                    <!-- Plan Selection -->
                    <fieldset class="form-group-radio">
    <legend>プランを選択してください</legend>
    <label class="radio-option">
        <input type="radio" name="ja-plan" value="power_lite" required>
        <strong>パワーパック・ライト</strong>
        <span class="plan-details">月額10,000円 - LINE練習＋月2回のビデオレッスン</span>
        <span class="checkmark"></span>
    </label>
    <label class="radio-option">
        <input type="radio" name="ja-plan" value="line">
        <strong>LINEプラクティスプラン</strong>
        <span class="plan-details">月額6,000円 - LINEでの毎日の英会話練習</span>
        <span class="checkmark"></span>
    </label>
    <label class="radio-option">
        <input type="radio" name="ja-plan" value="power_pro">
        <strong>パワーパック・プロ</strong>
        <span class="plan-details">月額16,000円 - 最も充実した総合パッケージ</span>
        <span class="checkmark"></span>
    </label>
    <label class="radio-option">
        <input type="radio" name="ja-plan" value="video">
        <strong>1対1ビデオレッスン（50分）</strong>
        <span class="plan-details">1回4,000円 - 気軽に話せる個別レッスン</span>
        <span class="checkmark"></span>
    </label>
</fieldset>

                    <!-- English Level -->
                    <fieldset>
                        <div class="form-group">
                            <label for="ja-english-level">現在の英語レベル</label>
                            <select id="ja-english-level" name="english-level" required>
                                <option value="" disabled selected>レベルを選んでください...</option>
                                <option value="Super Beginner">超初級 - これから英語を始める方</option>
                                <option value="Beginner">初級 - 簡単な単語やフレーズが分かる</option>
                                <option value="Intermediate">中級 - 日常会話ができる</option>
                                <option value="Advanced">上級 - ほとんどの会話に不自由しない</option>
                            </select>
                        </div>
                    </fieldset>

                    <!-- Purpose -->
                    <fieldset class="form-group-radio">
                        <legend>英語を学ぶ目的は何ですか？</legend>
                        <label class="radio-option">
                            <input type="radio" name="ja-purpose" value="Fun / Hobby" required>
                            楽しみ・趣味として
                            <span class="checkmark"></span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="ja-purpose" value="Business / Work">
                            仕事・ビジネスで使いたい
                            <span class="checkmark"></span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="ja-purpose" value="Travel">
                            旅行で使いたい
                            <span class="checkmark"></span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="ja-purpose" value="Casual Conversation">
                            外国の友達と話したい
                            <span class="checkmark"></span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="ja-purpose" value="Other" id="ja-purpose-other-checkbox">
                            その他
                            <span class="checkmark"></span>
                        </label>
                        <div class="form-group" id="ja-purpose-other-container" style="display:none; margin-top: 1rem;">
                            <label for="ja-purpose-other-text">具体的に教えてください：</label>
                            <input type="text" id="ja-purpose-other-text" name="purpose-other-text">
                        </div>
                    </fieldset>
                    
                    <!-- How did you hear about us -->
                    <fieldset class="form-group-checkbox">
                        <legend>Prokaiwaをどこで知りましたか？（複数選択可）</legend>
                        <label class="checkbox-option">
                            <input type="checkbox" name="ja-source" value="Social Media"> SNS（Instagram、X など）
                            <span class="checkmark"></span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="ja-source" value="Friend Recommendation" id="ja-source-friend-checkbox"> 友人・知人からの紹介
                            <span class="checkmark"></span>
                        </label>
                        <div class="form-group" id="ja-source-friend-container" style="display:none; margin-top: 1rem;">
                            <label for="ja-source-friend-text">紹介者のお名前（割引適用のため）：</label>
                            <input type="text" id="ja-source-friend-text" name="source-friend-text" placeholder="例：山田さん">
                        </div>
                        <label class="checkbox-option">
                            <input type="checkbox" name="ja-source" value="Advertisement"> 広告
                            <span class="checkmark"></span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="ja-source" value="Search Engine"> Google検索
                            <span class="checkmark"></span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="ja-source" value="Other" id="ja-source-other-checkbox"> その他
                            <span class="checkmark"></span>
                        </label>
                        <div class="form-group" id="ja-source-other-container" style="display:none; margin-top: 1rem;">
                            <label for="ja-source-other-text">具体的に教えてください：</label>
                            <input type="text" id="ja-source-other-text" name="source-other-text">
                        </div>
                    </fieldset>

                    <!-- Optional Social -->
                    <fieldset>
                        <div class="form-group">
                            <label for="ja-instagram-x">Instagram または X のアカウント（任意）</label>
                            <input type="text" id="ja-instagram-x" name="instagram-x" placeholder="@username">
                        </div>
                    </fieldset>

                    <!-- Terms Agreement -->
                    <fieldset class="form-group-checkbox">
                        <legend>以下の内容をご確認ください</legend>
                        <div class="terms-intro">
                            サービス開始前に、以下の項目への同意が必要です。
                        </div>
                        <label class="checkbox-option">
                            <input type="checkbox" name="ja-agree-apps" required> 
                            レッスンはLINEおよびZoom（ビデオ通話）で行われることを理解しました。
                            <span class="checkmark"></span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="ja-agree-video-times" required> 
                            ビデオレッスンは土曜・日曜（日本時間）のみ対応可能であることを理解しました。
                            <span class="checkmark"></span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="ja-agree-terms" required>
                            <strong>利用規約に同意します：</strong>プランA・C1・C2は月額自動更新制です。キャンセルは次回請求日の3日前までにLINE/メールでご連絡ください。お支払い後の返金はできません。
                            <span class="checkmark"></span>
                        </label>
                    </fieldset>

                    <button type="submit" class="cta-button form-submit-button">
                        <span class="btn-text">お支払いへ進む</span>
                    </button>
                </form>
            </div>
        </section>

        <!-- ENGLISH VERSION -->
        <section id="en-questionnaire" class="lang-section" lang="en">
            <div class="questionnaire-container">
                <h1 class="page-title">Welcome to Prokaiwa!</h1>
                <p class="page-subtitle">Please tell us a bit about yourself to get started.</p>
                
                <div id="en-message-box" class="message-box"></div>

                <form id="en-questionnaire-form" data-lang="en">
                    <!-- Personal Info Section -->
                    <fieldset>
                        <legend class="section-heading" style="margin-top: 0;">Basic Information</legend>
                        
                        <div class="form-group">
                            <label for="en-user-id">User ID</label>
                            <input type="text" id="en-user-id" name="user-id" readonly placeholder="Auto-filled after login">
                        </div>
                        <div class="form-group">
                            <label for="en-full-name">Full Name (Japanese)</label>
                            <input type="text" id="en-full-name" name="full-name" required placeholder="e.g., 山田 太郎">
                        </div>
                        <div class="form-group">
                            <label for="en-given-name-romaji">First Name (Romaji)</label>
                            <input type="text" id="en-given-name-romaji" name="given-name-romaji" required placeholder="e.g., Taro">
                            <p class="field-hint">This is what we'll call you during lessons</p>
                        </div>
                        <div class="form-group">
                            <label for="en-email">Email</label>
                            <input type="email" id="en-email" name="email" required placeholder="example@email.com">
                        </div>
                        <div class="form-group">
                            <label for="en-line-id">LINE ID</label>
                            <input type="text" id="en-line-id" name="line-id" required placeholder="e.g., prokaiwa_user">
                            <p class="field-hint">Find your LINE ID: LINE app → Settings → Profile → ID</p>
                        </div>
                    </fieldset>

                    <!-- Plan Selection -->
                    <fieldset class="form-group-radio">
    <legend>Choose your plan</legend>
    <label class="radio-option">
        <input type="radio" name="en-plan" value="power_lite" required>
        <strong>Power Pack Lite</strong>
        <span class="plan-details">¥10,000/month - LINE practice + 2 video lessons/month</span>
        <span class="checkmark"></span>
    </label>
    <label class="radio-option">
        <input type="radio" name="en-plan" value="line">
        <strong>LINE Practice Plan</strong>
        <span class="plan-details">¥6,000/month - Daily English conversation via LINE</span>
        <span class="checkmark"></span>
    </label>
    <label class="radio-option">
        <input type="radio" name="en-plan" value="power_pro">
        <strong>Power Pack Pro</strong>
        <span class="plan-details">¥16,000/month - Our most comprehensive package</span>
        <span class="checkmark"></span>
    </label>
    <label class="radio-option">
        <input type="radio" name="en-plan" value="video">
        <strong>1-on-1 Video Lesson (50min)</strong>
        <span class="plan-details">¥4,000/lesson - Casual or business English practice</span>
        <span class="checkmark"></span>
    </label>
</fieldset>

                    <!-- English Level -->
                    <fieldset>
                        <div class="form-group">
                            <label for="en-english-level">Your English Level</label>
                            <select id="en-english-level" name="english-level" required>
                                <option value="" disabled selected>Select your level...</option>
                                <option value="Super Beginner">Super Beginner - Just starting out</option>
                                <option value="Beginner">Beginner - Know basic words and phrases</option>
                                <option value="Intermediate">Intermediate - Can have simple conversations</option>
                                <option value="Advanced">Advanced - Comfortable with most conversations</option>
                            </select>
                        </div>
                    </fieldset>

                    <!-- Purpose -->
                    <fieldset class="form-group-radio">
                        <legend>What is your purpose for learning English?</legend>
                        <label class="radio-option">
                            <input type="radio" name="en-purpose" value="Fun / Hobby" required>
                            Fun / Hobby
                            <span class="checkmark"></span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="en-purpose" value="Business / Work">
                            Business / Work
                            <span class="checkmark"></span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="en-purpose" value="Travel">
                            Travel
                            <span class="checkmark"></span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="en-purpose" value="Casual Conversation">
                            Making friends / Casual conversation
                            <span class="checkmark"></span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="en-purpose" value="Other" id="en-purpose-other-checkbox">
                            Other
                            <span class="checkmark"></span>
                        </label>
                        <div class="form-group" id="en-purpose-other-container" style="display:none; margin-top: 1rem;">
                            <label for="en-purpose-other-text">Please specify:</label>
                            <input type="text" id="en-purpose-other-text" name="purpose-other-text">
                        </div>
                    </fieldset>
                    
                    <!-- How did you hear about us -->
                    <fieldset class="form-group-checkbox">
                        <legend>How did you hear about Prokaiwa? (Select all that apply)</legend>
                        <label class="checkbox-option">
                            <input type="checkbox" name="en-source" value="Social Media"> Social Media (Instagram, X, etc.)
                            <span class="checkmark"></span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="en-source" value="Friend Recommendation" id="en-source-friend-checkbox"> Friend Recommendation
                            <span class="checkmark"></span>
                        </label>
                        <div class="form-group" id="en-source-friend-container" style="display:none; margin-top: 1rem;">
                            <label for="en-source-friend-text">Friend's name (for referral discount):</label>
                            <input type="text" id="en-source-friend-text" name="source-friend-text" placeholder="e.g., Yamada-san">
                        </div>
                        <label class="checkbox-option">
                            <input type="checkbox" name="en-source" value="Advertisement"> Advertisement
                            <span class="checkmark"></span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="en-source" value="Search Engine"> Google Search
                            <span class="checkmark"></span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="en-source" value="Other" id="en-source-other-checkbox"> Other
                            <span class="checkmark"></span>
                        </label>
                        <div class="form-group" id="en-source-other-container" style="display:none; margin-top: 1rem;">
                            <label for="en-source-other-text">Please specify:</label>
                            <input type="text" id="en-source-other-text" name="source-other-text">
                        </div>
                    </fieldset>

                    <!-- Optional Social -->
                    <fieldset>
                        <div class="form-group">
                            <label for="en-instagram-x">Instagram or X account (optional)</label>
                            <input type="text" id="en-instagram-x" name="instagram-x" placeholder="@username">
                        </div>
                    </fieldset>

                    <!-- Terms Agreement -->
                    <fieldset class="form-group-checkbox">
                        <legend>Please confirm the following</legend>
                        <div class="terms-intro">
                            Please agree to the following terms before proceeding.
                        </div>
                        <label class="checkbox-option">
                            <input type="checkbox" name="en-agree-apps" required> 
                            I understand that lessons will be conducted through LINE and/or Zoom video calls.
                            <span class="checkmark"></span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="en-agree-video-times" required> 
                            I understand that video lessons are only available on Saturdays and Sundays (JST).
                            <span class="checkmark"></span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="en-agree-terms" required>
                            <strong>I agree to the terms:</strong> Plans A, C1, & C2 are monthly auto-renewing subscriptions. Cancel via LINE/email at least 3 days before your next billing date. No refunds after payment.
                            <span class="checkmark"></span>
                        </label>
                    </fieldset>

                    <button type="submit" class="cta-button form-submit-button">
                        <span class="btn-text">Continue to Payment</span>
                    </button>
                </form>
            </div>
        </section>
    </main>
    
    <footer class="site-footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-column">
                    <h3>Company</h3>
                    <ul>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Legal</h3>
                    <ul>
                        <li><a href="commerce-disclosure.html">Commerce Disclosure</a></li>
                        <li><a href="privacy-policy.html">Privacy Policy</a></li>
                        <li><a href="terms-of-service.html">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Connect</h3>
                    <div class="footer-social-icons">
                        <a href="https://page.line.me/845irjbc" class="social-icon" target="_blank" aria-label="LINE"><i class="fab fa-line"></i></a>
                        <a href="https://www.instagram.com/prokaiwa.english/" class="social-icon" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                        <a href="https://x.com/ProkaiwaEnglish" class="social-icon" target="_blank" aria-label="X (formerly Twitter)"><i class="fab fa-x-twitter"></i></a>
                    </div>
                    <a href="mailto:prokaiwa.english@gmail.com" class="footer-email">prokaiwa.english@gmail.com</a>
                </div>
            </div>
            <p>© <span id="year"></span> Prokaiwa. All rights reserved.</p>
        </div>
    </footer>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/+esm';

        // --- Supabase Setup - MUST MATCH login.html and dashboard.html ---
        const SUPABASE_URL = 'https://luyzyzefgintksydmwoh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1eXp5emVmZ2ludGtzeWRtd29oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5NzYyMDUsImV4cCI6MjA2ODU1MjIwNX0.he5_j99ZtAj4K_zzgm11NEEv7TrbRJYndJXot25s_Kg';
        
        // FIX: Create client with SAME configuration as login and dashboard pages
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: true,
                storageKey: 'prokaiwa-supabase-auth',  // MUST match all other pages
                storage: window.localStorage,
                autoRefreshToken: true,
                detectSessionInUrl: true
            }
        });

        // Update the Stripe links
const baseStripeLinks = {
    'line':       'https://buy.stripe.com/test_00w3cu0EbgZ59NO3fVes006', // Test
    'video':      'https://buy.stripe.com/test_14A4gyev14cj2lm2bRes007', // Test
    'power_lite': 'https://buy.stripe.com/test_5kQaEW0EbcIP6BC5o3es008', // Test
    'power_pro':  'https://buy.stripe.com/test_00w9ASfz5bEL4tu8Afes005' // Test
};

const successUrls = {
    'line':       `${window.location.origin}/thank-you-line.html`,
    'video':      `${window.location.origin}/thank-you.html`,
    'power_lite': `${window.location.origin}/thank-you-pro.html`,
    'power_pro':  `${window.location.origin}/thank-you-pro.html`
};

        // --- Language Detection ---
        function getCurrentLang() {
            return localStorage.getItem('prokaiwa-lang') || 'ja';
        }
        
        function hidePageLoading() {
            const overlay = document.getElementById('page-loading');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }

        // --- Helper Functions ---
        function showMessage(message, type = 'error') {
            const lang = getCurrentLang();
            const messageBox = document.getElementById(`${lang}-message-box`);
            messageBox.textContent = message;
            messageBox.className = `message-box ${type}`;
            messageBox.style.display = 'block';
            window.scrollTo(0, 0);
        }

        function setButtonLoading(button, isLoading) {
            if (isLoading) {
                button.classList.add('btn-loading');
                button.disabled = true;
            } else {
                button.classList.remove('btn-loading');
                button.disabled = false;
            }
        }

        // --- Error Messages (Localized) ---
        const messages = {
            ja: {
                notLoggedIn: 'ログインが必要です。ログインページに戻ります。',
                saveError: 'データの保存中にエラーが発生しました：',
                paymentLinkError: 'このプランの支払いリンクが設定されていません。',
                genericError: 'エラーが発生しました。もう一度お試しください。'
            },
            en: {
                notLoggedIn: 'You must be logged in. Redirecting to login page.',
                saveError: 'Error saving data: ',
                paymentLinkError: 'Payment link is not configured for this plan.',
                genericError: 'An error occurred. Please try again.'
            }
        };

        // --- Toggle conditional fields ---
        function setupConditionalFields(lang) {
            // Purpose "Other" toggle
            const purposeOther = document.getElementById(`${lang}-purpose-other-checkbox`);
            const purposeOtherContainer = document.getElementById(`${lang}-purpose-other-container`);
            
            // For radio buttons, we need to listen to all options
            document.querySelectorAll(`input[name="${lang}-purpose"]`).forEach(radio => {
                radio.addEventListener('change', () => {
                    purposeOtherContainer.style.display = 
                        document.getElementById(`${lang}-purpose-other-checkbox`).checked ? 'block' : 'none';
                });
            });

            // Source "Friend" toggle
            const sourceFriend = document.getElementById(`${lang}-source-friend-checkbox`);
            const sourceFriendContainer = document.getElementById(`${lang}-source-friend-container`);
            sourceFriend.addEventListener('change', (e) => {
                sourceFriendContainer.style.display = e.target.checked ? 'block' : 'none';
            });

            // Source "Other" toggle
            const sourceOther = document.getElementById(`${lang}-source-other-checkbox`);
            const sourceOtherContainer = document.getElementById(`${lang}-source-other-container`);
            sourceOther.addEventListener('change', (e) => {
                sourceOtherContainer.style.display = e.target.checked ? 'block' : 'none';
            });
        }

        // Setup conditional fields for both languages
        setupConditionalFields('ja');
        setupConditionalFields('en');

        // --- Form Submission ---
        document.querySelectorAll('[id$="-questionnaire-form"]').forEach(form => {
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                
                const lang = form.dataset.lang;
                const localMessages = messages[lang];
                const submitBtn = form.querySelector('button[type="submit"]');
                
                // FIX: Use getSession() instead of getUser()
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError || !session) {
                    console.error('Session error:', sessionError);
                    showMessage(localMessages.notLoggedIn);
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                const user = session.user;

                setButtonLoading(submitBtn, true);

                // Collect form data
                const selectedPlan = form.querySelector(`input[name="${lang}-plan"]:checked`)?.value;
                const selectedPurpose = form.querySelector(`input[name="${lang}-purpose"]:checked`)?.value;
                
                // Handle purpose - normalize to simple values
let purpose = selectedPurpose;

// Map friendly names to simple database values
const purposeMap = {
    'Fun / Hobby': 'Hobby',
    'Business / Work': 'Work',
    'Travel': 'Travel',
    'Casual Conversation': 'Casual',
    'Other': 'Hobby'  // Default "Other" to Hobby prompts
};

if (selectedPurpose === 'Other') {
    const otherText = document.getElementById(`${lang}-purpose-other-text`).value;
    // Store their custom purpose in goals for your review later
    // But send them Hobby prompts for now so they get SOMETHING
    purpose = 'Hobby';
} else {
    purpose = purposeMap[selectedPurpose] || 'Hobby';
}

                // Collect source checkboxes
                const sourceCheckboxes = form.querySelectorAll(`input[name="${lang}-source"]:checked`);
                let sources = Array.from(sourceCheckboxes).map(cb => cb.value);
                
                // Handle friend referral
                if (sources.includes('Friend Recommendation')) {
                    const friendName = document.getElementById(`${lang}-source-friend-text`).value;
                    sources = sources.filter(s => s !== 'Friend Recommendation');
                    sources.push(friendName ? `Friend: ${friendName}` : 'Friend Recommendation');
                }
                
                // Handle "Other" source
                if (sources.includes('Other')) {
                    const otherSourceText = document.getElementById(`${lang}-source-other-text`).value;
                    sources = sources.filter(s => s !== 'Other');
                    if (otherSourceText) sources.push(`Other: ${otherSourceText}`);
                }
                
                const dataToSubmit = {
                    user_id: user.id,
                    name: document.getElementById(`${lang}-full-name`).value,
                    given_name_romaji: document.getElementById(`${lang}-given-name-romaji`).value,
                    email: document.getElementById(`${lang}-email`).value,
                    line_id: document.getElementById(`${lang}-line-id`).value,
                    plan: selectedPlan,
                    level: document.getElementById(`${lang}-english-level`).value,
                    goals: {
                        purpose: purpose,
                        how_heard: sources,
                        social_account: document.getElementById(`${lang}-instagram-x`).value || 'N/A',
                        agreed_to_terms: {
                            apps: form.querySelector(`input[name="${lang}-agree-apps"]`).checked,
                            video_times: form.querySelector(`input[name="${lang}-agree-video-times"]`).checked,
                            subscriptions: form.querySelector(`input[name="${lang}-agree-terms"]`).checked
                        }
                    },
                    updated_at: new Date().toISOString()
                };

                try {
                    const { error } = await supabase
                        .from('questionnaire_responses')
                        .upsert(dataToSubmit, { onConflict: 'user_id' });

                    if (error) {
                        setButtonLoading(submitBtn, false);
                        showMessage(`${localMessages.saveError}${error.message}`);
                    } else {
                        const baseUrl = baseStripeLinks[selectedPlan];
                        
                        if (!baseUrl) {
                            setButtonLoading(submitBtn, false);
                            showMessage(localMessages.paymentLinkError);
                            return;
                        }

                        const stripeLink = `${baseUrl}?client_reference_id=${user.id}`;
                        window.location.href = stripeLink;
                    }
                } catch (err) {
                    console.error('Form submission error:', err);
                    setButtonLoading(submitBtn, false);
                    showMessage(localMessages.genericError);
                }
            });
        });

        // --- Initial Setup ---
        async function initializePage() {
            console.log('Initializing questionnaire page...');
            
            try {
                // FIX: Use getSession() instead of getUser()
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error('Session error:', error);
                }
                
                if (session && session.user) {
                    const user = session.user;
                    console.log('User authenticated:', user.email);
                    
                    // Fill in user ID and email for both language forms
                    ['ja', 'en'].forEach(lang => {
                        document.getElementById(`${lang}-user-id`).value = user.id;
                        document.getElementById(`${lang}-email`).value = user.email;
                    });
                    
                    hidePageLoading();
                } else {
                    // Redirect to login if not authenticated
                    console.log('No session found, redirecting to login');
                    window.location.href = 'login.html';
                }
            } catch (err) {
                console.error('Initialization error:', err);
                window.location.href = 'login.html';
            }
        }
        
        // FIX: Listen for auth state changes
        supabase.auth.onAuthStateChange((event, session) => {
            console.log('Auth state changed:', event);
            
            if (event === 'SIGNED_OUT') {
                window.location.href = 'login.html';
            }
        });
        
        // Run initialization
        initializePage();
    </script>
    <script src="assets/js/script.js"></script>
</body>
</html>

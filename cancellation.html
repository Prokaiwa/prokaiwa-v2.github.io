<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KLVF2ZG1WX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-KLVF2ZG1WX');
    </script>
    
    <meta charset="UTF-8">
    <title>Prokaiwa | Cancel Subscription</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="We'd hate to see you go. Let us know how we can improve.">
    <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* Cancellation Page Specific Styles */
        .cancellation-container {
            max-width: 800px;
            margin: 3rem auto;
            padding: 2rem;
        }
        
        .cancellation-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .cancellation-header h1 {
            color: var(--color-text);
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .cancellation-header p {
            color: var(--color-text-light);
            font-size: 1.1rem;
        }
        
        /* Progress Steps */
        .cancellation-steps {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 3rem;
            padding: 0 1rem;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            max-width: 150px;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--color-bg);
            border: 2px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--color-text-muted);
            transition: all 0.3s ease;
        }
        
        .step.active .step-circle {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }
        
        .step.completed .step-circle {
            background: var(--color-success);
            border-color: var(--color-success);
            color: white;
        }
        
        .step-label {
            font-size: 0.85rem;
            color: var(--color-text-muted);
            text-align: center;
        }
        
        .step.active .step-label {
            color: var(--color-primary);
            font-weight: 600;
        }
        
        /* Cancellation Card */
        .cancellation-card {
            background: var(--color-card-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        /* Step Sections */
        .step-section {
            display: none;
        }
        
        .step-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Reason Selection */
        .reason-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .reason-option {
            padding: 1.25rem;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .reason-option:hover {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }
        
        .reason-option.selected {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
            box-shadow: 0 0 0 3px rgba(0, 128, 128, 0.1);
        }
        
        .reason-icon {
            font-size: 1.5rem;
            width: 40px;
            text-align: center;
        }
        
        .reason-content {
            flex: 1;
        }
        
        .reason-title {
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 0.25rem;
        }
        
        .reason-subtitle {
            font-size: 0.85rem;
            color: var(--color-text-light);
        }
        
        /* Retention Offer */
        .retention-offer {
            background: linear-gradient(135deg, var(--color-primary-light) 0%, rgba(0, 128, 128, 0.05) 100%);
            border: 2px solid var(--color-primary);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            text-align: center;
        }
        
        .retention-offer h3 {
            color: var(--color-primary-dark);
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .retention-offer p {
            color: var(--color-text);
            font-size: 1.05rem;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }
        
        .offer-features {
            text-align: left;
            margin: 1.5rem 0;
            padding-left: 1rem;
        }
        
        .offer-features li {
            color: var(--color-text);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .offer-features i {
            color: var(--color-primary);
            font-size: 1.1rem;
        }
        
        .offer-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }
        
        /* Buttons */
        .btn-primary-action {
            background: var(--color-primary);
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-primary-action:hover {
            background: var(--color-primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 128, 128, 0.3);
        }
        
        .btn-secondary-action {
            background: white;
            color: var(--color-text);
            padding: 1rem 2rem;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-secondary-action:hover {
            border-color: var(--color-text-light);
            background: var(--color-bg);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        /* Confirmation Section */
        .confirmation-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1.5rem;
            border-radius: 0 8px 8px 0;
            margin: 1.5rem 0;
        }
        
        .confirmation-warning h4 {
            color: #856404;
            margin: 0 0 0.75rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .confirmation-warning ul {
            margin: 0.5rem 0 0 1.5rem;
            color: #856404;
        }
        
        .confirmation-details {
            background: var(--color-bg);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--color-border);
        }
        
        .detail-row:last-child {
            border-bottom: none;
        }
        
        .detail-label {
            color: var(--color-text-light);
            font-weight: 500;
        }
        
        .detail-value {
            color: var(--color-text);
            font-weight: 600;
        }
        
        /* Loading State */
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .processing-overlay.show {
            display: flex;
        }
        
        .processing-content {
            background: white;
            padding: 3rem;
            border-radius: 12px;
            text-align: center;
            max-width: 400px;
        }
        
        .processing-content i {
            font-size: 3rem;
            color: var(--color-primary);
            margin-bottom: 1rem;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .cancellation-container {
                padding: 1rem;
                margin: 1rem auto;
            }
            
            .cancellation-card {
                padding: 1.5rem;
            }
            
            .cancellation-steps {
                gap: 0.5rem;
            }
            
            .step {
                max-width: 100px;
            }
            
            .step-circle {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }
            
            .step-label {
                font-size: 0.75rem;
            }
            
            .offer-actions {
                flex-direction: column;
            }
            
            .btn-primary-action,
            .btn-secondary-action,
            .btn-danger {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <a href="index.html"><img src="assets/images/prokaiwa-logo.jpg" alt="Prokaiwa Logo" class="logo" /></a>
            <button class="burger-menu" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><a href="dashboard.html">Dashboard</a></li>
                    <li>
                        <div class="nav-lang-toggle">
                            <button data-lang="ja" aria-label="Êó•Êú¨Ë™û„Å´Âàá„ÇäÊõø„Åà">Êó•Êú¨Ë™û</button>
                            <button data-lang="en" aria-label="Switch to English">English</button>
                        </div>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <!-- Processing Overlay -->
        <div class="processing-overlay" id="processing-overlay">
            <div class="processing-content">
                <i class="fas fa-spinner"></i>
                <h3 id="processing-text">Âá¶ÁêÜ‰∏≠...</h3>
            </div>
        </div>

        <!-- JAPANESE VERSION -->
        <section id="ja-cancellation" class="lang-section" lang="ja">
            <div class="cancellation-container">
                <!-- Header -->
                <div class="cancellation-header">
                    <h1>„Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥„ÅÆ„Ç≠„É£„É≥„Çª„É´</h1>
                    <p>„ÅäÂà•„Çå„Åô„ÇãÂâç„Å´„ÄÅÊîπÂñÑ„ÅÆ„ÅäÊâã‰ºù„ÅÑ„Çí„Åï„Åõ„Å¶„Åè„Å†„Åï„ÅÑ</p>
                </div>

                <!-- Progress Steps -->
                <div class="cancellation-steps">
                    <div class="step active" id="ja-step1">
                        <div class="step-circle">1</div>
                        <div class="step-label">ÁêÜÁî±</div>
                    </div>
                    <div class="step" id="ja-step2">
                        <div class="step-circle">2</div>
                        <div class="step-label">„Ç™„Éï„Ç°„Éº</div>
                    </div>
                    <div class="step" id="ja-step3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Á¢∫Ë™ç</div>
                    </div>
                </div>

                <!-- Cancellation Card -->
                <div class="cancellation-card">
                    <!-- STEP 1: Reason Selection -->
                    <div class="step-section active" id="ja-section-reason">
                        <h2>„Ç≠„É£„É≥„Çª„É´„Åï„Çå„ÇãÁêÜÁî±„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ</h2>
                        <p style="color: var(--color-text-light); margin-bottom: 1rem;">
                            „ÅÇ„Å™„Åü„ÅÆ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÅØ„ÄÅ„Çµ„Éº„Éì„Çπ„ÅÆÊîπÂñÑ„Å´ÂΩπÁ´ã„Å°„Åæ„Åô
                        </p>

                        <div class="reason-grid" id="ja-reason-grid">
                            <!-- Reasons will be populated by JavaScript -->
                        </div>

                        <div style="margin-top: 2rem; text-align: center;">
                            <button class="btn-primary-action" onclick="proceedToOffer('ja')" id="ja-btn-continue" disabled>
                                Ê¨°„Å∏ <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- STEP 2: Retention Offer -->
                    <div class="step-section" id="ja-section-offer">
                        <!-- Offer content will be populated by JavaScript -->
                    </div>

                    <!-- STEP 3: Final Confirmation -->
                    <div class="step-section" id="ja-section-confirm">
                        <h2>Êú¨ÂΩì„Å´„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åô„ÅãÔºü</h2>
                        
                        <div class="confirmation-warning">
                            <h4><i class="fas fa-exclamation-triangle"></i> „Ç≠„É£„É≥„Çª„É´„Åô„Çã„Å®Â§±„ÅÜ„ÇÇ„ÅÆÔºö</h4>
                            <ul id="ja-loss-list">
                                <!-- Will be populated by JavaScript -->
                            </ul>
                        </div>

                        <div class="confirmation-details">
                            <div class="detail-row">
                                <span class="detail-label">ÁèæÂú®„ÅÆ„Éó„É©„É≥</span>
                                <span class="detail-value" id="ja-confirm-plan">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">„Ç¢„ÇØ„Çª„ÇπÁµÇ‰∫ÜÊó•</span>
                                <span class="detail-value" id="ja-confirm-end-date">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">„Ç≠„É£„É≥„Çª„É´ÁêÜÁî±</span>
                                <span class="detail-value" id="ja-confirm-reason">-</span>
                            </div>
                        </div>

                        <div style="margin-top: 2rem; text-align: center; display: flex; gap: 1rem; justify-content: center;">
                            <button class="btn-secondary-action" onclick="goBack('ja')">
                                <i class="fas fa-arrow-left"></i> Êàª„Çã
                            </button>
                            <button class="btn-danger" onclick="confirmCancellation('ja')">
                                <i class="fas fa-times-circle"></i> „Ç≠„É£„É≥„Çª„É´„ÇíÁ¢∫ÂÆö
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ENGLISH VERSION -->
        <section id="en-cancellation" class="lang-section" lang="en">
            <div class="cancellation-container">
                <!-- Header -->
                <div class="cancellation-header">
                    <h1>Cancel Subscription</h1>
                    <p>Before you go, let us help make things better</p>
                </div>

                <!-- Progress Steps -->
                <div class="cancellation-steps">
                    <div class="step active" id="en-step1">
                        <div class="step-circle">1</div>
                        <div class="step-label">Reason</div>
                    </div>
                    <div class="step" id="en-step2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Offer</div>
                    </div>
                    <div class="step" id="en-step3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Confirm</div>
                    </div>
                </div>

                <!-- Cancellation Card -->
                <div class="cancellation-card">
                    <!-- STEP 1: Reason Selection -->
                    <div class="step-section active" id="en-section-reason">
                        <h2>Why are you cancelling?</h2>
                        <p style="color: var(--color-text-light); margin-bottom: 1rem;">
                            Your feedback helps us improve our service
                        </p>

                        <div class="reason-grid" id="en-reason-grid">
                            <!-- Reasons will be populated by JavaScript -->
                        </div>

                        <div style="margin-top: 2rem; text-align: center;">
                            <button class="btn-primary-action" onclick="proceedToOffer('en')" id="en-btn-continue" disabled>
                                Continue <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- STEP 2: Retention Offer -->
                    <div class="step-section" id="en-section-offer">
                        <!-- Offer content will be populated by JavaScript -->
                    </div>

                    <!-- STEP 3: Final Confirmation -->
                    <div class="step-section" id="en-section-confirm">
                        <h2>Are you sure you want to cancel?</h2>
                        
                        <div class="confirmation-warning">
                            <h4><i class="fas fa-exclamation-triangle"></i> You'll lose access to:</h4>
                            <ul id="en-loss-list">
                                <!-- Will be populated by JavaScript -->
                            </ul>
                        </div>

                        <div class="confirmation-details">
                            <div class="detail-row">
                                <span class="detail-label">Current Plan</span>
                                <span class="detail-value" id="en-confirm-plan">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Access Until</span>
                                <span class="detail-value" id="en-confirm-end-date">-</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Cancellation Reason</span>
                                <span class="detail-value" id="en-confirm-reason">-</span>
                            </div>
                        </div>

                        <div style="margin-top: 2rem; text-align: center; display: flex; gap: 1rem; justify-content: center;">
                            <button class="btn-secondary-action" onclick="goBack('en')">
                                <i class="fas fa-arrow-left"></i> Go Back
                            </button>
                            <button class="btn-danger" onclick="confirmCancellation('en')">
                                <i class="fas fa-times-circle"></i> Confirm Cancellation
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-column">
                    <h3>Company</h3>
                    <ul>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Legal</h3>
                    <ul>
                        <li><a href="commerce-disclosure.html">Commerce Disclosure</a></li>
                        <li><a href="privacy-policy.html">Privacy Policy</a></li>
                        <li><a href="terms-of-service.html">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Connect</h3>
                    <div class="footer-social-icons">
                        <a href="https://page.line.me/845irjbc" class="social-icon" target="_blank" aria-label="LINE"><i class="fab fa-line"></i></a>
                        <a href="https://www.instagram.com/prokaiwa.english/" class="social-icon" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                        <a href="https://x.com/ProkaiwaEnglish" class="social-icon" target="_blank" aria-label="X (formerly Twitter)"><i class="fab fa-x-twitter"></i></a>
                    </div>
                    <a href="mailto:prokaiwa.english@gmail.com" class="footer-email">prokaiwa.english@gmail.com</a>
                </div>
            </div>
            <p>¬© <span id="year"></span> Prokaiwa. All rights reserved.</p>
        </div>
    </footer>

    <script src="assets/js/script.js"></script>
    <script type="module">
// =====================================================
// CANCELLATION RETENTION SYSTEM
// =====================================================

import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

const supabase = createClient(
    'https://luyzyzefgintksydmwoh.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1eXp5emVmZ2ludGtzeWRtd29oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5NzYyMDUsImV4cCI6MjA2ODU1MjIwNX0.he5_j99ZtAj4K_zzgm11NEEv7TrbRJYndJXot25s_Kg'
);

// =====================================================
// CANCELLATION REASONS & RETENTION OFFERS
// =====================================================

const cancellationReasons = {
    ja: [
        {
            id: 'expensive',
            icon: 'üí∞',
            title: 'ÊñôÈáë„ÅåÈ´ò„Åô„Åé„Çã',
            subtitle: '‰∫àÁÆó„Å´Âêà„Çè„Å™„ÅÑ',
            offer: {
                type: 'downgrade',
                title: '„Çà„ÇäÊâãÈ†É„Å™„Éó„É©„É≥„ÅØ„ÅÑ„Åã„Åå„Åß„Åô„ÅãÔºü',
                description: '„ÅäÂÆ¢Êßò„ÅÆ„Éã„Éº„Ç∫„Å´Âêà„Çè„Åõ„Å¶„ÄÅ‰Ωé‰æ°Ê†º„Éó„É©„É≥„Å∏„ÅÆ„ÉÄ„Ç¶„É≥„Ç∞„É¨„Éº„Éâ„Çí„ÅîÊèêÊ°à„Åó„Åæ„Åô„ÄÇ',
                features: [
                    '„Éë„ÉØ„Éº„Éë„ÉÉ„ÇØ„Éª„É©„Ç§„ÉàÔºöÊúàÈ°ç¬•10,000ÔºàÊúà2„É¨„ÉÉ„Çπ„É≥Ôºâ',
                    '„Éó„É©„É≥AÔºöÊúàÈ°ç¬•6,000ÔºàLINE„Éó„É©„ÇØ„ÉÜ„Ç£„Çπ„ÅÆ„ÅøÔºâ',
                    'Êó¢Â≠ò„ÅÆ„ÇØ„É¨„Ç∏„ÉÉ„Éà„ÅØ„Åù„ÅÆ„Åæ„ÅæÂà©Áî®ÂèØËÉΩ',
                    '„ÅÑ„Å§„Åß„ÇÇ„Ç¢„ÉÉ„Éó„Ç∞„É¨„Éº„ÉâÂèØËÉΩ'
                ],
                cta: '„Éó„É©„É≥„Çí„ÉÄ„Ç¶„É≥„Ç∞„É¨„Éº„Éâ',
                action: 'downgrade'
            }
        },
        {
            id: 'not_using',
            icon: 'üìÖ',
            title: '„ÅÇ„Åæ„ÇäÂà©Áî®„Åó„Å¶„ÅÑ„Å™„ÅÑ',
            subtitle: 'ÊôÇÈñì„Åå„Å™„ÅÑ„ÉªÂøò„Çå„Å¶„Åó„Åæ„ÅÜ',
            offer: {
                type: 'pause',
                title: '1„É∂Êúà„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åõ„Çì„ÅãÔºü',
                description: 'Âøô„Åó„ÅÑÊôÇÊúü„ÅØ„ÄÅ„Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥„Çí‰∏ÄÊôÇÂÅúÊ≠¢„Åß„Åç„Åæ„Åô„ÄÇ„Ç≠„É£„É≥„Çª„É´„Åô„ÇãÂøÖË¶Å„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ',
                features: [
                    'ÊúÄÂ§ß3„É∂Êúà„Åæ„Åß‰∏ÄÊôÇÂÅúÊ≠¢ÂèØËÉΩ',
                    '„ÇØ„É¨„Ç∏„ÉÉ„Éà„ÅØ‰øùÊåÅ„Åï„Çå„Åæ„Åô',
                    'Ê∫ñÂÇô„Åå„Åß„Åç„Åü„Çâ„ÅÑ„Å§„Åß„ÇÇÂÜçÈñã',
                    '„Éö„Éä„É´„ÉÜ„Ç£„Å™„Åó'
                ],
                cta: '‰ªäÊúà„Çí„Çπ„Ç≠„ÉÉ„Éó',
                action: 'pause'
            }
        },
        {
            id: 'quality',
            icon: '‚≠ê',
            title: '„Çµ„Éº„Éì„Çπ„ÅÆË≥™„Å´‰∏çÊ∫Ä',
            subtitle: 'ÊúüÂæÖ„Å´Ê≤ø„Çè„Å™„ÅÑ',
            offer: {
                type: 'support',
                title: 'ÊîπÂñÑ„ÅÆ„ÅäÊâã‰ºù„ÅÑ„Çí„Åï„Åõ„Å¶„Åè„Å†„Åï„ÅÑ',
                description: '„ÅÇ„Å™„Åü„ÅÆ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÅØÁßÅ„Åü„Å°„Å´„Å®„Å£„Å¶ÈùûÂ∏∏„Å´ÈáçË¶Å„Åß„Åô„ÄÇ„Çà„ÇäËâØ„ÅÑ„Çµ„Éº„Éì„Çπ„ÇíÊèê‰æõ„Åô„Çã„Åü„ÇÅ„Å´„ÄÅÂÄãÂà•„Å´„Çµ„Éù„Éº„Éà„Åï„Åõ„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
                features: [
                    'ÊïôËÇ≤„Éá„Ç£„É¨„ÇØ„Çø„Éº„Å®„ÅÆÂÄãÂà•Èù¢Ë´á',
                    '„Éë„Éº„ÇΩ„Éä„É©„Ç§„Ç∫„Åï„Çå„ÅüÂ≠¶Áøí„Éó„É©„É≥„ÅÆ‰ΩúÊàê',
                    'ÊïôÂ∏´„ÅÆÂ§âÊõ¥ÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶Ôºâ',
                    'ËøΩÂä†„ÅÆÁÑ°Êñô„É¨„ÉÉ„Çπ„É≥1Âõû'
                ],
                cta: '„Çµ„Éù„Éº„Éà„Å´ÈÄ£Áµ°',
                action: 'support'
            }
        },
        {
            id: 'schedule',
            icon: '‚è∞',
            title: '„Çπ„Ç±„Ç∏„É•„Éº„É´„ÅåÂêà„Çè„Å™„ÅÑ',
            subtitle: '„É¨„ÉÉ„Çπ„É≥„ÅÆÊôÇÈñì„ÅåÂèñ„Çå„Å™„ÅÑ',
            offer: {
                type: 'flexible',
                title: '„Çà„ÇäÊüîËªü„Å™„Çπ„Ç±„Ç∏„É•„Éº„É´„Çí„ÅîÁî®ÊÑè',
                description: '„ÅäÂÆ¢Êßò„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´„Å´Âêà„Çè„Åõ„Å¶„ÄÅ„É¨„ÉÉ„Çπ„É≥ÊôÇÈñì„Çí„Çà„ÇäÊüîËªü„Å´Ë™øÊï¥„Åß„Åç„Åæ„Åô„ÄÇ',
                features: [
                    'Êó©Êúù„ÉªÊ∑±Â§ú„ÅÆ„É¨„ÉÉ„Çπ„É≥Êû†„ÇíËøΩÂä†',
                    '24ÊôÇÈñìÂâç„Åæ„Åß„Ç≠„É£„É≥„Çª„É´ÁÑ°Êñô',
                    'Áü≠Á∏Æ„É¨„ÉÉ„Çπ„É≥Ôºà30ÂàÜÔºâ„Ç™„Éó„Ç∑„Éß„É≥',
                    'Èå≤Áîª„É¨„ÉÉ„Çπ„É≥„ÅÆ„Ç¢„Éº„Ç´„Ç§„Éñ„Ç¢„ÇØ„Çª„Çπ'
                ],
                cta: '„Éï„É¨„Ç≠„Ç∑„Éñ„É´„Éó„É©„É≥„ÇíË©¶„Åô',
                action: 'flexible'
            }
        },
        {
            id: 'goals_met',
            icon: 'üéØ',
            title: 'ÁõÆÊ®ô„ÇíÈÅîÊàê„Åó„Åü',
            subtitle: '„ÇÇ„ÅÜÂøÖË¶Å„Å™„ÅÑ',
            offer: {
                type: 'maintenance',
                title: '„Çπ„Ç≠„É´„ÇíÁ∂≠ÊåÅ„Åó„Åæ„Åõ„Çì„ÅãÔºü',
                description: 'ÁõÆÊ®ôÈÅîÊàê„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ„Çπ„Ç≠„É´„ÇíÁ∂≠ÊåÅ„Åô„Çã„Åü„ÇÅ„ÅÆÊúà1Âõû„ÅÆ„É°„É≥„ÉÜ„Éä„É≥„Çπ„Éó„É©„É≥„ÅØ„ÅÑ„Åã„Åå„Åß„Åô„ÅãÔºü',
                features: [
                    'Êúà1Âõû„ÅÆ„É¨„ÉÉ„Çπ„É≥Ôºà¬•4,000/ÊúàÔºâ',
                    'ÈÄ≤Êçó„ÉÅ„Çß„ÉÉ„ÇØ„Å®„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ',
                    'LINE„Éó„É©„ÇØ„ÉÜ„Ç£„Çπ„ÅØÁ∂ôÁ∂ö',
                    '„ÅÑ„Å§„Åß„ÇÇÂÜçÈñãÂèØËÉΩ'
                ],
                cta: '„É°„É≥„ÉÜ„Éä„É≥„Çπ„Éó„É©„É≥„ÇíË¶ã„Çã',
                action: 'maintenance'
            }
        },
        {
            id: 'other',
            icon: 'üìù',
            title: '„Åù„ÅÆ‰ªñ„ÅÆÁêÜÁî±',
            subtitle: 'Ë©≥Á¥∞„ÇíÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ',
            offer: null // No retention offer, proceed to cancellation
        }
    ],
    en: [
        {
            id: 'expensive',
            icon: 'üí∞',
            title: "It's too expensive",
            subtitle: "Doesn't fit my budget",
            offer: {
                type: 'downgrade',
                title: 'How about a more affordable plan?',
                description: 'We can help you find a plan that better fits your budget while still supporting your learning.',
                features: [
                    'Power Pack Lite: ¬•10,000/month (2 lessons)',
                    'Plan A: ¬•6,000/month (LINE practice only)',
                    'Keep your existing credits',
                    'Upgrade anytime'
                ],
                cta: 'Downgrade Plan',
                action: 'downgrade'
            }
        },
        {
            id: 'not_using',
            icon: 'üìÖ',
            title: "I'm not using it enough",
            subtitle: "Don't have time / Keep forgetting",
            offer: {
                type: 'pause',
                title: 'Skip a month instead?',
                description: "Life gets busy! You can pause your subscription without cancelling completely.",
                features: [
                    'Pause for up to 3 months',
                    'Keep your credits',
                    'Resume whenever ready',
                    'No penalties'
                ],
                cta: 'Pause This Month',
                action: 'pause'
            }
        },
        {
            id: 'quality',
            icon: '‚≠ê',
            title: "Not satisfied with quality",
            subtitle: "Service doesn't meet expectations",
            offer: {
                type: 'support',
                title: "Let's make it better",
                description: 'Your feedback is crucial. Let us work with you personally to improve your experience.',
                features: [
                    'Personal consultation with Education Director',
                    'Customized learning plan',
                    'Change teachers if needed',
                    '1 free bonus lesson'
                ],
                cta: 'Connect with Support',
                action: 'support'
            }
        },
        {
            id: 'schedule',
            icon: '‚è∞',
            title: "Schedule doesn't work",
            subtitle: "Can't find time for lessons",
            offer: {
                type: 'flexible',
                title: 'Try more flexible scheduling',
                description: "We can offer more flexibility to fit your busy schedule.",
                features: [
                    'Early morning & late evening slots',
                    'Free cancellation up to 24h',
                    'Shorter lesson options (30 min)',
                    'Access to recorded lesson archive'
                ],
                cta: 'Try Flexible Schedule',
                action: 'flexible'
            }
        },
        {
            id: 'goals_met',
            icon: 'üéØ',
            title: "Achieved my goals",
            subtitle: "Don't need it anymore",
            offer: {
                type: 'maintenance',
                title: 'Maintain your skills?',
                description: 'Congratulations! How about a light maintenance plan to keep your skills sharp?',
                features: [
                    'Once monthly lesson (¬•4,000/month)',
                    'Progress check & feedback',
                    'Continue LINE practice',
                    'Reactivate anytime'
                ],
                cta: 'See Maintenance Plan',
                action: 'maintenance'
            }
        },
        {
            id: 'other',
            icon: 'üìù',
            title: 'Other reason',
            subtitle: 'Please tell us more',
            offer: null
        }
    ]
};

// =====================================================
// STATE MANAGEMENT
// =====================================================

let currentState = {
    selectedReason: null,
    selectedReasonObj: null,
    userData: null,
    currentLang: 'ja'
};

// =====================================================
// INITIALIZATION
// =====================================================

async function initCancellationPage() {
    console.log('üöÄ Initializing cancellation page...');
    
    // Check authentication
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
        console.log('‚ùå No session found, redirecting to login');
        window.location.href = 'questionnaire.html';
        return;
    }
    
    // Load user data
    const { data: userData, error } = await supabase
        .from('questionnaire_responses')
        .select('*')
        .eq('user_id', session.user.id)
        .single();
    
    if (error || !userData) {
        console.error('‚ùå Error loading user data:', error);
        alert('Error loading account information');
        return;
    }
    
    currentState.userData = userData;
    console.log('‚úÖ User data loaded:', userData.plan);
    
    // Render reason options
    renderReasonOptions('ja');
    renderReasonOptions('en');
}

// =====================================================
// RENDER REASON OPTIONS
// =====================================================

function renderReasonOptions(lang) {
    const grid = document.getElementById(`${lang}-reason-grid`);
    const reasons = cancellationReasons[lang];
    
    grid.innerHTML = reasons.map(reason => `
        <div class="reason-option" data-reason-id="${reason.id}" onclick="selectReason('${reason.id}', '${lang}')">
            <div class="reason-icon">${reason.icon}</div>
            <div class="reason-content">
                <div class="reason-title">${reason.title}</div>
                <div class="reason-subtitle">${reason.subtitle}</div>
            </div>
        </div>
    `).join('');
}

// =====================================================
// SELECT REASON
// =====================================================

window.selectReason = function(reasonId, lang) {
    const reasons = cancellationReasons[lang];
    const reason = reasons.find(r => r.id === reasonId);
    
    // Update visual selection
    document.querySelectorAll(`#${lang}-reason-grid .reason-option`).forEach(el => {
        el.classList.remove('selected');
    });
    document.querySelector(`#${lang}-reason-grid .reason-option[data-reason-id="${reasonId}"]`).classList.add('selected');
    
    // Update state
    currentState.selectedReason = reasonId;
    currentState.selectedReasonObj = reason;
    currentState.currentLang = lang;
    
    // Enable continue button
    document.getElementById(`${lang}-btn-continue`).disabled = false;
    
    console.log('‚úÖ Reason selected:', reasonId);
};

// =====================================================
// PROCEED TO OFFER
// =====================================================

window.proceedToOffer = function(lang) {
    const reason = currentState.selectedReasonObj;
    
    if (!reason) {
        alert(lang === 'ja' ? '„Ç≠„É£„É≥„Çª„É´ÁêÜÁî±„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ' : 'Please select a cancellation reason');
        return;
    }
    
    // Update progress steps
    document.getElementById(`${lang}-step1`).classList.add('completed');
    document.getElementById(`${lang}-step1`).classList.remove('active');
    document.getElementById(`${lang}-step2`).classList.add('active');
    
    // If no offer, skip to confirmation
    if (!reason.offer) {
        showConfirmation(lang);
        return;
    }
    
    // Render retention offer
    renderRetentionOffer(lang, reason.offer);
    
    // Switch to offer section
    document.getElementById(`${lang}-section-reason`).classList.remove('active');
    document.getElementById(`${lang}-section-offer`).classList.add('active');
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
};

// =====================================================
// RENDER RETENTION OFFER
// =====================================================

function renderRetentionOffer(lang, offer) {
    const offerSection = document.getElementById(`${lang}-section-offer`);
    
    const content = `
        <div class="retention-offer">
            <h3>${offer.title}</h3>
            <p>${offer.description}</p>
            
            <ul class="offer-features">
                ${offer.features.map(feature => `
                    <li><i class="fas fa-check-circle"></i> ${feature}</li>
                `).join('')}
            </ul>
            
            <div class="offer-actions">
                <button class="btn-primary-action" onclick="acceptOffer('${lang}', '${offer.action}')">
                    <i class="fas fa-check"></i> ${offer.cta}
                </button>
                <button class="btn-secondary-action" onclick="declineOffer('${lang}')">
                    ${lang === 'ja' ? '„ÅÑ„ÅÑ„Åà„ÄÅ„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åô' : 'No, Continue Cancelling'}
                </button>
            </div>
        </div>
    `;
    
    offerSection.innerHTML = content;
}

// =====================================================
// ACCEPT OFFER
// =====================================================

window.acceptOffer = async function(lang, action) {
    console.log('‚úÖ User accepted offer:', action);
    
    showProcessing(lang === 'ja' ? 'Âá¶ÁêÜ‰∏≠...' : 'Processing...');
    
    try {
        // Track acceptance in database
        const { data: { session } } = await supabase.auth.getSession();
        
        await supabase
            .from('questionnaire_responses')
            .update({
                retention_offer_shown: currentState.selectedReason,
                retention_offer_accepted: true,
                retention_offer_timestamp: new Date().toISOString()
            })
            .eq('user_id', session.user.id);
        
        // Record in analytics
        await supabase
            .from('cancellation_events')
            .insert({
                user_id: session.user.id,
                student_id: currentState.userData.id,
                plan_at_cancellation: currentState.userData.plan,
                reason_category: currentState.selectedReason,
                retention_offer_shown: action,
                retention_offer_result: 'accepted',
                immediately_cancelled: false
            });
        
        hideProcessing();
        
        // Redirect based on action
        const redirectMessage = lang === 'ja' 
            ? '„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ„ÅäÂÆ¢Êßò„ÅÆ„Ç¢„Ç´„Ç¶„É≥„Éà„ÇíÊõ¥Êñ∞„Åó„Å¶„ÅÑ„Åæ„Åô...' 
            : 'Thank you! Updating your account...';
        
        alert(redirectMessage);
        
        if (action === 'downgrade' || action === 'maintenance') {
            window.location.href = 'pricing.html';
        } else if (action === 'support') {
            window.location.href = 'contact.html';
        } else {
            window.location.href = 'dashboard.html';
        }
        
    } catch (error) {
        console.error('‚ùå Error accepting offer:', error);
        hideProcessing();
        alert(lang === 'ja' ? '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü' : 'An error occurred');
    }
};

// =====================================================
// DECLINE OFFER
// =====================================================

window.declineOffer = function(lang) {
    console.log('‚ö†Ô∏è User declined offer');
    
    // Track declination
    supabase.from('questionnaire_responses')
        .update({
            retention_offer_shown: currentState.selectedReason,
            retention_offer_accepted: false,
            retention_offer_timestamp: new Date().toISOString()
        })
        .eq('user_id', currentState.userData.user_id)
        .then(() => console.log('‚úÖ Declination tracked'));
    
    showConfirmation(lang);
};

// =====================================================
// SHOW CONFIRMATION
// =====================================================

function showConfirmation(lang) {
    // Update progress steps
    document.getElementById(`${lang}-step2`).classList.add('completed');
    document.getElementById(`${lang}-step2`).classList.remove('active');
    document.getElementById(`${lang}-step3`).classList.add('active');
    
    // Populate confirmation details
    const planNames = {
        'A': lang === 'ja' ? '„Éó„É©„É≥AÔºàLINEÁ∑¥ÁøíÔºâ' : 'Plan A (LINE Practice)',
        'C1': lang === 'ja' ? '„Éë„ÉØ„Éº„Éë„ÉÉ„ÇØ„Éª„É©„Ç§„Éà' : 'Power Pack Lite',
        'C2': lang === 'ja' ? '„Éë„ÉØ„Éº„Éë„ÉÉ„ÇØ„Éª„Éó„É≠' : 'Power Pack Pro'
    };
    
    document.getElementById(`${lang}-confirm-plan`).textContent = planNames[currentState.userData.plan];
    document.getElementById(`${lang}-confirm-end-date`).textContent = 
        new Date(currentState.userData.subscription_period_end).toLocaleDateString(lang === 'ja' ? 'ja-JP' : 'en-US');
    
    const reasonObj = cancellationReasons[lang].find(r => r.id === currentState.selectedReason);
    document.getElementById(`${lang}-confirm-reason`).textContent = reasonObj.title;
    
    // Populate loss list
    const lossList = document.getElementById(`${lang}-loss-list`);
    const lossItems = lang === 'ja' ? [
        'ÊØéÊó•„ÅÆLINEËã±‰ºöË©±Á∑¥Áøí',
        'ÊúàÊ¨°„Éì„Éá„Ç™„É¨„ÉÉ„Çπ„É≥ÔºàC1/C2„Éó„É©„É≥Ôºâ',
        '„Éë„Éº„ÇΩ„Éä„É©„Ç§„Ç∫„Åï„Çå„Åü„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ',
        'Â≠¶ÁøíÈÄ≤Êçó„Éà„É©„ÉÉ„Ç≠„É≥„Ç∞',
        'ÊïôÂ∏´„Å∏„ÅÆÁõ¥Êé•„Ç¢„ÇØ„Çª„Çπ'
    ] : [
        'Daily LINE conversation practice',
        'Monthly video lessons (C1/C2 plans)',
        'Personalized feedback from teachers',
        'Progress tracking',
        'Direct access to teachers'
    ];
    
    lossList.innerHTML = lossItems.map(item => `<li>${item}</li>`).join('');
    
    // Switch to confirmation section
    document.getElementById(`${lang}-section-offer`).classList.remove('active');
    document.getElementById(`${lang}-section-confirm`).classList.add('active');
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// =====================================================
// GO BACK
// =====================================================

window.goBack = function(lang) {
    const currentSection = document.querySelector(`#${lang}-cancellation .step-section.active`);
    
    if (currentSection.id === `${lang}-section-confirm`) {
        // Go back to offer (or reason if no offer)
        currentSection.classList.remove('active');
        
        if (currentState.selectedReasonObj && currentState.selectedReasonObj.offer) {
            document.getElementById(`${lang}-section-offer`).classList.add('active');
            document.getElementById(`${lang}-step3`).classList.remove('active');
            document.getElementById(`${lang}-step2`).classList.add('active');
            document.getElementById(`${lang}-step2`).classList.remove('completed');
        } else {
            document.getElementById(`${lang}-section-reason`).classList.add('active');
            document.getElementById(`${lang}-step3`).classList.remove('active');
            document.getElementById(`${lang}-step1`).classList.add('active');
            document.getElementById(`${lang}-step1`).classList.remove('completed');
        }
    } else if (currentSection.id === `${lang}-section-offer`) {
        // Go back to reason
        currentSection.classList.remove('active');
        document.getElementById(`${lang}-section-reason`).classList.add('active');
        document.getElementById(`${lang}-step2`).classList.remove('active');
        document.getElementById(`${lang}-step1`).classList.add('active');
        document.getElementById(`${lang}-step1`).classList.remove('completed');
    }
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
};

// =====================================================
// CONFIRM CANCELLATION
// =====================================================

window.confirmCancellation = async function(lang) {
    const confirmMsg = lang === 'ja' 
        ? 'Êú¨ÂΩì„Å´„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åô„ÅãÔºü„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ' 
        : 'Are you sure you want to cancel? This action cannot be undone.';
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    showProcessing(lang === 'ja' ? '„Ç≠„É£„É≥„Çª„É´Âá¶ÁêÜ‰∏≠...' : 'Processing cancellation...');
    
    try {
        const { data: { session } } = await supabase.auth.getSession();
        
        // Call cancellation Edge Function
        const response = await fetch('https://luyzyzefgintksydmwoh.supabase.co/functions/v1/cancel-subscription', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${session.access_token}`
            },
            body: JSON.stringify({
                reason_category: currentState.selectedReason,
                reason_details: cancellationReasons[lang].find(r => r.id === currentState.selectedReason).title
            })
        });
        
        if (!response.ok) {
            throw new Error('Cancellation failed');
        }
        
        const result = await response.json();
        console.log('‚úÖ Cancellation successful:', result);
        
        hideProcessing();
        
        // Show success message
        const successMsg = lang === 'ja'
            ? `„Çµ„Éñ„Çπ„ÇØ„É™„Éó„Ç∑„Éß„É≥„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åó„Åü„ÄÇ\n${new Date(result.access_until).toLocaleDateString('ja-JP')}„Åæ„Åß„Ç¢„ÇØ„Çª„ÇπÂèØËÉΩ„Åß„Åô„ÄÇ`
            : `Your subscription has been cancelled.\nYou have access until ${new Date(result.access_until).toLocaleDateString('en-US')}.`;
        
        alert(successMsg);
        
        // Redirect to dashboard
        window.location.href = 'dashboard.html';
        
    } catch (error) {
        console.error('‚ùå Cancellation error:', error);
        hideProcessing();
        
        const errorMsg = lang === 'ja'
            ? '„Ç≠„É£„É≥„Çª„É´Âá¶ÁêÜ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Çµ„Éù„Éº„Éà„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ'
            : 'An error occurred during cancellation. Please contact support.';
        
        alert(errorMsg);
    }
};

// =====================================================
// PROCESSING OVERLAY
// =====================================================

function showProcessing(message) {
    document.getElementById('processing-text').textContent = message;
    document.getElementById('processing-overlay').classList.add('show');
}

function hideProcessing() {
    document.getElementById('processing-overlay').classList.remove('show');
}

// =====================================================
// INITIALIZE ON LOAD
// =====================================================

document.addEventListener('DOMContentLoaded', initCancellationPage);

console.log('‚úÖ Cancellation system loaded');
</script>
</body>
</html>

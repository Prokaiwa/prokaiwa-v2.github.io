<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KLVF2ZG1WX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-KLVF2ZG1WX');
</script>
  <meta charset="UTF-8">
  <title>Prokaiwa | Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Your Prokaiwa learning dashboard - track progress, access resources, and manage your English learning journey.">
  <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <!-- Chart.js for Pentagon Radar Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* Dashboard-specific styles */
    /* Dashboard-specific container padding */
    #ja-dashboard-content,
    #en-dashboard-content {
      padding-bottom: 2rem;
    }
    
    .site-footer {
      margin-top: 2rem;
    }
    
    .dashboard-loading {
      text-align: center;
      padding: 4rem 2rem;
    }
    .dashboard-loading i {
      font-size: 2rem;
      color: var(--color-primary);
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .dashboard-error {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--color-text);
    }
    .dashboard-error i {
      font-size: 3rem;
      color: #dc3545;
      margin-bottom: 1rem;
    }
    .dashboard-error h2 {
      margin-bottom: 1rem;
    }
    .dashboard-error p {
      margin-bottom: 1.5rem;
      color: var(--color-text-light);
    }
    
    .welcome-banner {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: white;
      padding: 2rem;
      border-radius: var(--border-radius);
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .welcome-banner h1 {
      font-size: 1.75rem;
      margin: 0 0 0.5rem 0;
      color: white;
    }
    .welcome-banner p {
      margin: 0;
      opacity: 0.9;
    }
    .welcome-stats {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
    }
    .welcome-stat {
      text-align: center;
    }
    .welcome-stat-value {
      font-size: 2rem;
      font-weight: 700;
      display: block;
    }
    .welcome-stat-label {
      font-size: 0.85rem;
      opacity: 0.9;
    }
    
    .practice-status-card {
      background: linear-gradient(135deg, #28a745 0%, #20863d 100%);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: var(--border-radius);
      margin-bottom: 2rem;
      text-align: center;
    }
    .practice-status-card.completed {
      background: linear-gradient(135deg, var(--color-gold) 0%, #b8860b 100%);
    }
    .practice-status-card h2 {
      color: white;
      margin: 0 0 0.25rem 0;
      font-size: 1.1rem;
    }
    .practice-status-card p {
      margin: 0;
      opacity: 0.95;
      font-size: 0.9rem;
    }
    .practice-status-icon {
      font-size: 2rem;
      margin-bottom: 0.25rem;
    }
    
    @media (max-width: 768px) {
      .practice-status-card {
        padding: 0.75rem 1.25rem;
        margin-bottom: 1.5rem;
      }
      .practice-status-card h2 {
        font-size: 1rem;
      }
      .practice-status-card p {
        font-size: 0.85rem;
      }
      .practice-status-icon {
        font-size: 1.5rem;
        margin-bottom: 0.2rem;
      }
    }
    
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .quick-action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1.25rem 1rem;
      background-color: var(--color-card-bg);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      text-decoration: none;
      color: var(--color-text);
      transition: all var(--transition-speed) ease;
      text-align: center;
      cursor: pointer;
    }
    .quick-action-btn:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-hover);
      border-color: var(--color-primary);
    }
    .quick-action-btn i {
      font-size: 1.5rem;
      color: var(--color-primary);
      margin-bottom: 0.5rem;
    }
    .quick-action-btn span {
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
    }
    
    .card-skills {
      grid-column: 2 / 3;
      grid-row: 1 / 3;
      background: linear-gradient(135deg, rgba(0, 128, 128, 0.05) 0%, rgba(0, 128, 128, 0.02) 100%);
      border: 2px solid var(--color-primary);
      box-shadow: 0 8px 24px rgba(0, 128, 128, 0.15);
    }
    
    .card-phrase {
      grid-column: 1 / 2;
      grid-row: 1 / 2;
    }
    
    .card-progress {
      grid-column: 3 / 4;
      grid-row: 1 / 2;
    }
    
    .card-streak {
      grid-column: 1 / 2;
      grid-row: 2 / 3;
    }
    
    .card-achievements {
      grid-column: 3 / 4;
      grid-row: 2 / 3;
    }
    
    .card-account {
      grid-column: 1 / 2;
      grid-row: 3 / 4;
    }
    
    .card-lessons {
      grid-column: 2 / 3;
      grid-row: 3 / 4;
    }
    
    .card-booking-rules {
    grid-column: 3 / 4;
    grid-row: 3 / 4;
}
    .card-resources {
      grid-column: 3 / 4;
      grid-row: 3 / 4;
    }
    
    .card-upgrade {
      grid-column: 1 / 4;
      grid-row: 4 / 5;
    }
    
    .dashboard-card {
      background-color: var(--color-card-bg);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      padding: 1rem;
      transition: box-shadow var(--transition-speed) ease;
    }
    .dashboard-card:hover {
      box-shadow: var(--shadow);
    }
    .dashboard-card h3 {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.05rem;
      color: var(--color-accent);
      margin: 0 0 0.75rem 0;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--color-border);
    }
    .dashboard-card h3 i {
      color: var(--color-primary);
      font-size: 1rem;
    }
    
    /* Skills Chart */
    .skills-chart-container {
      position: relative;
      height: 420px;
      margin: 0;
      padding: 0.5rem 0 0.25rem 0;
    }
    .no-assessment-message {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--color-text-light);
    }
    .no-assessment-message i {
      font-size: 2.5rem;
      color: var(--color-primary);
      opacity: 0.5;
      margin-bottom: 0.5rem;
    }
    .no-assessment-message p {
      margin: 0.25rem 0;
      line-height: 1.4;
      font-size: 0.9rem;
    }
    .no-assessment-message p:first-of-type {
      font-weight: 600;
      font-size: 1rem;
    }
    .assessment-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0;
      padding-top: 0.5rem;
      border-top: 1px solid var(--color-border);
      font-size: 0.85rem;
      color: var(--color-text-light);
    }
    .assessment-date {
      font-style: italic;
      font-size: 0.8rem;
    }
    .assessment-band {
      font-weight: 700;
      color: var(--color-primary);
      font-size: 0.95rem;
    }
    
    /* Learning Archetype Display */
    .learning-archetype {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-top: 0.75rem;
      padding: 0.75rem 1rem;
      background: linear-gradient(135deg, var(--color-primary-light) 0%, rgba(0, 128, 128, 0.05) 100%);
      border-left: 4px solid var(--color-primary);
      border-radius: 0 8px 8px 0;
    }
    .archetype-icon {
      font-size: 2rem;
      line-height: 1;
      flex-shrink: 0;
    }
    .archetype-content {
      flex: 1;
    }
    .archetype-name {
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--color-primary-dark);
      margin-bottom: 0.25rem;
    }
    .archetype-description {
      font-size: 0.85rem;
      color: var(--color-text);
      line-height: 1.4;
    }
    
    .progress-ring-container {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 1rem;
    }
    .progress-ring {
      position: relative;
      width: 80px;
      height: 80px;
    }
    .progress-ring svg {
      transform: rotate(-90deg);
    }
    .progress-ring-bg {
      fill: none;
      stroke: var(--color-border);
      stroke-width: 8;
    }
    .progress-ring-fill {
      fill: none;
      stroke: var(--color-primary);
      stroke-width: 8;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.5s ease;
    }
    .progress-ring-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--color-text);
    }
    .progress-details h4 {
      margin: 0 0 0.25rem 0;
      color: var(--color-text);
    }
    .progress-details p {
      margin: 0;
      color: var(--color-text-light);
      font-size: 0.9rem;
    }
    
    .streak-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
    }
    .streak-fire {
      font-size: 1.5rem;
    }
    .streak-count {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--color-text);
    }
    .streak-label {
      color: var(--color-text-light);
      font-size: 0.75rem;
    }
    .streak-calendar-container,
    #ja-streak-calendar,
    #en-streak-calendar {
      width: 100%;
      display: block;
    }
    .streak-calendar {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 2px;
      width: 100%;
      transition: max-height 0.3s ease;
      overflow-y: hidden;
      overflow-x: visible;
    }
    .streak-day-header {
      text-align: center;
      font-size: 0.55rem;
      color: var(--color-text-muted);
      padding: 1px;
      font-weight: 600;
      min-width: 0;
    }
    .streak-day {
      aspect-ratio: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: var(--color-bg);
      border-radius: 3px;
      font-size: 0.6rem;
      color: var(--color-text-light);
      min-width: 0;
      overflow: hidden;
    }
    .streak-day.active {
      background-color: var(--color-primary);
      color: white;
    }
    .streak-day.streak-hot {
      background-color: #E67E22;
      color: white;
      font-weight: 600;
    }
    .streak-day.streak-fire {
      background-color: #E74C3C;
      color: white;
      font-weight: 700;
      box-shadow: 0 0 8px rgba(231, 76, 60, 0.4);
    }
    .streak-day.today {
      border: 2px solid var(--color-gold);
    }
    .streak-day.future {
      opacity: 0.4;
    }
    
    .no-lessons {
      text-align: center;
      padding: 1.5rem;
      color: var(--color-text-light);
    }
    .no-lessons i {
      font-size: 1.75rem;
      margin-bottom: 0.4rem;
      opacity: 0.5;
    }
    .no-lessons p {
      margin: 0.5rem 0;
      font-size: 0.9rem;
    }
    
    .resource-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem;
      border-radius: 8px;
      transition: background-color var(--transition-speed) ease;
    }
    .resource-item:hover {
      background-color: var(--color-bg);
    }
    .resource-item i {
      font-size: 1.1rem;
      color: var(--color-primary);
      width: 25px;
      text-align: center;
    }
    .resource-item a {
      flex: 1;
      color: var(--color-text);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.9rem;
    }
    .resource-item a:hover {
      color: var(--color-primary);
    }
    .resource-item .coming-soon {
      color: var(--color-text-muted);
      font-style: italic;
      cursor: default;
    }
    .resource-item .coming-soon:hover {
      color: var(--color-text-muted);
    }
    .resource-tag {
      font-size: 0.65rem;
      padding: 0.15rem 0.4rem;
      background-color: var(--color-primary-light);
      color: var(--color-primary-dark);
      border-radius: 4px;
      text-transform: uppercase;
    }
    .resource-tag.coming {
      background-color: var(--color-bg);
      color: var(--color-text-muted);
    }
    
    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }
    .achievement {
      text-align: center;
      padding: 0.4rem;
    }
    .achievement-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 0.3rem;
      font-size: 1rem;
    }
    .achievement-icon.earned {
      background-color: var(--color-gold);
      color: white;
    }
    .achievement-icon.locked {
      background-color: var(--color-bg);
      color: var(--color-text-muted);
      opacity: 0.5;
    }
    .achievement-name {
      font-size: 0.7rem;
      color: var(--color-text-light);
      line-height: 1.1;
      min-height: 2em;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .achievement.locked .achievement-name {
      opacity: 0.5;
    }
    
    .plan-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      background-color: var(--color-primary);
      color: white;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
    }
    .plan-badge.pending {
      background-color: var(--color-gold);
    }
    .plan-badge.has-addon {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-gold) 100%);
    }
    /* Cancellation Status Banner */
.cancellation-banner {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border: 2px solid #ffc107;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.cancellation-banner.expired {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    border-color: #dc3545;
}

.cancellation-banner-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.cancellation-banner-icon {
    font-size: 2.5rem;
}

.cancellation-banner-content h3 {
    margin: 0 0 0.5rem 0;
    color: #856404;
    font-size: 1.3rem;
}

.cancellation-banner.expired .cancellation-banner-content h3 {
    color: #721c24;
}

.cancellation-banner-content p {
    margin: 0.25rem 0;
    color: #856404;
    font-size: 0.95rem;
}

.cancellation-banner.expired .cancellation-banner-content p {
    color: #721c24;
}

.countdown-timer {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255, 255, 255, 0.8);
    padding: 0.5rem 1rem;
    border-radius: 8px;
    margin-top: 0.75rem;
    font-weight: 600;
    color: #856404;
}

.cancellation-banner.expired .countdown-timer {
    color: #721c24;
}

.countdown-number {
    font-size: 1.5rem;
    font-weight: 700;
    color: #ffc107;
}

.cancellation-banner.expired .countdown-number {
    color: #dc3545;
}

.cancellation-banner-actions {
    margin-top: 1.5rem;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.btn-reactivate {
    background: var(--color-primary);
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
}

.btn-reactivate:hover {
    background: var(--color-primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 128, 128, 0.3);
}

.btn-contact-support {
    background: white;
    color: var(--color-text);
    padding: 0.75rem 1.5rem;
    border: 2px solid var(--color-border);
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
}

.btn-contact-support:hover {
    border-color: var(--color-text-light);
    background: var(--color-bg);
}

/* Status badge updates */
.plan-badge.cancelled {
    background: var(--color-primary);  /* Teal instead of yellow */
    color: white;
}

.plan-badge.expired {
    background: #dc3545;
    color: white;
}

@media (max-width: 768px) {
    .cancellation-banner-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .cancellation-banner-icon {
        font-size: 2rem;
    }
    
    .cancellation-banner-actions {
        flex-direction: column;
    }
    
    .btn-reactivate,
    .btn-contact-support {
        width: 100%;
        justify-content: center;
    }
}
    .addon-badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      background-color: var(--color-gold);
      color: white;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: 0.4rem;
    }
    .account-details {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .account-details li {
      padding: 0.4rem 0;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
    }
    .account-details li:last-child {
      border-bottom: none;
    }
    .account-details strong {
      color: var(--color-text-light);
      font-weight: 500;
    }
    
    .upgrade-card {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: white;
      text-align: center;
    }
    .upgrade-card h3 {
      color: white;
      border-bottom-color: rgba(255,255,255,0.3);
    }
    .upgrade-card h3 i {
      color: white;
    }
    .upgrade-card p {
      margin-bottom: 1rem;
      opacity: 0.95;
    }
    .upgrade-card .cta-button {
      background: white;
      color: var(--color-primary);
    }
    .upgrade-card .cta-button:hover {
      background: #f0f0f0;
      transform: translateY(-2px);
    }
    
    .tip-box {
      background-color: var(--color-primary-light);
      border-left: 4px solid var(--color-primary);
      padding: 0.75rem;
      border-radius: 0 8px 8px 0;
    }
    .tip-box p {
      margin: 0;
      font-size: 0.9rem;
    }
    .tip-box .tip-phrase {
      font-size: 1rem;
      font-weight: 600;
      color: var(--color-primary-dark);
      display: block;
      margin-top: 0.4rem;
    }
    
    @media (max-width: 1024px) {
      .dashboard-grid {
        grid-template-columns: 1fr 1fr;
      }
      .card-lessons {
    grid-column: 1 / 3;
    grid-row: 5 / 6;
}

.card-booking-rules {
    grid-column: 1 / 3;
    grid-row: 6 / 7;
}
      .card-skills {
        grid-column: 1 / 3;
        grid-row: 1 / 2;
      }
      
      .card-phrase {
        grid-column: 1 / 2;
        grid-row: 2 / 3;
      }
      
      .card-progress {
        grid-column: 2 / 3;
        grid-row: 2 / 3;
      }
      
      .card-streak {
        grid-column: 1 / 2;
        grid-row: 3 / 4;
      }
      
      .card-achievements {
        grid-column: 2 / 3;
        grid-row: 3 / 4;
      }
      
      .card-account {
        grid-column: 1 / 3;
        grid-row: 4 / 5;
      }
      
      .card-lessons {
        grid-column: 1 / 3;
        grid-row: 5 / 6;
      }
      
      .card-resources {
        grid-column: 1 / 3;
        grid-row: 6 / 7;
      }
      
      .card-upgrade {
        grid-column: 1 / 3;
      }
    }
    
    @media (max-width: 768px) {
      .welcome-banner {
        flex-direction: column;
        text-align: center;
        padding: 1.25rem 1.5rem;
      }
      .card-booking-rules {
    grid-column: 1;
    grid-row: auto;
}
      .welcome-banner h1 {
        font-size: 1.4rem;
        margin-bottom: 0.25rem;
      }
      .welcome-banner p {
        font-size: 0.9rem;
        margin-bottom: 0.75rem;
      }
      .welcome-stats {
        justify-content: center;
        gap: 1.5rem;
      }
      .welcome-stat-value {
        font-size: 1.5rem;
      }
      .welcome-stat-label {
        font-size: 0.75rem;
      }
      .quick-actions {
        grid-template-columns: repeat(2, 1fr);
      }
      .dashboard-grid {
        grid-template-columns: 1fr;
        padding-bottom: 1.5rem;
      }
      
      .card-skills,
      .card-phrase,
      .card-progress,
      .card-streak,
      .card-achievements,
      .card-account,
      .card-lessons,
      .card-resources,
      .card-upgrade {
        grid-column: 1;
        grid-row: auto;
      }
      
      .skills-chart-container {
        height: 300px;
      }
      
      #ja-dashboard-content,
      #en-dashboard-content {
        padding-bottom: 1.5rem;
      }
    }
    
    @media (prefers-color-scheme: dark) {
      .tip-box {
        background-color: var(--color-card-bg);
      }
      .resource-tag {
        background-color: var(--color-primary-dark);
        color: var(--color-primary-light);
      }
      .practice-status-card {
        background: linear-gradient(135deg, #1e7e34 0%, #155724 100%);
      }
      .practice-status-card.completed {
        background: linear-gradient(135deg, #b8860b 0%, #8b6914 100%);
      }
      .learning-archetype {
        background: linear-gradient(135deg, var(--color-card-bg) 0%, rgba(0, 168, 168, 0.1) 100%);
        border-left-color: var(--color-primary);
      }
      .archetype-name {
        color: var(--color-primary);
      }
      .archetype-description {
        color: var(--color-text-light);
      }
    }
    
    /* BOOKING MODAL STYLES */
/* Modal Overlay */
.booking-modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 9998;
  animation: fadeIn 0.2s ease;
}

.booking-modal-overlay.show {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.booking-modal {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 90%;
  max-width: 900px;
  max-height: 90vh;
  background: var(--color-card-bg);
  border-radius: var(--border-radius);
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  z-index: 9999;
  overflow: hidden;
  animation: slideUp 0.3s ease;
}

.booking-modal.show {
  display: flex;
  flex-direction: column;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translate(-50%, -40%);
  }
  to {
    opacity: 1;
    transform: translate(-50%, -50%);
  }
}

.booking-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.5rem;
  border-bottom: 2px solid var(--color-border);
  background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
  color: white;
}

.booking-modal-header h2 {
  margin: 0;
  font-size: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.booking-modal-close {
  background: none;
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0.5rem;
  line-height: 1;
  transition: transform 0.2s;
}

.booking-modal-close:hover {
  transform: scale(1.2);
}

.booking-modal-body {
  padding: 1.5rem;
  overflow-y: auto;
  flex: 1;
}

.booking-widget {
  background: transparent;
  border: none;
  padding: 0;
  margin: 0;
  box-shadow: none;
}

.booking-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid var(--color-border);
}

.booking-header h2 {
  margin: 0;
  color: var(--color-primary);
  font-size: 1.2rem;
  display: none;
}

.booking-credits {
  display: flex;
  gap: 1.5rem;
  align-items: center;
  width: 100%;
  justify-content: center;
}

.credit-badge {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: var(--color-primary-light);
  border-radius: 20px;
  font-weight: 600;
  color: var(--color-primary-dark);
}

.credit-badge i {
  font-size: 1.1rem;
}

.credit-number {
  font-size: 1.2rem;
  color: var(--color-primary);
}

.consultation-badge {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: var(--color-gold);
  border-radius: 20px;
  font-weight: 600;
  color: white;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

.calendar-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  margin-top: 1rem;
}

.calendar-picker {
  display: flex;
  flex-direction: column;
}

.calendar-month-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.calendar-month-nav h3 {
  margin: 0;
  font-size: 1.1rem;
  color: var(--color-text);
}

.calendar-nav-btn {
  background: var(--color-primary);
  color: white;
  border: none;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.calendar-nav-btn:hover {
  background: var(--color-primary-dark);
  transform: scale(1.1);
}

.calendar-nav-btn:disabled {
  background: var(--color-border);
  cursor: not-allowed;
  transform: none;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
}

.calendar-day-header {
  text-align: center;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--color-text-muted);
  padding: 0.5rem 0;
}

.calendar-day {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
}

.calendar-day:hover:not(.disabled):not(.other-month) {
  background: var(--color-primary-light);
  transform: scale(1.05);
}

.calendar-day.other-month {
  color: var(--color-text-muted);
  opacity: 0.3;
}

.calendar-day.today {
  border-color: var(--color-gold);
  font-weight: 700;
}

.calendar-day.selected {
  background: var(--color-primary);
  color: white;
  font-weight: 700;
}

.calendar-day.disabled {
  color: var(--color-text-muted);
  opacity: 0.3;
  cursor: not-allowed;
}

.calendar-day.has-booking {
  background: var(--color-primary);  /* Changed to teal */
  color: white;
  position: relative;
  font-weight: 700;
}

.calendar-day.has-booking::after {
  content: '•';
  position: absolute;
  top: 2px;  /* Moved to top */
  right: 2px;
  font-size: 0.5rem;  /* Much smaller */
  color: var(--color-gold);  /* Gold dot for contrast */
}

.time-slots-container {
  display: flex;
  flex-direction: column;
}

.selected-date-display {
  font-size: 1rem;
  font-weight: 600;
  color: var(--color-text);
  margin-bottom: 1rem;
  padding: 0.75rem;
  background: var(--color-bg);
  border-radius: 8px;
  text-align: center;
}

.time-slots-loading {
  text-align: center;
  padding: 2rem;
  color: var(--color-text-light);
}

.time-slots-loading i {
  font-size: 2rem;
  color: var(--color-primary);
  margin-bottom: 0.5rem;
}

.time-slots {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.time-period {
  margin-bottom: 0.5rem;
}

.time-period h4 {
  font-size: 0.85rem;
  color: var(--color-text-light);
  margin: 0 0 0.5rem 0;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.time-slots-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
  gap: 0.5rem;
}

.time-slot {
  padding: 0.6rem;
  border: 2px solid var(--color-border);
  border-radius: 8px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  background: white;
  font-weight: 500;
  font-size: 0.9rem;
}

.time-slot:hover {
  border-color: var(--color-primary);
  background: var(--color-primary-light);
  transform: translateY(-2px);
}

.time-slot.selected {
  background: var(--color-primary);
  color: white;
  border-color: var(--color-primary);
}

.time-slot.booked {
  background: var(--color-bg);
  color: var(--color-text-muted);
  border-color: var(--color-border);
  cursor: not-allowed;
  opacity: 0.5;
}

.no-slots-message {
  text-align: center;
  padding: 2rem;
  color: var(--color-text-light);
}

.no-slots-message i {
  font-size: 2rem;
  color: var(--color-border);
  margin-bottom: 0.5rem;
}

.booking-actions {
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--color-border);
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.lesson-type-selector {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.lesson-type-selector label {
  font-weight: 600;
  color: var(--color-text);
  font-size: 0.9rem;
}

.lesson-type-selector select {
  padding: 0.75rem;
  border: 2px solid var(--color-border);
  border-radius: 8px;
  font-size: 1rem;
  background: white;
  cursor: pointer;
}

.booking-summary {
  padding: 1rem;
  background: var(--color-bg);
  border-radius: 8px;
  border-left: 4px solid var(--color-primary);
}

.booking-summary-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.5rem;
  font-size: 0.95rem;
}

.booking-summary-item:last-child {
  margin-bottom: 0;
  padding-top: 0.5rem;
  border-top: 1px solid var(--color-border);
  font-weight: 700;
  font-size: 1.1rem;
}

.booking-summary-label {
  color: var(--color-text-light);
}

.booking-summary-value {
  color: var(--color-text);
  font-weight: 600;
}

.booking-summary-value.free {
  color: var(--color-success);
}

.booking-summary-value.paid {
  color: var(--color-primary);
}

.book-lesson-btn {
  width: 100%;
  padding: 1rem;
  background: var(--color-primary);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
}

.book-lesson-btn:hover:not(:disabled) {
  background: var(--color-primary-dark);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 128, 128, 0.3);
}

.book-lesson-btn:disabled {
  background: var(--color-border);
  cursor: not-allowed;
  transform: none;
}

.book-lesson-btn i {
  margin-right: 0.5rem;
}

.my-bookings {
  margin-top: 2rem;
  padding-top: 2rem;
  border-top: 2px solid var(--color-border);
}

.my-bookings h3 {
  margin: 0 0 1rem 0;
  color: var(--color-accent);
}

.bookings-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.booking-item {
  padding: 1rem;
  background: var(--color-bg);
  border-radius: 8px;
  border-left: 4px solid var(--color-primary);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.booking-info {
  flex: 1;
}

.booking-date {
  font-weight: 700;
  color: var(--color-text);
  margin-bottom: 0.25rem;
}

.booking-time {
  color: var(--color-text-light);
  font-size: 0.9rem;
}

.booking-type {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  background: var(--color-primary-light);
  color: var(--color-primary-dark);
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  margin-top: 0.5rem;
}

.booking-actions-btns {
  display: flex;
  gap: 0.5rem;
}

.booking-action-btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.reschedule-btn {
  background: var(--color-primary);
  color: white;
}

.reschedule-btn:hover {
  background: var(--color-primary-dark);
}

.cancel-btn {
  background: var(--color-error);
  color: white;
}

.cancel-btn:hover {
  background: #c0392b;
}

.no-bookings {
  text-align: center;
  padding: 2rem;
  color: var(--color-text-light);
}

@media (max-width: 768px) {
  .booking-modal {
    width: 95%;
    max-height: 95vh;
  }
  
  .calendar-container {
    grid-template-columns: 1fr;
  }
  
  .booking-credits {
    flex-direction: column;
    gap: 0.5rem;
    align-items: flex-start;
  }
  
  .time-slots-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (prefers-color-scheme: dark) {
  .booking-modal {
    background: var(--color-card-bg);
  }
  
  .time-slot {
    background: var(--color-card-bg);
  }
  
  .lesson-type-selector select {
    background: var(--color-card-bg);
    color: var(--color-text);
  }
}

/* ================================
   ENHANCED UPCOMING LESSONS CARD - TEAL STYLING
   ================================ */

.lessons-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.lesson-item {
    background: #f8f9fa;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 1.25rem;
    transition: all 0.3s ease;
}

/* Next lesson uses TEAL gradient instead of purple */
.lesson-item.lesson-next {
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
    color: white;
    border: none;
    box-shadow: 0 4px 12px rgba(0, 128, 128, 0.3);
}

.lesson-item.lesson-next .lesson-info {
    color: white;
}

.lesson-item.lesson-next .lesson-datetime i,
.lesson-item.lesson-next .lesson-countdown i {
    color: rgba(255, 255, 255, 0.8);
}

.lesson-info {
    margin-bottom: 1rem;
}

.lesson-datetime {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.lesson-countdown {
    font-size: 0.9rem;
    opacity: 0.8;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.lesson-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

/* Meet link status indicator */
.meet-link-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 12px 20px;
    background: rgba(0, 128, 128, 0.1);
    border: 1px solid rgba(0, 128, 128, 0.3);
    border-radius: 8px;
    font-size: 14px;
    color: var(--color-primary-dark);
}

.meet-link-status i {
    animation: spin 1s linear infinite;
}

/* Google Meet Button */
.google-meet-btn {
    background: white;
    border: 1px solid #dadce0;
    border-radius: 8px;
    padding: 12px 20px;
    font-size: 15px;
    font-weight: 500;
    color: #3c4043;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    width: 100%;
}

.google-meet-btn:hover {
    background: #f8f9fa;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    transform: translateY(-1px);
}

.google-meet-btn:active {
    transform: translateY(0);
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.google-meet-btn svg {
    width: 20px;
    height: 20px;
    flex-shrink: 0;
}

/* Pulse animation for Join button when lesson is within 1 hour */
.google-meet-btn.pulse {
    animation: pulse 2s infinite;
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    border: none;
    font-weight: 600;
}

@keyframes pulse {
    0%, 100% {
        box-shadow: 0 2px 6px rgba(76, 175, 80, 0.4);
    }
    50% {
        box-shadow: 0 4px 16px rgba(76, 175, 80, 0.6);
    }
}

.google-meet-btn.pulse svg {
    filter: brightness(0) invert(1);
}

/* Secondary actions (Reschedule, Cancel) */
.lesson-secondary-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.lesson-action-btn {
    flex: 1;
    min-width: 120px;
    padding: 8px 16px;
    border: 1px solid #dadce0;
    border-radius: 6px;
    background: white;
    color: #5f6368;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
}

.lesson-action-btn:hover {
    background: #f1f3f4;
    border-color: #c4c7c9;
}

.reschedule-btn {
    color: var(--color-primary);
    border-color: var(--color-primary);
}

.reschedule-btn:hover {
    background: var(--color-primary-light);
    border-color: var(--color-primary);
}

.cancel-btn {
    color: #d93025;
    border-color: #d93025;
}

.cancel-btn:hover {
    background: #fce8e6;
    border-color: #d93025;
}

/* Expanded lessons section */
.lessons-more {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
}

.lessons-more.expanded {
    max-height: 2000px;
}

.lessons-more .lesson-item {
    margin-top: 1rem;
}

/* Toggle button */
.toggle-lessons-btn {
    width: 100%;
    padding: 10px;
    background: white;
    border: 1px solid #dadce0;
    border-radius: 6px;
    color: #5f6368;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.toggle-lessons-btn:hover {
    background: #f8f9fa;
    border-color: #c4c7c9;
}

/* Divider before book another */
.book-another-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, #dadce0, transparent);
    margin: 0.5rem 0;
}

/* Book another button - TEAL gradient instead of purple */
.book-another-btn {
    width: 100%;
    padding: 12px 20px;
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 2px 6px rgba(0, 128, 128, 0.3);
}

.book-another-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 128, 128, 0.4);
}

.book-another-btn:active {
    transform: translateY(0);
}

/* Mobile responsive */
@media (max-width: 768px) {
    .lesson-item {
        padding: 1rem;
    }
    
    .lesson-secondary-actions {
        flex-direction: column;
    }
    
    .lesson-action-btn {
        width: 100%;
        min-width: 100%;
    }
    
    .google-meet-btn {
        font-size: 14px;
        padding: 10px 16px;
    }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .lesson-item {
        background: #2d2d2d;
        border-color: #404040;
    }
    
    .lesson-item:not(.lesson-next) .lesson-datetime,
    .lesson-item:not(.lesson-next) .lesson-countdown {
        color: #e0e0e0;
    }
    
    .google-meet-btn,
    .lesson-action-btn,
    .toggle-lessons-btn {
        background: #2d2d2d;
        border-color: #404040;
        color: #e0e0e0;
    }
    
    .google-meet-btn:hover,
    .lesson-action-btn:hover,
    .toggle-lessons-btn:hover {
        background: #353535;
    }
    
    .meet-link-status {
        background: rgba(0, 168, 168, 0.15);
        border-color: rgba(0, 168, 168, 0.4);
        color: var(--color-primary);
    }
}
    /* ================================
   LESSON STATUS BANNERS - ADD THIS BEFORE
   ================================ */
.lesson-status-banner {
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.lesson-status-banner.in-progress {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
}

.lesson-status-banner.in-progress i {
    animation: pulse-dot 1.5s infinite;
}

@keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}

.lesson-status-banner.recently-ended {
    background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    color: white;
}

.lesson-status-banner.locked {
    background: rgba(0, 0, 0, 0.05);
    color: var(--color-text-muted);
    border: 1px solid var(--color-border);
}

@media (prefers-color-scheme: dark) {
    .lesson-status-banner.locked {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
    }
}

/* Booking policy notice in modal */
.booking-policy-notice {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border-left: 4px solid #2196F3;
    padding: 0.5rem 0.75rem;  /* ← Even smaller padding */
    border-radius: 0 8px 8px 0;
    margin-bottom: 0.75rem;  /* ← Reduced */
    display: flex;
    gap: 0.5rem;  /* ← Smaller gap */
    align-items: flex-start;
}

.booking-policy-notice i {
    color: #2196F3;
    font-size: 1rem;  /* ← Smaller icon */
    flex-shrink: 0;
    margin-top: 1px;
}

.booking-policy-notice strong {
    color: #1976D2;
    font-size: 0.85rem;  /* ← Smaller heading */
}

.booking-policy-notice ul {
    margin: 0.25rem 0 0 0;
    padding-left: 1rem;  /* ← Less indent */
    font-size: 0.8rem;  /* ← Smaller text */
    line-height: 1.4;  /* ← Tighter spacing */
}

.booking-policy-notice li {
    margin-bottom: 0.1rem;  /* ← Minimal spacing */
}

/* Rules card styles */
.rules-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.rule-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.5rem;
    background: var(--color-bg);
    border-radius: 6px;
    font-size: 0.9rem;
    line-height: 1.5;
}

.rule-item i {
    font-size: 1.1rem;
    margin-top: 2px;
    flex-shrink: 0;
}

@media (prefers-color-scheme: dark) {
    .booking-policy-notice {
        background: linear-gradient(135deg, rgba(33, 150, 243, 0.15) 0%, rgba(33, 150, 243, 0.08) 100%);
        border-left-color: #42A5F5;
    }
    
    .booking-policy-notice i {
        color: #42A5F5;
    }
    
    .booking-policy-notice strong {
        color: #64B5F6;
    }
}
  </style>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <a href="index.html"><img src="assets/images/prokaiwa-logo.jpg" alt="Prokaiwa Logo" class="logo" /></a>
            <button class="burger-menu" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><a href="#" id="logout-button-nav" class="logout-button">Log Out</a></li>
                    <li>
                        <div class="nav-lang-toggle">
                            <button data-lang="ja" aria-label="日本語に切り替え">日本語</button>
                            <button data-lang="en" aria-label="Switch to English">English</button>
                        </div>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <!-- BOOKING MODAL OVERLAY -->
        <div class="booking-modal-overlay" id="booking-modal-overlay" onclick="closeBookingModal()"></div>
        
        <!-- BOOKING MODAL -->
        <div class="booking-modal" id="booking-modal">
            <div class="booking-modal-header">
                <h2><i class="fas fa-calendar-alt"></i> <span id="modal-title">レッスン予約</span></h2>
                <button class="booking-modal-close" onclick="closeBookingModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="booking-modal-body">
                <!-- Booking widget content will be inserted here -->
                <div id="modal-booking-content"></div>
            </div>
        </div>

        <!-- JAPANESE VERSION -->
        <section id="ja-dashboard" class="lang-section" lang="ja">
            <div class="container legal-page-container">
                <!-- Loading State -->
                <div id="ja-dashboard-loading" class="dashboard-loading">
                    <i class="fas fa-spinner"></i>
                    <p>読み込み中...</p>
                </div>

                <!-- Error State -->
                <div id="ja-dashboard-error" class="dashboard-error" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i>
                    <h2>エラーが発生しました</h2>
                    <p id="ja-error-message">ページを読み込めませんでした。</p>
                    <button onclick="location.reload()" class="cta-button">再読み込み</button>
                    <a href="login.html" class="cta-button cta-secondary" style="margin-left: 1rem;">ログインページへ</a>
                </div>

                <!-- Dashboard Content -->
                <div id="ja-dashboard-content" style="display: none;">
                    
                    <!-- Welcome Banner -->
                    <div class="welcome-banner">
                        <div>
                            <h1 id="ja-welcome-name">おかえりなさい！</h1>
                            <p>今日も英語学習、頑張りましょう！</p>
                        </div>
                        <div class="welcome-stats">
                            <div class="welcome-stat">
                                <span class="welcome-stat-value" id="ja-stat-streak">0</span>
                                <span class="welcome-stat-label">日連続</span>
                            </div>
                            <div class="welcome-stat">
                                <span class="welcome-stat-value" id="ja-stat-total">0</span>
                                <span class="welcome-stat-label">練習回数</span>
                            </div>
                            <div class="welcome-stat">
                                <span class="welcome-stat-value" id="ja-stat-month">0</span>
                                <span class="welcome-stat-label">今月</span>
                            </div>
                        </div>
                    </div>

                    <!-- Practice Status Card -->
                    <div class="practice-status-card" id="ja-practice-status">
                        <div class="practice-status-icon">⏳</div>
                        <h2>今日の練習状況を確認中...</h2>
                        <p>データを読み込んでいます</p>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <a href="https://line.me/R/ti/p/@845irjbc" target="_blank" class="quick-action-btn">
                            <i class="fab fa-line"></i>
                            <span>LINEで練習</span>
                        </a>
                        <button class="quick-action-btn" id="ja-book-lesson-btn" onclick="openBookingModal('ja')">
                            <i class="fas fa-video"></i>
                            <span>レッスン予約</span>
                        </button>
                        <a href="#ja-resources" class="quick-action-btn">
                            <i class="fas fa-book"></i>
                            <span>学習教材</span>
                        </a>
                        <a href="contact.html" class="quick-action-btn">
                            <i class="fas fa-envelope"></i>
                            <span>お問い合わせ</span>
                        </a>
                    </div>

                    <!-- Dashboard Grid -->
                    <div class="dashboard-grid">

                      <!-- Cancellation Status Banner (Japanese) -->
<div class="cancellation-banner" id="ja-cancellation-banner" style="display: none;">
    <div class="cancellation-banner-header">
        <div class="cancellation-banner-icon">⚠️</div>
        <div class="cancellation-banner-content">
            <h3 id="ja-cancellation-title">サブスクリプションがキャンセルされました</h3>
            <p id="ja-cancellation-message">アクセスは継続されます</p>
            <div class="countdown-timer" id="ja-countdown-timer">
                <i class="fas fa-clock"></i>
                <span>残り <span class="countdown-number" id="ja-days-remaining">0</span> 日</span>
            </div>
        </div>
    </div>
    <div class="cancellation-banner-actions">
        <a href="questionnaire.html" class="btn-reactivate">
            <i class="fas fa-redo"></i> サブスクリプションを再開
        </a>
        <a href="contact.html?subject=reactivation" class="btn-contact-support">
            <i class="fas fa-envelope"></i> サポートに連絡
        </a>
    </div>
</div>
                      
                        <!-- Skills Assessment Card -->
                        <div class="dashboard-card card-skills">
                            <h3><i class="fas fa-chart-radar"></i>スキル評価</h3>
                            <div id="ja-skills-assessment">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Today's Tip -->
                        <div class="dashboard-card card-phrase">
                            <h3><i class="fas fa-lightbulb"></i>今日のフレーズ</h3>
                            <div class="tip-box">
                                <p>今日はこのフレーズを使ってみましょう：</p>
                                <span class="tip-phrase" id="ja-daily-phrase">"I'm looking forward to..."</span>
                                <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--color-text-light);" id="ja-phrase-example">
                                    例：I'm looking forward to our next lesson!<br>
                                    （次のレッスンが楽しみです！）
                                </p>
                            </div>
                        </div>

                        <!-- Progress -->
                        <div class="dashboard-card card-progress">
                            <h3><i class="fas fa-chart-line"></i>今月の進捗</h3>
                            <div class="progress-ring-container">
                                <div class="progress-ring">
                                    <svg width="80" height="80">
                                        <circle class="progress-ring-bg" cx="40" cy="40" r="32"></circle>
                                        <circle class="progress-ring-fill" cx="40" cy="40" r="32" 
                                                stroke-dasharray="201" 
                                                id="ja-progress-ring"></circle>
                                    </svg>
                                    <span class="progress-ring-text" id="ja-progress-percent">0%</span>
                                </div>
                                <div class="progress-details">
                                    <h4 id="ja-progress-message">頑張りましょう！</h4>
                                    <p id="ja-progress-sub">今月の目標に向かって</p>
                                </div>
                            </div>
                            <p style="font-size: 0.9rem; color: var(--color-text-light);">
                                <i class="fas fa-check-circle" style="color: var(--color-primary);"></i>
                                今月 <strong id="ja-sessions-completed">0</strong> / <span id="ja-sessions-total">20</span> 回完了
                            </p>
                        </div>

                        <!-- Streak -->
                        <div class="dashboard-card card-streak">
                            <h3><i class="fas fa-fire"></i>練習継続記録</h3>
                            <div class="streak-header">
                                <span class="streak-fire" id="ja-streak-emoji">🔥</span>
                                <div>
                                    <span class="streak-count" id="ja-streak-count">0</span>
                                    <span class="streak-label">日連続！</span>
                                </div>
                            </div>
                            <div class="streak-calendar" id="ja-streak-calendar">
                                <!-- Calendar will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Achievements -->
                        <div class="dashboard-card card-achievements">
                            <h3><i class="fas fa-trophy"></i>達成バッジ</h3>
                            <div class="achievements-grid" id="ja-achievements">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Account Info -->
<div class="dashboard-card card-account">
    <h3><i class="fas fa-user-circle"></i>アカウント情報</h3>
    <div id="ja-plan-badges">
        <span class="plan-badge" id="ja-plan-badge">プランA</span>
    </div>
    <ul class="account-details">
        <li><strong>氏名</strong><span id="ja-profile-name">-</span></li>
        <li><strong>メール</strong><span id="ja-profile-email">-</span></li>
        <li><strong>レベル</strong><span id="ja-profile-level">-</span></li>
        <li><strong>ステータス</strong><span id="ja-profile-status">-</span></li>
    </ul>
    <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <a href="account-settings.html" class="cta-button cta-secondary" style="font-size: 0.85rem; padding: 0.5rem 1rem;">
            <i class="fas fa-cog"></i> 設定
        </a>
        <a href="contact.html?subject=plan-change" class="cta-button cta-secondary" style="font-size: 0.85rem; padding: 0.5rem 1rem;">プラン変更</a>
        <button id="ja-logout-btn" class="cta-button cta-secondary" style="font-size: 0.85rem; padding: 0.5rem 1rem;">ログアウト</button>
    </div>
</div>
                        <!-- Upcoming Lessons -->
<div class="dashboard-card card-lessons" id="ja-upcoming-lessons-card" style="display: none;">
    <h3><i class="fas fa-calendar-alt"></i>予定レッスン</h3>
    <div id="ja-upcoming-lessons">
        <!-- Will be populated by JavaScript -->
    </div>
</div>

<!-- 🆕 BOOKING RULES CARD -->
<div class="dashboard-card card-booking-rules">
    <h3><i class="fas fa-book-open"></i>予約ルール</h3>
    <div class="rules-list">
        <div class="rule-item">
            <i class="fas fa-check-circle" style="color: #4CAF50;"></i>
            <span><strong>無料で変更OK：</strong>レッスン24時間前までならキャンセル・変更無料</span>
        </div>
        <div class="rule-item">
            <i class="fas fa-times-circle" style="color: #f44336;"></i>
            <span><strong>返金なし：</strong>24時間前を切るとクレジット返金不可</span>
        </div>
        <div class="rule-item">
            <i class="fas fa-user-slash" style="color: #ff9800;"></i>
            <span><strong>無断欠席：</strong>連絡なしで欠席した場合もクレジット消費</span>
        </div>
        <div class="rule-item">
            <i class="fas fa-video" style="color: #2196F3;"></i>
            <span><strong>Meetリンク：</strong>レッスン24時間前から終了1時間後まで表示</span>
        </div>
    </div>
</div>
                        <!-- Learning Resources -->
                        <div class="dashboard-card card-resources" id="ja-resources">
                            <h3><i class="fas fa-folder-open"></i>学習教材</h3>
                            <div class="resource-item">
                                <i class="fas fa-file-pdf"></i>
                                <a href="#" class="coming-soon">日常会話フレーズ集</a>
                                <span class="resource-tag coming">準備中</span>
                            </div>
                            <div class="resource-item">
                                <i class="fas fa-file-pdf"></i>
                                <a href="#" class="coming-soon">ビジネス英語基礎</a>
                                <span class="resource-tag coming">準備中</span>
                            </div>
                            <div class="resource-item">
                                <i class="fas fa-link"></i>
                                <a href="#" class="coming-soon">おすすめYouTubeチャンネル</a>
                                <span class="resource-tag coming">準備中</span>
                            </div>
                            <div class="resource-item">
                                <i class="fas fa-headphones"></i>
                                <a href="#" class="coming-soon">リスニング練習音声</a>
                                <span class="resource-tag coming">準備中</span>
                            </div>
                            <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--color-text-muted); text-align: center;">
                                <i class="fas fa-info-circle"></i> 教材は順次追加予定です
                            </p>
                        </div>

                        <!-- Upgrade Card -->
                        <div class="dashboard-card upgrade-card card-upgrade" id="ja-upgrade-card" style="display: none;">
                            <h3><i class="fas fa-star"></i>ビデオレッスンを追加</h3>
                            <p>講師と直接話して、さらに上達しませんか？</p>
                            <a href="https://buy.stripe.com/28E9AS4UrcIP8JK7wbes002" target="_blank" class="cta-button">
                                カジュアルレッスン ¥3,000
                            </a>
                            <p style="margin-top: 0.75rem; font-size: 0.85rem; opacity: 0.9;">
                                <a href="https://buy.stripe.com/28E14mev16kr4tu5o3es003" target="_blank" style="color: white; text-decoration: underline;">
                                    ビジネスレッスン ¥5,000
                                </a>
                            </p>
                        </div>

                    </div>
                </div>
            </div>
        </section>

        <!-- ENGLISH VERSION -->
        <section id="en-dashboard" class="lang-section" lang="en">
            <div class="container legal-page-container">
                <!-- Loading State -->
                <div id="en-dashboard-loading" class="dashboard-loading">
                    <i class="fas fa-spinner"></i>
                    <p>Loading your dashboard...</p>
                </div>

                <!-- Error State -->
                <div id="en-dashboard-error" class="dashboard-error" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i>
                    <h2>Something went wrong</h2>
                    <p id="en-error-message">Could not load the page.</p>
                    <button onclick="location.reload()" class="cta-button">Refresh</button>
                    <a href="login.html" class="cta-button cta-secondary" style="margin-left: 1rem;">Go to Login</a>
                </div>

                <!-- Dashboard Content -->
                <div id="en-dashboard-content" style="display: none;">
                    
                    <!-- Welcome Banner -->
                    <div class="welcome-banner">
                        <div>
                            <h1 id="en-welcome-name">Welcome back!</h1>
                            <p>Let's continue your English learning journey!</p>
                        </div>
                        <div class="welcome-stats">
                            <div class="welcome-stat">
                                <span class="welcome-stat-value" id="en-stat-streak">0</span>
                                <span class="welcome-stat-label">Day Streak</span>
                            </div>
                            <div class="welcome-stat">
                                <span class="welcome-stat-value" id="en-stat-total">0</span>
                                <span class="welcome-stat-label">Total Sessions</span>
                            </div>
                            <div class="welcome-stat">
                                <span class="welcome-stat-value" id="en-stat-month">0</span>
                                <span class="welcome-stat-label">This Month</span>
                            </div>
                        </div>
                    </div>

                    <!-- Practice Status Card -->
                    <div class="practice-status-card" id="en-practice-status">
                        <div class="practice-status-icon">⏳</div>
                        <h2>Checking today's practice...</h2>
                        <p>Loading data</p>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <a href="https://line.me/R/ti/p/@845irjbc" target="_blank" class="quick-action-btn">
                            <i class="fab fa-line"></i>
                            <span>Practice on LINE</span>
                        </a>
                        <button class="quick-action-btn" id="en-book-lesson-btn" onclick="openBookingModal('en')">
                            <i class="fas fa-video"></i>
                            <span>Book Lesson</span>
                        </button>
                        <a href="#en-resources" class="quick-action-btn">
                            <i class="fas fa-book"></i>
                            <span>Resources</span>
                        </a>
                        <a href="contact.html" class="quick-action-btn">
                            <i class="fas fa-envelope"></i>
                            <span>Contact Us</span>
                        </a>
                    </div>

                    <!-- Dashboard Grid -->
                    <div class="dashboard-grid">
<!-- Cancellation Status Banner (English) -->
<div class="cancellation-banner" id="en-cancellation-banner" style="display: none;">
    <div class="cancellation-banner-header">
        <div class="cancellation-banner-icon">⚠️</div>
        <div class="cancellation-banner-content">
            <h3 id="en-cancellation-title">Subscription Cancelled</h3>
            <p id="en-cancellation-message">Your access continues</p>
            <div class="countdown-timer" id="en-countdown-timer">
                <i class="fas fa-clock"></i>
                <span><span class="countdown-number" id="en-days-remaining">0</span> days remaining</span>
            </div>
        </div>
    </div>
    <div class="cancellation-banner-actions">
        <a href="questionnaire.html" class="btn-reactivate">
            <i class="fas fa-redo"></i> Reactivate Subscription
        </a>
        <a href="contact.html?subject=reactivation" class="btn-contact-support">
            <i class="fas fa-envelope"></i> Contact Support
        </a>
    </div>
</div>
                      
                        <!-- Skills Assessment Card -->
                        <div class="dashboard-card card-skills">
                            <h3><i class="fas fa-chart-radar"></i>Skills Assessment</h3>
                            <div id="en-skills-assessment">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Today's Tip -->
                        <div class="dashboard-card card-phrase">
                            <h3><i class="fas fa-lightbulb"></i>Phrase of the Day</h3>
                            <div class="tip-box">
                                <p>Try using this phrase today:</p>
                                <span class="tip-phrase" id="en-daily-phrase">"I'm looking forward to..."</span>
                                <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--color-text-light);" id="en-phrase-example">
                                    Example: I'm looking forward to our next lesson!
                                </p>
                            </div>
                        </div>

                        <!-- Progress -->
                        <div class="dashboard-card card-progress">
                            <h3><i class="fas fa-chart-line"></i>Monthly Progress</h3>
                            <div class="progress-ring-container">
                                <div class="progress-ring">
                                    <svg width="80" height="80">
                                        <circle class="progress-ring-bg" cx="40" cy="40" r="32"></circle>
                                        <circle class="progress-ring-fill" cx="40" cy="40" r="32" 
                                                stroke-dasharray="201" 
                                                id="en-progress-ring"></circle>
                                    </svg>
                                    <span class="progress-ring-text" id="en-progress-percent">0%</span>
                                </div>
                                <div class="progress-details">
                                    <h4 id="en-progress-message">Let's go!</h4>
                                    <p id="en-progress-sub">Working toward your goal</p>
                                </div>
                            </div>
                            <p style="font-size: 0.9rem; color: var(--color-text-light);">
                                <i class="fas fa-check-circle" style="color: var(--color-primary);"></i>
                                <strong id="en-sessions-completed">0</strong> / <span id="en-sessions-total">20</span> sessions this month
                            </p>
                        </div>

                        <!-- Streak -->
                        <div class="dashboard-card card-streak">
                            <h3><i class="fas fa-fire"></i>Practice Streak</h3>
                            <div class="streak-header">
                                <span class="streak-fire" id="en-streak-emoji">🔥</span>
                                <div>
                                    <span class="streak-count" id="en-streak-count">0</span>
                                    <span class="streak-label">day streak!</span>
                                </div>
                            </div>
                            <div class="streak-calendar" id="en-streak-calendar">
                                <!-- Calendar will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Achievements -->
                        <div class="dashboard-card card-achievements">
                            <h3><i class="fas fa-trophy"></i>Achievements</h3>
                            <div class="achievements-grid" id="en-achievements">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                       <!-- Account Info -->
<div class="dashboard-card card-account">
    <h3><i class="fas fa-user-circle"></i>Account Info</h3>
    <div id="en-plan-badges">
        <span class="plan-badge" id="en-plan-badge">Plan A</span>
    </div>
    <ul class="account-details">
        <li><strong>Name</strong><span id="en-profile-name">-</span></li>
        <li><strong>Email</strong><span id="en-profile-email">-</span></li>
        <li><strong>Level</strong><span id="en-profile-level">-</span></li>
        <li><strong>Status</strong><span id="en-profile-status">-</span></li>
    </ul>
    <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <a href="account-settings.html" class="cta-button cta-secondary" style="font-size: 0.85rem; padding: 0.5rem 1rem;">
            <i class="fas fa-cog"></i> Settings
        </a>
        <a href="contact.html?subject=plan-change" class="cta-button cta-secondary" style="font-size: 0.85rem; padding: 0.5rem 1rem;">Change Plan</a>
        <button id="en-logout-btn" class="cta-button cta-secondary" style="font-size: 0.85rem; padding: 0.5rem 1rem;">Log Out</button>
    </div>
</div>
                    <!-- Upcoming Lessons -->
<div class="dashboard-card card-lessons" id="en-upcoming-lessons-card" style="display: none;">
    <h3><i class="fas fa-calendar-alt"></i>Upcoming Lessons</h3>
    <div id="en-upcoming-lessons">
        <!-- Will be populated by JavaScript -->
    </div>
</div>

<!-- 🆕 BOOKING RULES CARD -->
<div class="dashboard-card card-booking-rules">
    <h3><i class="fas fa-book-open"></i>Lesson Booking Rules</h3>
    <div class="rules-list">
        <div class="rule-item">
            <i class="fas fa-check-circle" style="color: #4CAF50;"></i>
            <span><strong>Free changes:</strong> Cancel or reschedule >24h before lesson</span>
        </div>
        <div class="rule-item">
            <i class="fas fa-times-circle" style="color: #f44336;"></i>
            <span><strong>No refund:</strong> Changes made <24h before lesson</span>
        </div>
        <div class="rule-item">
            <i class="fas fa-user-slash" style="color: #ff9800;"></i>
            <span><strong>No-shows:</strong> Credit is not refunded if you miss your lesson</span>
        </div>
        <div class="rule-item">
            <i class="fas fa-video" style="color: #2196F3;"></i>
            <span><strong>Meet link:</strong> Available 24h before until 1h after lesson</span>
        </div>
    </div>
</div>
                        <!-- Upcoming Lessons -->
<div class="dashboard-card card-lessons" id="en-upcoming-lessons-card" style="display: none;">
    <h3><i class="fas fa-calendar-alt"></i>Upcoming Lessons</h3>
    <div id="en-upcoming-lessons">
        <!-- Will be populated by JavaScript -->
    </div>
</div>

                        <!-- Learning Resources -->
                        <div class="dashboard-card card-resources" id="en-resources">
                            <h3><i class="fas fa-folder-open"></i>Learning Resources</h3>
                            <div class="resource-item">
                                <i class="fas fa-file-pdf"></i>
                                <a href="#" class="coming-soon">Common Conversation Phrases</a>
                                <span class="resource-tag coming">Coming Soon</span>
                            </div>
                            <div class="resource-item">
                                <i class="fas fa-file-pdf"></i>
                                <a href="#" class="coming-soon">Business English Basics</a>
                                <span class="resource-tag coming">Coming Soon</span>
                            </div>
                            <div class="resource-item">
                                <i class="fas fa-link"></i>
                                <a href="#" class="coming-soon">Recommended YouTube Channels</a>
                                <span class="resource-tag coming">Coming Soon</span>
                            </div>
                            <div class="resource-item">
                                <i class="fas fa-headphones"></i>
                                <a href="#" class="coming-soon">Listening Practice Audio</a>
                                <span class="resource-tag coming">Coming Soon</span>
                            </div>
                            <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--color-text-muted); text-align: center;">
                                <i class="fas fa-info-circle"></i> More resources coming soon!
                            </p>
                        </div>

                        <!-- Upgrade Card -->
                        <div class="dashboard-card upgrade-card card-upgrade" id="en-upgrade-card" style="display: none;">
                            <h3><i class="fas fa-star"></i>Add Video Lessons</h3>
                            <p>Want to practice speaking with a teacher directly?</p>
                            <a href="https://buy.stripe.com/28E9AS4UrcIP8JK7wbes002" target="_blank" class="cta-button">
                                Casual Lesson ¥3,000
                            </a>
                            <p style="margin-top: 0.75rem; font-size: 0.85rem; opacity: 0.9;">
                                <a href="https://buy.stripe.com/28E14mev16kr4tu5o3es003" target="_blank" style="color: white; text-decoration: underline;">
                                    Business Lesson ¥5,000
                                </a>
                            </p>
                        </div>

                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-column">
                    <h3>Company</h3>
                    <ul>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Legal</h3>
                    <ul>
                        <li><a href="commerce-disclosure.html">Commerce Disclosure</a></li>
                        <li><a href="privacy-policy.html">Privacy Policy</a></li>
                        <li><a href="terms-of-service.html">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Connect</h3>
                    <div class="footer-social-icons">
                        <a href="https://page.line.me/845irjbc" class="social-icon" target="_blank" aria-label="LINE"><i class="fab fa-line"></i></a>
                        <a href="https://www.instagram.com/prokaiwa.english/" class="social-icon" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                        <a href="https://x.com/ProkaiwaEnglish" class="social-icon" target="_blank" aria-label="X (formerly Twitter)"><i class="fab fa-x-twitter"></i></a>
                    </div>
                    <a href="mailto:prokaiwa.english@gmail.com" class="footer-email">prokaiwa.english@gmail.com</a>
                </div>
            </div>
            <p>© <span id="year"></span> Prokaiwa. All rights reserved.</p>
        </div>
    </footer>

    <script type="module">
        console.log('🚀 DASHBOARD SCRIPT STARTING...');
        
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/+esm';

        // =============================================
        // CONFIGURATION
        // =============================================
        const SUPABASE_URL = 'https://luyzyzefgintksydmwoh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1eXp5emVmZ2ludGtzeWRtd29oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5NzYyMDUsImV4cCI6MjA2ODU1MjIwNX0.he5_j99ZtAj4K_zzgm11NEEv7TrbRJYndJXot25s_Kg';
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: true,
                storageKey: 'prokaiwa-supabase-auth',
                storage: window.localStorage,
                autoRefreshToken: true,
                detectSessionInUrl: true
            }
        });
        
        console.log('✅ Supabase client created successfully');
        
        const MONTHLY_GOAL = 20;

        // Daily phrases
        const dailyPhrases = [
            { phrase: '"I\'m looking forward to..."', example_en: 'I\'m looking forward to our next lesson!', example_ja: '次のレッスンが楽しみです！' },
            { phrase: '"Could you please..."', example_en: 'Could you please repeat that?', example_ja: 'もう一度言っていただけますか？' },
            { phrase: '"I\'d like to..."', example_en: 'I\'d like to practice speaking more.', example_ja: 'もっとスピーキングを練習したいです。' },
            { phrase: '"What do you think about..."', example_en: 'What do you think about this idea?', example_ja: 'このアイデアについてどう思いますか？' },
            { phrase: '"It depends on..."', example_en: 'It depends on the situation.', example_ja: '状況によります。' },
            { phrase: '"I\'m not sure, but..."', example_en: 'I\'m not sure, but I think so.', example_ja: '確かではないですが、そう思います。' },
            { phrase: '"Let me think about it."', example_en: 'Let me think about it and get back to you.', example_ja: '考えて後で連絡しますね。' },
        ];

        // Learning Archetype definitions
        const learningArchetypes = [
            {
                code: 'perfect_master',
                icon: '💎',
                name_ja: 'パーフェクトマスター',
                name_en: 'Perfect Master',
                description_ja: '全スキル完璧！あなたは英語学習の頂点に立っています。素晴らしい努力の結晶です！',
                description_en: 'Perfect across all skills! You\'ve reached the pinnacle of English mastery. Exceptional work!',
                condition: (skills) => {
                    return skills.fluency === 10 && skills.grammar === 10 && skills.comprehension === 10 && 
                           skills.vocabulary === 10 && skills.pronunciation === 10;
                }
            },
            {
                code: 'advanced_achiever',
                icon: '🏆',
                name_ja: '上級達成者',
                name_en: 'Advanced Achiever',
                description_ja: '高いレベルまで到達しています！この実力を維持しながら、さらなる高みを目指しましょう！',
                description_en: 'You\'ve reached an advanced level! Maintain this excellence while aiming even higher!',
                condition: (skills) => {
                    const values = [skills.fluency, skills.grammar, skills.comprehension, skills.vocabulary, skills.pronunciation];
                    const advancedCount = values.filter(v => v >= 7).length;
                    return advancedCount >= 3;
                }
            },
            {
                code: 'natural_speaker',
                icon: '🗣️',
                name_ja: '天性のスピーカー',
                name_en: 'Natural Speaker',
                description_ja: '流暢さと発音が特に優れています。あなたは生まれながらのコミュニケーターですね！',
                description_en: 'Your fluency and pronunciation stand out. You\'re a natural communicator!',
                condition: (skills) => {
                    const speakingAvg = (skills.fluency + skills.pronunciation) / 2;
                    const otherAvg = (skills.grammar + skills.comprehension + skills.vocabulary) / 3;
                    return speakingAvg >= 6 && speakingAvg > otherAvg + 1.5;
                }
            },
            {
                code: 'grammar_guru',
                icon: '📚',
                name_ja: '文法マスター',
                name_en: 'Grammar Guru',
                description_ja: '文法と語彙力が強みです。分析的な学習スタイルが英語の構造理解を深めています！',
                description_en: 'Grammar and vocabulary are your strengths. Your analytical approach builds strong language foundations!',
                condition: (skills) => {
                    const structureAvg = (skills.grammar + skills.vocabulary) / 2;
                    const otherAvg = (skills.fluency + skills.comprehension + skills.pronunciation) / 3;
                    return structureAvg >= 6 && structureAvg > otherAvg + 1.5;
                }
            },
            {
                code: 'comprehension_champion',
                icon: '👂',
                name_ja: '理解力の達人',
                name_en: 'Comprehension Champion',
                description_ja: '理解力が抜群です。聞き取りと文脈把握の才能が際立っています！',
                description_en: 'Your comprehension excels. You have a gift for understanding context and nuance!',
                condition: (skills) => {
                    return skills.comprehension >= 7 && skills.comprehension >= Math.max(skills.fluency, skills.grammar, skills.vocabulary, skills.pronunciation) + 1;
                }
            },
            {
                code: 'rising_star',
                icon: '⭐',
                name_ja: 'ライジングスター',
                name_en: 'Rising Star',
                description_ja: 'すべてのスキルが着実に成長中！この調子で頑張れば、必ず目標に到達できます！',
                description_en: 'All your skills are steadily improving! Keep up this momentum and you\'ll reach your goals!',
                condition: (skills) => {
                    const values = [skills.fluency, skills.grammar, skills.comprehension, skills.vocabulary, skills.pronunciation];
                    return values.every(v => v >= 4 && v <= 7);
                }
            },
            {
                code: 'foundation_builder',
                icon: '🏗️',
                name_ja: '基礎固め中',
                name_en: 'Foundation Builder',
                description_ja: '基礎をしっかり築いている段階です。この土台が将来の成長を支えます。着実に進みましょう！',
                description_en: 'You\'re building a solid foundation. This groundwork will support all your future growth. Keep going!',
                condition: (skills) => {
                    const values = [skills.fluency, skills.grammar, skills.comprehension, skills.vocabulary, skills.pronunciation];
                    const beginnerCount = values.filter(v => v <= 4).length;
                    return beginnerCount >= 3;
                }
            },
            {
                code: 'balanced_learner',
                icon: '🎯',
                name_ja: 'バランス型学習者',
                name_en: 'Balanced Learner',
                description_ja: 'すべてのスキルがバランスよく成長しています。この万能さは実践的なコミュニケーション力の証です！',
                description_en: 'All your skills are developing evenly. This versatility shows strong practical communication ability!',
                condition: (skills) => {
                    const values = [skills.fluency, skills.grammar, skills.comprehension, skills.vocabulary, skills.pronunciation];
                    const max = Math.max(...values);
                    const min = Math.min(...values);
                    return (max - min) <= 2;
                }
            }
        ];

        // Achievement definitions
        const achievements = [
            { 
                code: 'first_session', 
                icon: 'fa-play', 
                name_ja: '初回完了', 
                name_en: 'First Session', 
                condition: (stats) => stats.total >= 1 
            },
            { 
                code: 'streak_3', 
                icon: 'fa-fire', 
                name_ja: '3日連続', 
                name_en: '3-Day Streak', 
                condition: (stats) => stats.maxStreak >= 3 
            },
            { 
                code: 'weekend_warrior', 
                icon: 'fa-calendar-week', 
                name_ja: '週末戦士', 
                name_en: 'Weekend Warrior', 
                condition: (stats) => {
                    const dates = stats.practiceDates || [];
                    let hasSaturday = false;
                    let hasSunday = false;
                    
                    for (const dateStr of dates) {
                        const day = new Date(dateStr).getDay();
                        if (day === 6) hasSaturday = true;
                        if (day === 0) hasSunday = true;
                        if (hasSaturday && hasSunday) return true;
                    }
                    return false;
                }
            },
            { 
                code: 'streak_7', 
                icon: 'fa-calendar-check', 
                name_ja: '7日連続', 
                name_en: '7-Day Streak', 
                condition: (stats) => stats.maxStreak >= 7 
            },
            { 
                code: 'sessions_10', 
                icon: 'fa-star', 
                name_ja: '10回達成', 
                name_en: '10 Sessions', 
                condition: (stats) => stats.total >= 10 
            },
            { 
                code: 'consistency_champion', 
                icon: 'fa-trophy', 
                name_ja: '継続王', 
                name_en: 'Consistency Champion', 
                condition: (stats) => {
                    const dates = stats.practiceDates || [];
                    const monthCounts = {};
                    
                    for (const dateStr of dates) {
                        const yearMonth = dateStr.substring(0, 7);
                        monthCounts[yearMonth] = (monthCounts[yearMonth] || 0) + 1;
                    }
                    
                    return Object.values(monthCounts).some(count => count >= 20);
                }
            },
            { 
                code: 'streak_30', 
                icon: 'fa-medal', 
                name_ja: '30日連続', 
                name_en: '30-Day Streak', 
                condition: (stats) => stats.maxStreak >= 30 
            },
            { 
                code: 'golden_milestone', 
                icon: 'fa-award', 
                name_ja: 'ゴールデン達成', 
                name_en: 'Golden Milestone', 
                condition: (stats) => stats.total >= 50 
            },
            { 
                code: 'sessions_100', 
                icon: 'fa-crown', 
                name_ja: '100回達成', 
                name_en: '100 Sessions', 
                condition: (stats) => stats.total >= 100 
            },
        ];

        // =============================================
        // HELPER FUNCTIONS
        // =============================================
        
        function getCurrentLang() {
    const stored = localStorage.getItem('prokaiwaLang');
    if (stored) return stored;
    
    const browserLang = navigator.language || navigator.userLanguage;
    return browserLang.startsWith('ja') ? 'ja' : 'en';
}

        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }

        function getMonthStart() {
            const now = new Date();
            return new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        }

        const planNames = {
    ja: { 
        'line': 'LINEプラクティスプラン', 
        'video': 'ビデオレッスン（50分）',
        'power_lite': 'パワーパック・ライト', 
        'power_pro': 'パワーパック・プロ' 
    },
    en: { 
        'line': 'LINE Practice Plan', 
        'video': 'Video Lesson (50min)',
        'power_lite': 'Power Pack Lite', 
        'power_pro': 'Power Pack Pro' 
    }
};

        const statusNames = {
            ja: { paid: '有効', pending: '支払い待ち' },
            en: { paid: 'Active', pending: 'Payment Pending' }
        };

        const levelNames = {
            ja: { 'Super Beginner': '超初級', 'Beginner': '初級', 'Intermediate': '中級', 'Advanced': '上級' },
            en: { 'Super Beginner': 'Super Beginner', 'Beginner': 'Beginner', 'Intermediate': 'Intermediate', 'Advanced': 'Advanced' }
        };

        function showError(lang, message) {
            document.getElementById(`${lang}-dashboard-loading`).style.display = 'none';
            document.getElementById(`${lang}-dashboard-content`).style.display = 'none';
            document.getElementById(`${lang}-dashboard-error`).style.display = 'block';
            document.getElementById(`${lang}-error-message`).textContent = message;
        }

        // =============================================
        // LEARNING ARCHETYPE DETERMINATION
        // =============================================
        
        function getLearningArchetype(skillsData) {
            console.log('🎯 Determining learning archetype for:', skillsData);
            for (const archetype of learningArchetypes) {
                if (archetype.condition(skillsData)) {
                    console.log('✅ Matched archetype:', archetype.code);
                    return archetype;
                }
            }
            console.log('⚠️ No match, using fallback: balanced_learner');
            return learningArchetypes[learningArchetypes.length - 1];
        }

        // =============================================
        // PENTAGON RADAR CHART
        // =============================================
        
        function renderSkillsChart(containerId, assessment, lang) {
            const container = document.getElementById(containerId);
            
            if (!assessment) {
                container.innerHTML = `
                    <div class="no-assessment-message">
                        <i class="fas fa-clipboard-list"></i>
                        <p><strong>${lang === 'ja' ? 'まだ評価がありません' : 'No assessment yet'}</strong></p>
                        <p>${lang === 'ja' 
                            ? '講師があなたのスキルを評価すると、ここに結果が表示されます。楽しみにしていてくださいね！' 
                            : 'Your teacher will evaluate your skills soon and your results will appear here. Stay tuned!'}</p>
                    </div>
                `;
                return;
            }
            
            const allPerfect = assessment.fluency === 10 && 
                                assessment.grammar === 10 && 
                                assessment.comprehension === 10 && 
                                assessment.vocabulary === 10 && 
                                assessment.pronunciation === 10;
            
            const skillsData = {
                fluency: assessment.fluency || 0,
                grammar: assessment.grammar || 0,
                comprehension: assessment.comprehension || 0,
                vocabulary: assessment.vocabulary || 0,
                pronunciation: assessment.pronunciation || 0
            };
            
            console.log('Rendering skills chart:', skillsData, 'All perfect:', allPerfect);
            
            const skillColors = {
                fluency: '#4A90E2',
                grammar: '#9B59B6',
                comprehension: '#E67E22',
                vocabulary: '#27AE60',
                pronunciation: '#E74C3C'
            };
            
            const skillLabels = lang === 'ja'
                ? ['流暢さ', '文法', '理解力', '語彙', '発音']
                : ['Fluency', 'Grammar', 'Comprehension', 'Vocabulary', 'Pronunciation'];
            
            const skillValues = [
                skillsData.fluency,
                skillsData.grammar,
                skillsData.comprehension,
                skillsData.vocabulary,
                skillsData.pronunciation
            ];
            
            const pointColors = [
                skillColors.fluency,
                skillColors.grammar,
                skillColors.comprehension,
                skillColors.vocabulary,
                skillColors.pronunciation
            ];
            
            const borderColor = allPerfect ? '#008080' : 'rgba(74, 144, 226, 0.6)';
            const backgroundColor = allPerfect ? 'rgba(0, 128, 128, 0.3)' : 'rgba(74, 144, 226, 0.1)';
            
            const archetype = getLearningArchetype(skillsData);
            
            container.innerHTML = `
                <div class="skills-chart-container">
                    <canvas id="${containerId}-canvas"></canvas>
                </div>
                <div class="assessment-info">
                    <span class="assessment-date">
                        ${lang === 'ja' ? '評価日：' : 'Assessed: '}
                        ${new Date(assessment.assessed_at).toLocaleDateString(lang === 'ja' ? 'ja-JP' : 'en-US')}
                    </span>
                    <span class="assessment-band">${assessment.band_level || '-'}</span>
                </div>
                <div class="learning-archetype">
                    <div class="archetype-icon">${archetype.icon}</div>
                    <div class="archetype-content">
                        <div class="archetype-name">${lang === 'ja' ? archetype.name_ja : archetype.name_en}</div>
                        <div class="archetype-description">${lang === 'ja' ? archetype.description_ja : archetype.description_en}</div>
                    </div>
                </div>
            `;
            
            const ctx = document.getElementById(`${containerId}-canvas`).getContext('2d');
            
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: skillLabels,
                    datasets: [{
                        label: lang === 'ja' ? 'スキルレベル' : 'Skill Level',
                        data: skillValues,
                        borderColor: borderColor,
                        backgroundColor: backgroundColor,
                        borderWidth: allPerfect ? 3 : 2,
                        pointBackgroundColor: pointColors,
                        pointBorderColor: pointColors,
                        pointBorderWidth: 2,
                        pointRadius: 8,
                        pointHoverRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    layout: {
                        padding: 10
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 10,
                            min: 0,
                            ticks: {
                                stepSize: 2,
                                display: true,
                                backdropColor: 'transparent',
                                callback: function(value) {
                                    if (value === 0) return '0';
                                    if (value === 2) return '2';
                                    if (value === 5) return '5';
                                    if (value === 8) return '8';
                                    if (value === 10) return '10';
                                    return '';
                                },
                                font: { size: 12, weight: 'bold' },
                                color: '#666'
                            },
                            pointLabels: {
                                display: false
                            },
                            grid: {
    color: window.matchMedia('(prefers-color-scheme: dark)').matches 
        ? 'rgba(255, 255, 255, 0.15)'  // Light grey in dark mode
        : 'rgba(0, 0, 0, 0.1)',         // Dark grey in light mode
    lineWidth: 1
}
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const score = context.parsed.r;
                                    let level = '';
                                    if (score === 0) level = lang === 'ja' ? '未評価' : 'Not Rated';
                                    else if (score <= 2) level = lang === 'ja' ? '超初級' : 'Super Beginner';
                                    else if (score <= 4) level = lang === 'ja' ? '初級' : 'Beginner';
                                    else if (score <= 6) level = lang === 'ja' ? '中級' : 'Intermediate';
                                    else if (score <= 8) level = lang === 'ja' ? '上級' : 'Advanced';
                                    else if (score < 10) level = lang === 'ja' ? '上級+' : 'Advanced+';
                                    else level = lang === 'ja' ? '完璧！' : 'Perfect!';
                                    
                                    return `${score}/10 (${level})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // =============================================
        // AUTO-DETECT TODAY'S PRACTICE
        // =============================================

        async function checkTodaysPractice(userId, lang) {
            const statusCard = document.getElementById(`${lang}-practice-status`);
            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);
            
            console.log(`[${lang}] Checking today's practice for user:`, userId);
            console.log(`[${lang}] Today start:`, todayStart.toISOString());
            
            try {
                const { data: todayResponse, error } = await supabase
                    .from('message_log')
                    .select('id, created_at')
                    .eq('user_id', userId)
                    .eq('message_type', 'student_response')
                    .gte('created_at', todayStart.toISOString())
                    .limit(1)
                    .maybeSingle();
                
                console.log(`[${lang}] Today's response query result:`, { data: todayResponse, error });
                
                if (error && error.code !== 'PGRST116') {
                    console.error('Error checking today\'s practice:', error);
                    return false;
                }
                
                const practicedToday = !!todayResponse;
                console.log(`[${lang}] Practiced today:`, practicedToday);
                
                if (practicedToday) {
                    statusCard.classList.add('completed');
                    statusCard.innerHTML = `
                        <div class="practice-status-icon">✅</div>
                        <h2>${lang === 'ja' ? '今日の練習完了！' : 'Today\'s Practice Complete!'}</h2>
                        <p>${lang === 'ja' ? '素晴らしい！今日もよく頑張りました！' : 'Great job! You practiced today!'}</p>
                    `;
                } else {
                    statusCard.classList.remove('completed');
                    statusCard.innerHTML = `
                        <div class="practice-status-icon"><i class="fab fa-line" style="color: white;"></i></div>
                        <h2>${lang === 'ja' ? 'まだ練習していません' : 'No Practice Yet Today'}</h2>
                        <p>${lang === 'ja' ? 'LINEで今日のプロンプトに答えましょう！' : 'Head to LINE to respond to today\'s prompt!'}</p>
                    `;
                }
                
                return practicedToday;
                
            } catch (err) {
                console.error('Error checking practice:', err);
                return false;
            }
        }

        // =============================================
        // REAL PROGRESS FROM DATABASE
        // =============================================

        async function loadRealProgress(userId, lang) {
            console.log('=== loadRealProgress START ===');
            console.log('User ID:', userId);
            
            try {
                console.log('Fetching student_progress...');
                const { data: progress, error } = await supabase
                    .from('student_progress')
                    .select('*')
                    
                    .single();
                
                console.log('student_progress result:', { data: progress, error });
                
                if (error) {
                    console.error('❌ Error loading progress:', error);
                    return null;
                }
                
                console.log('Fetching message_log...');
                const { data: messages, error: msgError } = await supabase
                    .from('message_log')
                    .select('created_at')
                    .eq('user_id', userId)
                    .eq('message_type', 'student_response')
                    .order('created_at', { ascending: false });
                
                console.log('message_log result:', { 
                    count: messages?.length || 0, 
                    error: msgError,
                    sample: messages?.slice(0, 3)
                });
                
                if (msgError) {
                    console.error('❌ Error loading messages:', msgError);
                }
                
                const practiceDates = messages 
                    ? [...new Set(messages.map(m => m.created_at.split('T')[0]))]
                    : [];
                
                console.log('Practice dates extracted:', practiceDates.length, 'unique dates');
                console.log('Sample dates:', practiceDates.slice(0, 5));
                
                const monthStart = getMonthStart();
                console.log('Month start:', monthStart);
                
                const thisMonthDates = practiceDates.filter(d => d >= monthStart);
                const thisMonthCount = thisMonthDates.length;
                
                console.log('This month count:', thisMonthCount, 'days');
                
                const streakData = calculateStreak(practiceDates);
                console.log('Streak calculated:', streakData);
                
                const result = {
                    current_day: progress.current_day,
                    current_week: progress.current_week,
                    total_prompts_sent: progress.total_prompts_sent,
                    thisMonthCount: thisMonthCount,
                    currentStreak: streakData.current,
                    maxStreak: streakData.max,
                    practiceDates: practiceDates
                };
                
                console.log('✅ Final result:', result);
                console.log('=== loadRealProgress END ===');
                
                return result;
                
            } catch (err) {
                console.error('❌ ERROR in loadRealProgress:', err);
                return null;
            }
        }

        // =============================================
        // LOAD LATEST ASSESSMENT
        // =============================================

        async function loadLatestAssessment(userId) {
            console.log('=== loadLatestAssessment START ===');
            console.log('User ID:', userId);
            
            try {
                const { data: assessment, error } = await supabase
                    .from('student_assessments')
                    .select('*')
                    .eq('user_id', userId)
                    .order('assessed_at', { ascending: false })
                    .limit(1)
                    .maybeSingle();
                
                console.log('student_assessments result:', { data: assessment, error });
                
                if (error && error.code !== 'PGRST116') {
                    console.error('❌ Error loading assessment:', error);
                    return null;
                }
                
                if (assessment) {
                    console.log('✅ Assessment found:', {
                        assessed_at: assessment.assessed_at,
                        band_level: assessment.band_level,
                        total_score: assessment.total_score
                    });
                } else {
                    console.log('ℹ️ No assessment found yet');
                }
                
                console.log('=== loadLatestAssessment END ===');
                return assessment;
                
            } catch (err) {
                console.error('❌ ERROR in loadLatestAssessment:', err);
                return null;
            }
        }

        // =============================================
        // STREAK CALCULATION
        // =============================================
        
        function calculateStreak(practiceDates) {
            if (!practiceDates || practiceDates.length === 0) return { current: 0, max: 0 };
            
            const sortedDates = [...practiceDates].sort((a, b) => new Date(b) - new Date(a));
            const today = getTodayString();
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            
            let currentStreak = 0;
            let maxStreak = 0;
            let tempStreak = 0;
            let lastDate = null;
            
            const streakActive = sortedDates.includes(today) || sortedDates.includes(yesterday);
            
            if (streakActive) {
                for (const dateStr of sortedDates) {
                    const date = new Date(dateStr);
                    if (lastDate === null) {
                        currentStreak = 1;
                        lastDate = date;
                    } else {
                        const diffDays = (lastDate - date) / (1000 * 60 * 60 * 24);
                        if (diffDays === 1) {
                            currentStreak++;
                            lastDate = date;
                        } else {
                            break;
                        }
                    }
                }
            }
            
            lastDate = null;
            for (const dateStr of sortedDates) {
                const date = new Date(dateStr);
                if (lastDate === null) {
                    tempStreak = 1;
                    lastDate = date;
                } else {
                    const diffDays = (lastDate - date) / (1000 * 60 * 60 * 24);
                    if (diffDays === 1) {
                        tempStreak++;
                        lastDate = date;
                    } else {
                        maxStreak = Math.max(maxStreak, tempStreak);
                        tempStreak = 1;
                        lastDate = date;
                    }
                }
            }
            maxStreak = Math.max(maxStreak, tempStreak);
            
            return { current: currentStreak, max: maxStreak };
        }

        // =============================================
        // UI RENDERING
        // =============================================
        
        function renderStreakCalendar(containerId, practiceDates, lang) {
            const container = document.getElementById(containerId);
            const calendarId = `${containerId}-calendar-grid`;
            
            container.innerHTML = `<div id="${calendarId}" class="streak-calendar"></div>`;
            
            const calendarGrid = document.getElementById(calendarId);
            
            const days = lang === 'ja' 
                ? ['日', '月', '火', '水', '木', '金', '土']
                : ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            
            days.forEach(day => {
                const header = document.createElement('div');
                header.className = 'streak-day-header';
                header.textContent = day;
                calendarGrid.appendChild(header);
            });

            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            const today = now.getDate();
            
            const startDay = firstDay.getDay();
            for (let i = 0; i < startDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'streak-day';
                empty.style.visibility = 'hidden';
                calendarGrid.appendChild(empty);
            }
            
            const sortedDates = [...practiceDates].sort();
            
            for (let d = 1; d <= lastDay.getDate(); d++) {
                const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const day = document.createElement('div');
                day.className = 'streak-day';
                day.textContent = d;
                
                if (practiceDates.includes(dateStr)) {
                    let streakLength = 1;
                    const currentDate = new Date(dateStr);
                    
                    for (let i = 1; i <= 30; i++) {
                        const prevDate = new Date(currentDate);
                        prevDate.setDate(prevDate.getDate() - i);
                        const prevDateStr = prevDate.toISOString().split('T')[0];
                        
                        if (sortedDates.includes(prevDateStr)) {
                            streakLength++;
                        } else {
                            break;
                        }
                    }
                    
                    if (streakLength >= 7) {
                        day.classList.add('streak-fire');
                    } else if (streakLength >= 3) {
                        day.classList.add('streak-hot');
                    } else {
                        day.classList.add('active');
                    }
                }
                if (d === today) {
                    day.classList.add('today');
                }
                if (d > today) {
                    day.classList.add('future');
                }
                
                calendarGrid.appendChild(day);
            }
        }

        function renderAchievements(containerId, stats, lang) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            achievements.forEach(achievement => {
                const earned = achievement.condition(stats);
                const div = document.createElement('div');
                div.className = `achievement${earned ? '' : ' locked'}`;
                div.innerHTML = `
                    <div class="achievement-icon ${earned ? 'earned' : 'locked'}">
                        <i class="fas ${achievement.icon}"></i>
                    </div>
                    <span class="achievement-name">${lang === 'ja' ? achievement.name_ja : achievement.name_en}</span>
                `;
                container.appendChild(div);
            });
        }

        function updateProgressRing(lang, percentage) {
            const ring = document.getElementById(`${lang}-progress-ring`);
            const text = document.getElementById(`${lang}-progress-percent`);
            const message = document.getElementById(`${lang}-progress-message`);
            
            const circumference = 201;
            const offset = circumference - (percentage / 100) * circumference;
            
            ring.style.strokeDashoffset = offset;
            text.textContent = `${Math.round(percentage)}%`;
            
            if (lang === 'ja') {
                if (percentage >= 100) message.textContent = '目標達成！🎉';
                else if (percentage >= 75) message.textContent = 'あと少し！';
                else if (percentage >= 50) message.textContent = '順調です！';
                else if (percentage >= 25) message.textContent = 'いい調子！';
                else message.textContent = '頑張りましょう！';
            } else {
                if (percentage >= 100) message.textContent = 'Goal reached! 🎉';
                else if (percentage >= 75) message.textContent = 'Almost there!';
                else if (percentage >= 50) message.textContent = 'Great progress!';
                else if (percentage >= 25) message.textContent = 'Good start!';
                else message.textContent = "Let's go!";
            }
        }

        function setDailyPhrase(lang) {
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
            const phrase = dailyPhrases[dayOfYear % dailyPhrases.length];
            
            document.getElementById(`${lang}-daily-phrase`).textContent = phrase.phrase;
            document.getElementById(`${lang}-phrase-example`).innerHTML = lang === 'ja'
                ? `例：${phrase.example_en}<br>（${phrase.example_ja}）`
                : `Example: ${phrase.example_en}`;
        }

        // =============================================
        // MAIN DASHBOARD LOADER
        // =============================================
        
        async function loadDashboard() {
            const lang = getCurrentLang();
            const loadingDiv = document.getElementById(`${lang}-dashboard-loading`);
            const contentDiv = document.getElementById(`${lang}-dashboard-content`);

            console.log('Loading dashboard with Phase 1 features...');

            try {
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    console.error('Session error:', sessionError);
                }
                
                if (!session) {
                    console.log('No session found, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }
                
                const user = session.user;
                console.log('User authenticated:', user.email);

                const { data: profile, error: profileError } = await supabase
                    .from('questionnaire_responses')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();
                
                if (profileError) {
                    console.error('Profile error:', profileError);
                    
                    if (profileError.code === 'PGRST116') {
                        console.log('No profile found, redirecting to questionnaire');
                        window.location.href = 'questionnaire.html';
                        return;
                    }
                    
                    showError(lang, lang === 'ja' 
                        ? 'プロフィールの読み込みに失敗しました。' 
                        : 'Failed to load profile.');
                    return;
                }

                const realProgress = await loadRealProgress(user.id, lang);
                const assessment = await loadLatestAssessment(user.id);
                
                await checkTodaysPractice(user.id, 'ja');
                await checkTodaysPractice(user.id, 'en');
                
                let stats = {
                    current: 0,
                    maxStreak: 0,
                    total: 0,
                    thisMonth: 0,
                    practiceDates: []
                };
                
                let practiceDates = [];
                
                if (realProgress) {
                    stats = {
                        current: realProgress.currentStreak,
                        maxStreak: realProgress.maxStreak,
                        total: realProgress.practiceDates.length,
                        thisMonth: realProgress.thisMonthCount,
                        practiceDates: realProgress.practiceDates
                    };
                    practiceDates = realProgress.practiceDates;
                }
                
                const progressPercent = Math.min((stats.thisMonth / MONTHLY_GOAL) * 100, 100);

                const hasVideoAddon = profile.addons?.includes('video') || false;
                const hasVideoAccess = profile.had_video_access || hasVideoAddon;

                ['ja', 'en'].forEach(l => {
                    const welcomeText = l === 'ja' 
                        ? `${profile.given_name_romaji || profile.name}さん、おかえりなさい！`
                        : `Welcome back, ${profile.given_name_romaji || profile.name}!`;
                    document.getElementById(`${l}-welcome-name`).textContent = welcomeText;

                    document.getElementById(`${l}-stat-streak`).textContent = stats.current;
                    document.getElementById(`${l}-stat-total`).textContent = stats.total;
                    document.getElementById(`${l}-stat-month`).textContent = stats.thisMonth;

                    document.getElementById(`${l}-profile-name`).textContent = profile.name;
                    document.getElementById(`${l}-profile-email`).textContent = profile.email;
                    document.getElementById(`${l}-profile-level`).textContent = levelNames[l][profile.level] || profile.level;
                    
                    // Check subscription status
const isCancelled = profile.subscription_status === 'cancelled';
const cancelledAt = profile.cancelled_at ? new Date(profile.cancelled_at) : null;
const dashboardExpiresAt = profile.dashboard_access_expires_at ? new Date(profile.dashboard_access_expires_at) : null;
const now = new Date();
const isExpired = dashboardExpiresAt && dashboardExpiresAt < now;

// Update status text
let statusText = '';
if (isExpired) {
    statusText = currentLang === 'ja' ? '期限切れ' : 'Expired';
    statusEl.style.color = '#dc3545';
    statusEl.style.fontWeight = '600';
} else if (isCancelled && dashboardExpiresAt) {
    const expiresDate = dashboardExpiresAt.toLocaleDateString(
        currentLang === 'ja' ? 'ja-JP' : 'en-US',
        { year: 'numeric', month: 'long', day: 'numeric' }
    );
    statusText = currentLang === 'ja' 
        ? `キャンセル済 - ${expiresDate}まで利用可能`
        : `Cancelled - Access Until ${expiresDate}`;
    
    // ADD YELLOW HIGHLIGHT TO STATUS TEXT
    statusEl.style.color = '#856404';
    statusEl.style.fontWeight = '600';
    statusEl.style.backgroundColor = '#fff3cd';
    statusEl.style.padding = '0.5rem 1rem';
    statusEl.style.borderRadius = '6px';
    statusEl.style.display = 'inline-block';
}
    const expiryDate = dashboardExpiresAt.toLocaleDateString(l === 'ja' ? 'ja-JP' : 'en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    statusText = l === 'ja' 
        ? `キャンセル済 - ${expiryDate}まで利用可能`
        : `Cancelled - Access Until ${expiryDate}`;
} else {
    const isPaid = profile.payment_status === 'paid';
    statusText = isPaid ? statusNames[l].paid : statusNames[l].pending;
}

document.getElementById(`${l}-profile-status`).textContent = statusText;

// Update plan badge
const planBadge = document.getElementById(`${l}-plan-badge`);
planBadge.textContent = planNames[l][profile.plan] || profile.plan;
if (profile.payment_status !== 'paid') planBadge.classList.add('pending');
if (isCancelled && !isExpired) planBadge.classList.add('cancelled');
if (isExpired) planBadge.classList.add('expired');
if (hasVideoAddon) planBadge.classList.add('has-addon');

// Show cancellation banner if applicable
if (isCancelled && !isExpired && dashboardExpiresAt) {
    const banner = document.getElementById(`${l}-cancellation-banner`);
    const titleEl = document.getElementById(`${l}-cancellation-title`);
    const messageEl = document.getElementById(`${l}-cancellation-message`);
    const daysEl = document.getElementById(`${l}-days-remaining`);
    const timerEl = document.getElementById(`${l}-countdown-timer`);
    
    if (banner) {
        // Calculate days remaining
        const daysRemaining = Math.ceil((dashboardExpiresAt - now) / (1000 * 60 * 60 * 24));
        
        // Update content
        if (l === 'ja') {
            titleEl.textContent = 'サブスクリプションがキャンセルされました';
            messageEl.textContent = `${dashboardExpiresAt.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' })}までアクセス可能です`;
        } else {
            titleEl.textContent = 'Subscription Cancelled';
            messageEl.textContent = `Your access continues until ${dashboardExpiresAt.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`;
        }
        
        daysEl.textContent = daysRemaining;
        
        // Show/hide timer based on days remaining
        if (daysRemaining <= 0) {
            timerEl.style.display = 'none';
        } else {
            timerEl.style.display = 'inline-flex';
        }
        
        banner.style.display = 'block';
    }
} else if (isExpired) {
    // Show expired banner
    const banner = document.getElementById(`${l}-cancellation-banner`);
    const titleEl = document.getElementById(`${l}-cancellation-title`);
    const messageEl = document.getElementById(`${l}-cancellation-message`);
    const timerEl = document.getElementById(`${l}-countdown-timer`);
    
    if (banner) {
        banner.classList.add('expired');
        
        if (l === 'ja') {
            titleEl.textContent = 'アクセス期限が切れました';
            messageEl.textContent = '再度サブスクリプションを開始するには、下のボタンをクリックしてください';
        } else {
            titleEl.textContent = 'Access Expired';
            messageEl.textContent = 'Reactivate your subscription to continue learning';
        }
        
        timerEl.style.display = 'none';
        banner.style.display = 'block';
    }
}

                    if (hasVideoAddon) {
                        const badgeContainer = document.getElementById(`${l}-plan-badges`);
                        badgeContainer.innerHTML += `<span class="addon-badge">+ ${l === 'ja' ? 'ビデオ' : 'Video'}</span>`;
                    }

                    const bookLessonBtn = document.getElementById(`${l}-book-lesson-btn`);
const upcomingCard = document.getElementById(`${l}-upcoming-lessons-card`);
const upgradeCard = document.getElementById(`${l}-upgrade-card`);

if (hasVideoAccess) {
    if (upcomingCard) {
        upcomingCard.style.display = 'block';
    }
    if (upgradeCard) {
        upgradeCard.style.display = 'none';
    }
} else {
    if (bookLessonBtn) {
        bookLessonBtn.style.display = 'none';
    }
    if (upcomingCard) {
        upcomingCard.style.display = 'none';
    }
    if (upgradeCard) {
        upgradeCard.style.display = 'block';
    }
}

                    document.getElementById(`${l}-sessions-completed`).textContent = stats.thisMonth;
                    document.getElementById(`${l}-sessions-total`).textContent = MONTHLY_GOAL;
                    updateProgressRing(l, progressPercent);

                    document.getElementById(`${l}-streak-count`).textContent = stats.current;
                    document.getElementById(`${l}-streak-emoji`).textContent = stats.current >= 7 ? '🔥' : stats.current >= 3 ? '🔥' : '💪';
                    renderStreakCalendar(`${l}-streak-calendar`, practiceDates, l);

                    renderAchievements(`${l}-achievements`, stats, l);

                    setDailyPhrase(l);
                    
                    renderSkillsChart(`${l}-skills-assessment`, assessment, l);
                });

                loadingDiv.style.display = 'none';
                contentDiv.style.display = 'block';

                const otherLang = lang === 'ja' ? 'en' : 'ja';
                document.getElementById(`${otherLang}-dashboard-loading`).style.display = 'none';
                document.getElementById(`${otherLang}-dashboard-content`).style.display = 'block';
                
                // Initialize booking widget
                await initializeBookingWidget(profile.id, user.id);
                
                console.log('✅ Dashboard loaded with Phase 1 features!');
                
            } catch (error) {
                console.error('Dashboard load error:', error);
                showError(lang, lang === 'ja' 
                    ? '予期しないエラーが発生しました。' 
                    : 'An unexpected error occurred.');
            }
        }

        // =============================================
        // LANGUAGE TOGGLE SYSTEM
        // =============================================
        
        function setLanguage(lang) {
            localStorage.setItem('prokaiwaLang', lang);
            
            document.querySelectorAll('.lang-section').forEach(section => {
                section.classList.remove('show');
            });
            document.getElementById(`${lang}-dashboard`).classList.add('show');
            
            document.querySelectorAll('.nav-lang-toggle button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        document.querySelectorAll('.nav-lang-toggle button').forEach(button => {
            button.addEventListener('click', () => {
                setLanguage(button.dataset.lang);
            });
        });
        
        const initialLang = getCurrentLang();
        setLanguage(initialLang);

        // =============================================
        // EVENT LISTENERS & INITIALIZATION
        // =============================================
        
        async function handleLogout() {
            console.log('Logging out...');
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        }

        document.getElementById('logout-button-nav').addEventListener('click', (e) => {
            e.preventDefault();
            handleLogout();
        });
        document.getElementById('ja-logout-btn').addEventListener('click', handleLogout);
        document.getElementById('en-logout-btn').addEventListener('click', handleLogout);

        supabase.auth.onAuthStateChange((event, session) => {
            console.log('Auth state changed:', event);
            
            if (event === 'SIGNED_OUT') {
                window.location.href = 'login.html';
            } else if (event === 'TOKEN_REFRESHED') {
                console.log('Token refreshed successfully');
            }
        });

        loadDashboard();
        
        document.getElementById('year').textContent = new Date().getFullYear();
        
        const burgerMenu = document.querySelector('.burger-menu');
        const mainNav = document.querySelector('.main-nav');
        if (burgerMenu && mainNav) {
            burgerMenu.addEventListener('click', () => {
                mainNav.classList.toggle('open');
            });
        }

        // =============================================
        // BOOKING WIDGET - MODAL VERSION
        // =============================================

        let bookingState = {
            selectedDate: null,
            selectedTime: null,
            selectedLessonType: 'standard',
            availableSlots: [],
            userBookings: [],
            availableCredits: 0,
            eligibleForConsultation: false,
            currentMonth: new Date(),
            studentId: null,
            userId: null,
            currentLang: 'ja'
        };

        // MODAL FUNCTIONS
        window.openBookingModal = async function(lang) {
    console.log('📖 Opening booking modal for lang:', lang);
    bookingState.currentLang = lang;
    
    // Update modal title
    document.getElementById('modal-title').textContent = lang === 'ja' ? 'レッスン予約' : 'Book a Lesson';
    
    // Render booking widget content
    const modalContent = document.getElementById('modal-booking-content');
    modalContent.innerHTML = getBookingWidgetHTML(lang);
    
    // Show modal
    document.getElementById('booking-modal-overlay').classList.add('show');
    document.getElementById('booking-modal').classList.add('show');
    
    // Scroll modal body to top
    const modalBody = document.querySelector('.booking-modal-body');
    if (modalBody) {
        modalBody.scrollTop = 0;
    }
    
    // 🆕 REFRESH CREDITS AFTER MODAL HTML EXISTS
    await fetchBookingEligibility(bookingState.studentId, lang);
    
    // Initialize widget
    renderCalendar(lang);
    setupBookingEventListeners(lang);
};

        window.closeBookingModal = function() {
            console.log('📕 Closing booking modal');
            document.getElementById('booking-modal-overlay').classList.remove('show');
            document.getElementById('booking-modal').classList.remove('show');
        };

        // Close modal on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeBookingModal();
            }
        });

        function getBookingWidgetHTML(lang) {
    return `
        <div class="booking-widget">
            <div class="booking-header">
                <div class="booking-credits">
                    <div class="credit-badge">
                        <i class="fas fa-ticket-alt"></i>
                        <span>${lang === 'ja' ? '利用可能' : 'Available'}: <span class="credit-number" id="${lang}-credits-count">0</span></span>
                    </div>
                    <div class="consultation-badge" id="${lang}-consultation-badge" style="display: none;">
                        <i class="fas fa-gift"></i>
                        <span>${lang === 'ja' ? '無料相談' : 'Free Consultation'}</span>
                    </div>
                </div>
            </div>
            
            <div class="calendar-container">
                <div class="calendar-picker">
                    <div class="calendar-month-nav">
                        <button class="calendar-nav-btn" id="${lang}-calendar-prev">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <h3 id="${lang}-calendar-month">2026年 1月</h3>
                        <button class="calendar-nav-btn" id="${lang}-calendar-next">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    <div class="calendar-grid" id="${lang}-calendar-grid"></div>
                </div>
                
                <div class="time-slots-container">
                    <div class="selected-date-display" id="${lang}-selected-date">
                        ${lang === 'ja' ? '日付を選択してください' : 'Select a date'}
                    </div>
                    <div id="${lang}-time-slots"></div>
                </div>
            </div>
            
            <div class="booking-actions">
                <div class="lesson-type-selector">
                    <label for="${lang}-lesson-type">${lang === 'ja' ? 'レッスンタイプ:' : 'Lesson Type:'}</label>
                    <select id="${lang}-lesson-type">
                        <option value="standard">${lang === 'ja' ? '50分 スタンダードレッスン' : '50-min Standard Lesson'}</option>
                        <option value="consultation">${lang === 'ja' ? '20分 無料相談（初回のみ）' : '20-min Free Consultation (First-time)'}</option>
                    </select>
                </div>
                
                <div class="booking-summary" id="${lang}-booking-summary"></div>
                
                <!-- 🆕 MOVED POLICY NOTICE HERE -->
                <div class="booking-policy-notice">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>${lang === 'ja' ? '予約ポリシー：' : 'Booking Policy:'}</strong>
                        <ul>
                            <li>✅ <strong>${lang === 'ja' ? 'レッスンの24時間前まで' : '>24 hours before'}</strong>${lang === 'ja' ? 'なら無料でキャンセル・変更可能' : ': Free cancellation/reschedule'}</li>
                            <li>❌ <strong>${lang === 'ja' ? '24時間前を切ると' : '<24 hours before'}</strong>${lang === 'ja' ? 'クレジットの返金なし' : ': No credit refund'}</li>
                            <li>❌ <strong>${lang === 'ja' ? '無断欠席の場合' : 'No-shows'}</strong>${lang === 'ja' ? 'もクレジットは消費されます' : ': Credit is not refunded'}</li>
                            <li>⏰ <strong>${lang === 'ja' ? '準備：' : 'Preparation:'}</strong>${lang === 'ja' ? 'レッスン5分前までに準備し、カメラ・マイクをテストしてください' : ' Please be ready 5 minutes early and test your camera/microphone'}</li>
                        </ul>
                    </div>
                </div>
                
                <button class="book-lesson-btn" id="${lang}-book-btn" disabled>
                    <i class="fas fa-calendar-check"></i> ${lang === 'ja' ? 'レッスンを予約' : 'Book Lesson'}
                </button>
            </div>
        </div>
    `;
}

        async function initializeBookingWidget(studentId, userId) {
    console.log('🎯 Initializing booking widget...', { studentId, userId });
    
    bookingState.studentId = studentId;
    bookingState.userId = userId;
    
    await fetchBookingEligibility(studentId, 'ja');
    await fetchBookingEligibility(studentId, 'en');
    
    await fetchUserBookings(userId, 'ja');
    await fetchUserBookings(userId, 'en');
    
    // 🆕 Initialize lessons card on dashboard load
    initializeEnhancedLessonsCard();

    console.log('✅ Booking widget initialized');
}

        async function fetchBookingEligibility(studentId, lang) {
    try {
        const { data, error } = await supabase
            .rpc('check_booking_eligibility', {
                p_student_id: studentId,
                p_lesson_type: 'standard'
            });
        
        if (error) throw error;
        
        bookingState.availableCredits = data.availableCredits || 0;
        bookingState.eligibleForConsultation = data.eligibleForConsultation || false;
        
        console.log('Credits:', bookingState.availableCredits);
        console.log('Consultation eligible:', bookingState.eligibleForConsultation);
        
        // 🆕 UPDATE UI ELEMENTS
        const creditsElement = document.getElementById(`${lang}-credits-count`);
        if (creditsElement) {
            creditsElement.textContent = bookingState.availableCredits;
        }
        
        const consultBadge = document.getElementById(`${lang}-consultation-badge`);
        if (consultBadge) {
            consultBadge.style.display = bookingState.eligibleForConsultation ? 'flex' : 'none';
        }
        
    } catch (err) {
        console.error('Error fetching eligibility:', err);
    }
}

        async function fetchUserBookings(userId, lang) {
    console.log(`📚 Fetching bookings for user: ${userId}`);
    
    try {
        const { data: bookings, error } = await supabase
            .from('lesson_bookings')
            .select(`
                id,
                scheduled_at,
                duration_minutes,
                lesson_type,
                google_meet_link,
                google_calendar_event_id,
                status
            `)
            .eq('user_id', userId)
            .eq('status', 'scheduled')
            .order('scheduled_at', { ascending: true });

        if (error) throw error;

        bookingState.userBookings = bookings || [];
        
        console.log(`✅ Fetched ${bookingState.userBookings.length} bookings`);
        console.log('📋 Bookings:', bookingState.userBookings);

        renderUserBookings(lang);

    } catch (err) {
        console.error('❌ Error fetching bookings:', err);
    }
}



        function renderCalendar(lang) {
            const month = bookingState.currentMonth;
            const year = month.getFullYear();
            const monthIndex = month.getMonth();
            
            const monthNames = lang === 'ja' 
                ? ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月']
                : ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            const monthLabel = document.getElementById(`${lang}-calendar-month`);
if (!monthLabel) {
    console.warn(`Missing calendar month label: ${lang}-calendar-month`);
    return;
}

monthLabel.textContent =
    lang === 'ja'
        ? `${year}年 ${monthNames[monthIndex]}`
        : `${monthNames[monthIndex]} ${year}`;

            
            const calendarGrid = document.getElementById(`${lang}-calendar-grid`);
            if (!calendarGrid) return;
            
            calendarGrid.innerHTML = '';
            
            const dayHeaders = lang === 'ja' 
                ? ['日', '月', '火', '水', '木', '金', '土']
                : ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                calendarGrid.appendChild(header);
            });
            
            const firstDay = new Date(year, monthIndex, 1).getDay();
            const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, monthIndex, 0).getDate();
            
            // TIMEZONE FIX: Get today in local timezone
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.textContent = daysInPrevMonth - i;
                calendarGrid.appendChild(day);
            }
            
            for (let date = 1; date <= daysInMonth; date++) {
                const dayDate = new Date(year, monthIndex, date);
                dayDate.setHours(0, 0, 0, 0);
                
                const day = document.createElement('div');
                day.className = 'calendar-day';
                day.textContent = date;
                
                // TIMEZONE FIX: Store date as YYYY-MM-DD (no time component)
                day.dataset.date = `${year}-${String(monthIndex + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                
                if (dayDate.getTime() === today.getTime()) {
                    day.classList.add('today');
                }
                
                if (bookingState.selectedDate && day.dataset.date === bookingState.selectedDate) {
                    day.classList.add('selected');
                }
                
                if (dayDate < today) {
                    day.classList.add('disabled');
                }
                
                const dayOfWeek = dayDate.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    day.classList.add('disabled');
                }
                
                const hasBooking = bookingState.userBookings.some(booking => {
                    const bookingDate = new Date(booking.scheduled_at);
                    return bookingDate.toISOString().split('T')[0] === day.dataset.date;
                });
                
                if (hasBooking) {
                    day.classList.add('has-booking');
                }
                
                if (!day.classList.contains('disabled')) {
                    day.addEventListener('click', () => selectDate(day.dataset.date, lang));
                }
                
                calendarGrid.appendChild(day);
            }
            
            const totalCells = calendarGrid.children.length - 7;
            const remainingCells = 42 - totalCells;
            for (let date = 1; date <= remainingCells; date++) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.textContent = date;
                calendarGrid.appendChild(day);
            }
            
            const prevBtn = document.getElementById(`${lang}-calendar-prev`);
            if (prevBtn) {
                const currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                prevBtn.disabled = month.getTime() <= currentMonth.getTime();
            }
        }

        async function selectDate(dateStr, lang) {
    console.log('📅 Selected date:', dateStr);
    
    bookingState.selectedDate = dateStr;
    bookingState.selectedTime = null;
    
    renderCalendar(lang);
    
    // TIMEZONE FIX: Parse date as local date
    const [year, month, day] = dateStr.split('-').map(Number);
    const date = new Date(year, month - 1, day);
    
    const dateDisplay = lang === 'ja'
        ? `${year}年${month}月${day}日 (${['日', '月', '火', '水', '木', '金', '土'][date.getDay()]})`
        : date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    
    const displayElement = document.getElementById(`${lang}-selected-date`);
    if (displayElement) {
        displayElement.textContent = dateDisplay;
    }
    
    await fetchAvailableSlots(dateStr, lang);
    
    // 🆕 AUTO-SCROLL TO TIME SLOTS
    setTimeout(() => {
        const timeSlotsContainer = document.getElementById(`${lang}-time-slots`);
        if (timeSlotsContainer) {
            timeSlotsContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }, 300);
}

        async function fetchAvailableSlots(dateStr, lang) {
            const slotsContainer = document.getElementById(`${lang}-time-slots`);
            if (!slotsContainer) return;
            
            slotsContainer.innerHTML = '<div class="time-slots-loading"><i class="fas fa-spinner fa-spin"></i><p>読み込み中...</p></div>';
            
            try {
                console.log('🔍 Fetching available slots for:', dateStr);
                
                const response = await fetch('https://luyzyzefgintksydmwoh.supabase.co/functions/v1/lesson-booking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${(await supabase.auth.getSession()).data.session.access_token}`
                    },
                    body: JSON.stringify({
                        action: 'getAvailableSlots',
                        bookingData: {
                            date: dateStr
                        }
                    })
                });
                
                const result = await response.json();
                console.log('📥 Slots response:', result);
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch slots');
                }
                
                bookingState.availableSlots = result.slots || [];
                
                renderTimeSlots(lang);
                
            } catch (err) {
                console.error('❌ Error fetching slots:', err);
                slotsContainer.innerHTML = `
                    <div class="no-slots-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>${lang === 'ja' ? 'スロットの読み込みに失敗しました' : 'Failed to load time slots'}</p>
                        <p style="font-size: 0.85rem; color: var(--color-text-muted);">${err.message}</p>
                    </div>
                `;
            }
        }

        function renderTimeSlots(lang) {
            const slotsContainer = document.getElementById(`${lang}-time-slots`);
            if (!slotsContainer) return;
            
            if (bookingState.availableSlots.length === 0) {
                slotsContainer.innerHTML = `
                    <div class="no-slots-message">
                        <i class="fas fa-calendar-times"></i>
                        <p>${lang === 'ja' ? 'この日は空き時間がありません' : 'No available slots for this date'}</p>
                    </div>
                `;
                return;
            }
            
            const morning = bookingState.availableSlots.filter(s => {
                const hour = parseInt(s.display.split(':')[0]);
                return hour < 12;
            });
            
            const afternoon = bookingState.availableSlots.filter(s => {
                const hour = parseInt(s.display.split(':')[0]);
                return hour >= 12 && hour < 18;
            });
            
            const evening = bookingState.availableSlots.filter(s => {
                const hour = parseInt(s.display.split(':')[0]);
                return hour >= 18;
            });
            
            let html = '<div class="time-slots">';
            
            if (morning.length > 0) {
                html += `
                    <div class="time-period">
                        <h4>${lang === 'ja' ? '午前' : 'Morning'}</h4>
                        <div class="time-slots-grid">
                            ${morning.map(slot => `
                                <div class="time-slot" data-time="${slot.time}" onclick="selectTimeSlot('${slot.time}', '${lang}')">
                                    ${slot.display}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (afternoon.length > 0) {
                html += `
                    <div class="time-period">
                        <h4>${lang === 'ja' ? '午後' : 'Afternoon'}</h4>
                        <div class="time-slots-grid">
                            ${afternoon.map(slot => `
                                <div class="time-slot" data-time="${slot.time}" onclick="selectTimeSlot('${slot.time}', '${lang}')">
                                    ${slot.display}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (evening.length > 0) {
                html += `
                    <div class="time-period">
                        <h4>${lang === 'ja' ? '夜' : 'Evening'}</h4>
                        <div class="time-slots-grid">
                            ${evening.map(slot => `
                                <div class="time-slot" data-time="${slot.time}" onclick="selectTimeSlot('${slot.time}', '${lang}')">
                                    ${slot.display}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            slotsContainer.innerHTML = html;
        }

        window.selectTimeSlot = function(timeStr, lang) {
            console.log('⏰ Selected time:', timeStr);
            
            bookingState.selectedTime = timeStr;
            
            document.querySelectorAll(`#${lang}-time-slots .time-slot`).forEach(slot => {
                slot.classList.remove('selected');
            });
            
            const selectedSlot = document.querySelector(`#${lang}-time-slots .time-slot[data-time="${timeStr}"]`);
            if (selectedSlot) {
                selectedSlot.classList.add('selected');
            }
            
            updateBookingSummary(lang);
            
            const bookBtn = document.getElementById(`${lang}-book-btn`);
            if (bookBtn) {
                bookBtn.disabled = false;
            }
        };

        function updateBookingSummary(lang) {
    const lessonType = bookingState.selectedLessonType;
    const summaryContainer = document.getElementById(`${lang}-booking-summary`);
    if (!summaryContainer) return;
    
    let duration, price, useCredit;
    
    if (lessonType === 'consultation') {
        duration = 20;
        price = 0;
        useCredit = false;
    } else {
        duration = 50;
        if (bookingState.availableCredits > 0) {
            price = 0;
            useCredit = true;
        } else {
            price = 4000;
            useCredit = false;
        }
    }
    
    const dateTime = new Date(bookingState.selectedTime);
    
    const html = `
        <div class="booking-summary-item">
            <span class="booking-summary-label">${lang === 'ja' ? '日時' : 'Date & Time'}:</span>
            <span class="booking-summary-value">${dateTime.toLocaleString(lang === 'ja' ? 'ja-JP' : 'en-US')}</span>
        </div>
        <div class="booking-summary-item">
            <span class="booking-summary-label">${lang === 'ja' ? '時間' : 'Duration'}:</span>
            <span class="booking-summary-value">${duration} ${lang === 'ja' ? '分' : 'minutes'}</span>
        </div>
        <div class="booking-summary-item">
            <span class="booking-summary-label">${lang === 'ja' ? '料金' : 'Price'}:</span>
            <span class="booking-summary-value ${price === 0 ? 'free' : 'paid'}">
                ${price === 0 
                    ? (lang === 'ja' ? '無料' : 'FREE') + (useCredit ? ` (${lang === 'ja' ? 'クレジット使用' : 'Using Credit'})` : '') 
                    : `¥${price.toLocaleString()}`}
            </span>
        </div>
    `;
    
    summaryContainer.innerHTML = html;
    
    // 🆕 AUTO-SCROLL TO LESSON TYPE SECTION
    setTimeout(() => {
        const bookingActions = document.querySelector('.booking-actions');
        if (bookingActions) {
            bookingActions.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }, 200);
}

        async function bookLesson(lang) {
            const btn = document.getElementById(`${lang}-book-btn`);
            if (!btn) return;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + (lang === 'ja' ? '予約中...' : 'Booking...');
            
            try {
                const lessonType = bookingState.selectedLessonType === 'consultation' ? 'first_time_free' : 'standard';
                
                console.log('📤 Booking lesson:', {
                    studentId: bookingState.studentId,
                    scheduledAt: bookingState.selectedTime,
                    lessonType: lessonType,
                    duration: bookingState.selectedLessonType === 'consultation' ? 20 : 50
                });
                
                const response = await fetch('https://luyzyzefgintksydmwoh.supabase.co/functions/v1/lesson-booking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${(await supabase.auth.getSession()).data.session.access_token}`
                    },
                    body: JSON.stringify({
                        action: 'create',
                        bookingData: {
                            studentId: bookingState.studentId,
                            scheduledAt: bookingState.selectedTime,
                            lessonType: lessonType,
                            duration: bookingState.selectedLessonType === 'consultation' ? 20 : 50
                        }
                    })
                });
                
                const result = await response.json();
                console.log('📥 Booking response:', result);
                
                if (!result.success) {
                    throw new Error(result.error || 'Booking failed');
                }
                
                alert(lang === 'ja' 
    ? '予約が完了しました！レッスンカードで詳細を確認できます。' 
    : 'Booking confirmed! Your lesson appears in the Upcoming Lessons card below.');
                // Start auto-refresh for Meet link
if (result.booking && result.booking.google_calendar_event_id) {
    console.log('🔄 Starting auto-refresh for Meet link...');
    meetLinkRefresh.start(
        result.booking.id,
        result.booking.google_calendar_event_id
    );
}
                bookingState.selectedDate = null;
                bookingState.selectedTime = null;
                
                await fetchBookingEligibility(bookingState.studentId, lang);
await fetchUserBookings(bookingState.userId, lang);

// 🆕 UPDATE DASHBOARD CARD
initializeEnhancedLessonsCard();

closeBookingModal();
                
            } catch (err) {
                console.error('❌ Booking error:', err);
                alert(lang === 'ja' ? `予約エラー: ${err.message}` : `Booking error: ${err.message}`);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-calendar-check"></i> ' + (lang === 'ja' ? 'レッスンを予約' : 'Book Lesson');
            }
        }

        function renderUserBookings(lang) {
    const container = document.getElementById(`${lang}-bookings-list`);
    if (!container) return;

    if (bookingState.userBookings.length === 0) {
        container.innerHTML = `
            <div class="no-bookings">
                <i class="fas fa-calendar-alt"></i>
                <p>${lang === 'ja' ? '予約がありません' : 'No upcoming bookings'}</p>
            </div>
        `;
        return;
    }

    const html = bookingState.userBookings.map(booking => {
        const date = new Date(booking.scheduled_at);

        const dateStr = date.toLocaleDateString(
            lang === 'ja' ? 'ja-JP' : 'en-US',
            { weekday: 'short', month: 'short', day: 'numeric' }
        );

        const timeStr = date.toLocaleTimeString(
            lang === 'ja' ? 'ja-JP' : 'en-US',
            { hour: '2-digit', minute: '2-digit' }
        );

        const typeLabel =
            booking.lesson_type === 'first_time_free'
                ? (lang === 'ja' ? '無料相談' : 'Free Consultation')
                : (lang === 'ja' ? 'レッスン' : 'Lesson');

        return `
            <div class="booking-item">
                <div class="booking-info">
                    <div class="booking-date">${dateStr}</div>
                    <div class="booking-time">
                        ${timeStr} (${booking.duration_minutes} ${lang === 'ja' ? '分' : 'min'})
                    </div>
                    <span class="booking-type">${typeLabel}</span>
                </div>

                <div class="booking-actions-btns">
                    ${
                        booking.google_meet_link
                            ? `
                                <a
                                    href="${booking.google_meet_link}"
                                    target="_blank"
                                    class="booking-action-btn meet-btn"
                                >
                                    ${lang === 'ja' ? 'Google Meet に参加' : 'Join Google Meet'}
                                </a>
                              `
                            : ''
                    }

                    <button
                        class="booking-action-btn cancel-btn"
                        onclick="cancelBooking('${booking.id}', '${lang}')"
                    >
                        ${lang === 'ja' ? 'キャンセル' : 'Cancel'}
                    </button>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = html;
}

            
            
        

        window.cancelBooking = async function(bookingId, lang) {
            const confirmMsg = lang === 'ja'
                ? 'この予約をキャンセルしてもよろしいですか？'
                : 'Are you sure you want to cancel this booking?';
            
            if (!confirm(confirmMsg)) return;
            
            const reasonMsg = lang === 'ja'
                ? 'キャンセル理由を入力してください（任意）：'
                : 'Cancellation reason (optional):';
            
            const reason = prompt(reasonMsg) || 'No reason provided';
            
            try {
                const response = await fetch('https://luyzyzefgintksydmwoh.supabase.co/functions/v1/lesson-booking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${(await supabase.auth.getSession()).data.session.access_token}`
                    },
                    body: JSON.stringify({
                        action: 'cancel',
                        bookingData: {
                            bookingId: bookingId,
                            reason: reason
                        }
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Cancellation failed');
                }
                
                alert(lang === 'ja' ? 'キャンセルしました。' + (result.refund || '') : 'Booking cancelled. ' + (result.refund || ''));
                
                await fetchBookingEligibility(bookingState.studentId, lang);
                await fetchUserBookings(bookingState.userId, lang);
                renderCalendar(lang);
                
            } catch (err) {
                console.error('Cancellation error:', err);
                alert(lang === 'ja' ? `キャンセルエラー: ${err.message}` : `Cancellation error: ${err.message}`);
            }
        };

        function setupBookingEventListeners(lang) {
            const prevBtn = document.getElementById(`${lang}-calendar-prev`);
            const nextBtn = document.getElementById(`${lang}-calendar-next`);
            const lessonTypeSelect = document.getElementById(`${lang}-lesson-type`);
            const bookBtn = document.getElementById(`${lang}-book-btn`);
            
            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    bookingState.currentMonth.setMonth(bookingState.currentMonth.getMonth() - 1);
                    renderCalendar(lang);
                });
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    bookingState.currentMonth.setMonth(bookingState.currentMonth.getMonth() + 1);
                    renderCalendar(lang);
                });
            }
            
            if (lessonTypeSelect) {
                lessonTypeSelect.addEventListener('change', (e) => {
                    bookingState.selectedLessonType = e.target.value;
                    if (bookingState.selectedTime) {
                        updateBookingSummary(lang);
                    }
                 });
            }
            
            if (bookBtn) {
                bookBtn.addEventListener('click', () => bookLesson(lang));
            }
        }

        console.log('🎉 Phase 1 Dashboard Ready!');
      // ================================
// ENHANCED UPCOMING LESSONS CARD
// Features: Google Meet button, countdown timer, expand/collapse, cancel/reschedule
// ================================

// State management
const lessonsCardState = {
    expanded: false,
    updateInterval: null
};

// Format date/time (bilingual)
function formatLessonDateTime(scheduledAt, lang = 'en') {
    const date = new Date(scheduledAt);
    const options = { 
        weekday: 'short', 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: lang === 'en'
    };
    return date.toLocaleString(lang === 'ja' ? 'ja-JP' : 'en-US', options);
}

// Calculate time until lesson (bilingual)
function getTimeUntilLesson(scheduledAt, lang = 'en') {
    const now = new Date();
    const lessonTime = new Date(scheduledAt);
    const diff = lessonTime - now;
    
    if (diff < 0) return lang === 'ja' ? '過去' : 'Past';
    
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const days = Math.floor(hours / 24);
    
    if (lang === 'ja') {
        if (days > 1) return `${days}日後`;
        if (days === 1) return '明日';
        if (hours === 0) return `${minutes}分後`;
        return `${hours}時間${minutes}分後`;
    } else {
        if (days > 1) return `In ${days} days`;
        if (days === 1) return 'Tomorrow';
        if (hours === 0) return `In ${minutes}m`;
        return `In ${hours}h ${minutes}m`;
    }
}

// Check if lesson is within 24 hours
function isWithin24Hours(scheduledAt) {
    const now = new Date();
    const lessonTime = new Date(scheduledAt);
    const diff = lessonTime - now;
    const hours = diff / (1000 * 60 * 60);
    return hours > 0 && hours <= 24;
}

// Check if lesson is within 1 hour
function isWithin1Hour(scheduledAt) {
    const now = new Date();
    const lessonTime = new Date(scheduledAt);
    const diff = lessonTime - now;
    const hours = diff / (1000 * 60 * 60);
    return hours > 0 && hours <= 1;
}

// Render upcoming lessons card
function renderUpcomingLessonsCard(lessons, lang) {  // ← ADD lang parameter
    const card = document.getElementById(`${lang}-upcoming-lessons-card`);  // ← Use lang
    if (!card) return;
    
    const container = document.getElementById(`${lang}-upcoming-lessons`);  // ← Use lang
    if (!container) return;
    
    // 🆕 FILTER: Hide lessons that ended >60 min ago
    const now = new Date();
    const visibleLessons = (lessons || []).filter(lesson => {
        const lessonEnd = new Date(lesson.scheduled_at);
        lessonEnd.setMinutes(lessonEnd.getMinutes() + lesson.duration_minutes + 60); // +60 min buffer
        return lessonEnd > now;
    });
    
    if (visibleLessons.length === 0) {
        card.style.display = 'none';
        return;
    }
    
    card.style.display = 'block';
    
    const nextLesson = visibleLessons[0];
    const hasMoreLessons = visibleLessons.length > 1;
    
    container.innerHTML = `
        <div class="lessons-container">
            ${renderLessonCard(nextLesson, true, lang)}
            
            ${hasMoreLessons ? `
                <div class="lessons-more ${lessonsCardState.expanded ? 'expanded' : ''}">
                    ${visibleLessons.slice(1).map(lesson => renderLessonCard(lesson, false, lang)).join('')}
                </div>
                
                <button class="toggle-lessons-btn" onclick="toggleLessonsExpanded()">
                    <i class="fas fa-chevron-${lessonsCardState.expanded ? 'up' : 'down'}"></i>
                    ${lessonsCardState.expanded 
                        ? (lang === 'ja' ? '少なく表示' : 'Show Less')
                        : (lang === 'ja' ? `すべて表示 (${visibleLessons.length})` : `View All Lessons (${visibleLessons.length})`)}
                </button>
            ` : ''}
            
            <div class="book-another-divider"></div>
            
            <button onclick="openBookingModal('${lang}')" class="book-another-btn">
                <i class="fas fa-plus-circle"></i> ${visibleLessons.length > 0 
                    ? (lang === 'ja' ? '別のレッスンを予約' : 'Book Another Lesson')
                    : (lang === 'ja' ? '最初のレッスンを予約' : 'Book Your First Lesson')}
            </button>
        </div>
    `;
}

// Toggle expand/collapse
function toggleLessonsExpanded() {
    lessonsCardState.expanded = !lessonsCardState.expanded;
    
    // Get current language
    const lang = getCurrentLang();
    
    // Toggle both language versions
    ['ja', 'en'].forEach(l => {
        const moreSection = document.querySelector(`#${l}-upcoming-lessons .lessons-more`);
        if (moreSection) {
            if (lessonsCardState.expanded) {
                moreSection.classList.add('expanded');
            } else {
                moreSection.classList.remove('expanded');
            }
        }
    });
    
    // Update button text
    const toggleBtn = document.querySelector('.toggle-lessons-btn');
    if (toggleBtn) {
        const totalLessons = bookingState.userBookings.length;
        const lang = getCurrentLang();
        toggleBtn.innerHTML = lessonsCardState.expanded 
            ? `<i class="fas fa-chevron-up"></i> ${lang === 'ja' ? '少なく表示' : 'Show Less'}`
            : `<i class="fas fa-chevron-down"></i> ${lang === 'ja' ? `すべて表示 (${totalLessons})` : `View All Lessons (${totalLessons})`}`;
    }
}

// Cancel lesson
async function cancelLesson(lessonId, lang = 'en') {  // ← ADD lang parameter with default
    // Find the lesson
    const lesson = bookingState.userBookings.find(b => b.id === lessonId);
    if (!lesson) return;
    
    const now = new Date();
    const lessonStart = new Date(lesson.scheduled_at);
    const hoursUntilStart = (lessonStart - now) / (1000 * 60 * 60);
    
    // Check if it's too late to cancel with refund
    let confirmMsg = lang === 'ja' 
        ? 'このレッスンをキャンセルしてもよろしいですか？' 
        : 'Are you sure you want to cancel this lesson?';
    
    if (hoursUntilStart < 24) {
        confirmMsg = lang === 'ja'
            ? '⚠️ 24時間前を切っているため、クレジットは返金されません。\n\nキャンセルしてもよろしいですか？'
            : '⚠️ Cancelling less than 24 hours before the lesson means NO REFUND.\n\nYour credit will NOT be restored. Are you sure you want to cancel?';
    } else {
        confirmMsg = lang === 'ja'
            ? 'このレッスンをキャンセルしますか？\n\n✅ クレジットは返金されます（24時間前まで）'
            : 'Cancel this lesson?\n\n✅ Your credit will be refunded.';
    }
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    try {
        const response = await fetch('https://luyzyzefgintksydmwoh.supabase.co/functions/v1/lesson-booking', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${(await supabase.auth.getSession()).data.session.access_token}`
            },
            body: JSON.stringify({
                action: 'cancel',
                bookingData: {
                    bookingId: lessonId,
                    reason: lang === 'ja' ? 'ダッシュボードからキャンセル' : 'Cancelled from dashboard'
                }
            })
        });
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || (lang === 'ja' ? 'キャンセルに失敗しました' : 'Cancellation failed'));
        }
        
        // Show appropriate message based on refund status
        if (result.refundMessage) {
            alert('✅ ' + result.refundMessage);
        } else if (hoursUntilStart < 24) {
            alert(lang === 'ja' 
                ? 'レッスンをキャンセルしました。返金はありません（24時間前以降）。'
                : 'Lesson cancelled. No refund issued (<24h notice).');
        } else {
            alert(lang === 'ja'
                ? 'レッスンをキャンセルしました。クレジットは返金されました。'
                : 'Lesson cancelled successfully. Your credit has been refunded.');
        }
        
        // Refresh everything
        await fetchBookingEligibility(bookingState.studentId, lang);
        await fetchUserBookings(bookingState.userId, lang);
        initializeEnhancedLessonsCard();
        
    } catch (err) {
        console.error('Error cancelling lesson:', err);
        alert(lang === 'ja' 
            ? `キャンセルエラー: ${err.message}`
            : `Failed to cancel lesson: ${err.message}`);
    }
}

// Reschedule lesson
async function rescheduleLesson(lessonId, lang = 'en') {  // ← ADD lang parameter with default
    // Find the lesson
    const lesson = bookingState.userBookings.find(b => b.id === lessonId);
    if (!lesson) return;
    
    const now = new Date();
    const lessonStart = new Date(lesson.scheduled_at);
    const hoursUntilStart = (lessonStart - now) / (1000 * 60 * 60);
    
    let confirmMsg = lang === 'ja' ? 'このレッスンを変更しますか？' : 'Reschedule this lesson?';
    
    if (hoursUntilStart < 24) {
        confirmMsg = lang === 'ja'
            ? '⚠️ 24時間前を切っているため、クレジットは返金されません。\n\nこのレッスンのクレジットは消費されます。よろしいですか？'
            : '⚠️ Rescheduling less than 24 hours before means NO CREDIT REFUND.\n\nYou\'ll lose this lesson credit. Are you sure?';
    } else {
        confirmMsg = lang === 'ja'
            ? 'このレッスンを変更しますか？\n\n✅ クレジットは返金され、新しい時間を予約できます。'
            : 'Reschedule this lesson?\n\n✅ Your credit will be restored and you can book a new time.';
    }
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    try {
        const response = await fetch('https://luyzyzefgintksydmwoh.supabase.co/functions/v1/lesson-booking', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${(await supabase.auth.getSession()).data.session.access_token}`
            },
            body: JSON.stringify({
                action: 'cancel',
                bookingData: {
                    bookingId: lessonId,
                    reason: lang === 'ja' ? 'レッスン変更' : 'Rescheduling lesson'
                }
            })
        });
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || (lang === 'ja' ? '変更に失敗しました' : 'Cancellation failed'));
        }
        
        if (hoursUntilStart >= 24) {
            alert(lang === 'ja' 
                ? '✅ レッスンをキャンセルしました。クレジットは返金されました。新しい時間を選択してください。'
                : '✅ Lesson cancelled. Your credit has been restored. Please select a new time.');
        } else {
            alert(lang === 'ja'
                ? '⚠️ レッスンをキャンセルしました。クレジットは返金されません（24時間前以降）。必要に応じてサポートにお問い合わせください。'
                : '⚠️ Lesson cancelled. No credit refund (<24h notice). Contact support if you need assistance.');
        }
        
        // Refresh data
        await fetchBookingEligibility(bookingState.studentId, lang);
        await fetchUserBookings(bookingState.userId, lang);
        initializeEnhancedLessonsCard();
        
        // Open booking modal only if they got refund
        if (hoursUntilStart >= 24) {
            openBookingModal(lang);
        }
        
    } catch (err) {
        console.error('Error rescheduling lesson:', err);
        alert(lang === 'ja'
            ? `変更エラー: ${err.message}`
            : `Failed to reschedule lesson: ${err.message}`);
    }
}

// Start countdown update interval
function startCountdownUpdates() {
    if (lessonsCardState.updateInterval) {
        clearInterval(lessonsCardState.updateInterval);
    }
    
    lessonsCardState.updateInterval = setInterval(() => {
        const countdowns = document.querySelectorAll('.lesson-countdown');
        if (countdowns.length === 0) {
            clearInterval(lessonsCardState.updateInterval);
            lessonsCardState.updateInterval = null;
            return;
        }
        
        // Re-render to update countdowns
        if (bookingState.userBookings && bookingState.userBookings.length > 0) {
            renderUpcomingLessonsCard(bookingState.userBookings);
        }
    }, 60000); // Update every minute
}

// Initialize - call this after fetching bookings
function initializeEnhancedLessonsCard() {
    // 🆕 Render for BOTH languages
    renderUpcomingLessonsCard(bookingState.userBookings || [], 'ja');
    renderUpcomingLessonsCard(bookingState.userBookings || [], 'en');
    
    // Only start countdown if there are bookings
    if (bookingState.userBookings && bookingState.userBookings.length > 0) {
        startCountdownUpdates();
    }

    // Start auto-refresh for bookings without Meet links
    if (bookingState.userBookings) {
        bookingState.userBookings.forEach(booking => {
            if (!booking.google_meet_link && booking.google_calendar_event_id) {
                console.log(`🔄 Starting auto-refresh for existing booking ${booking.id}`);
                meetLinkRefresh.start(booking.id, booking.google_calendar_event_id);
            }
        });
    }
}

// Make functions globally available
window.toggleLessonsExpanded = toggleLessonsExpanded;
window.cancelLesson = cancelLesson;
window.rescheduleLesson = rescheduleLesson;
window.initializeEnhancedLessonsCard = initializeEnhancedLessonsCard;
      // ================================
// AUTO-REFRESH MEET LINKS SYSTEM
// Polls Google Calendar every 30 seconds to check for manually added Meet links
// ================================

const meetLinkRefresh = {
    intervals: new Map(),
    maxAttempts: 10,
    
    start(bookingId, eventId) {
        console.log(`🔄 Starting Meet link refresh for booking ${bookingId}`);
        
        if (this.intervals.has(bookingId)) {
            console.log(`⚠️ Already polling for booking ${bookingId}`);
            return;
        }
        
        let attempts = 0;
        
        const checkAndUpdate = async () => {
            attempts++;
            console.log(`🔍 Checking for Meet link (attempt ${attempts}/${this.maxAttempts})...`);
            
            try {
                const hasLink = await this.checkForMeetLink(bookingId, eventId);
                
                if (hasLink) {
                    console.log('✅ Meet link found! Stopping refresh.');
                    this.stop(bookingId);
                    
                    console.log('🔄 Refreshing UI...');
                    await fetchUserBookings(bookingState.userId, 'en');
                    console.log('📊 Bookings refreshed:', bookingState.userBookings.length);
                    initializeEnhancedLessonsCard();
                    console.log('✅ UI updated!');
                } else if (attempts >= this.maxAttempts) {
                    console.log('⏱️ Max attempts reached. Stopping refresh.');
                    this.stop(bookingId);
                }
            } catch (err) {
                console.error('❌ Error checking Meet link:', err);
            }
        };
        
        const intervalId = setInterval(checkAndUpdate, 30000);
        this.intervals.set(bookingId, intervalId);
        
        console.log('⚡ Running immediate check...');
        checkAndUpdate();
    },
    
    stop(bookingId) {
        const intervalId = this.intervals.get(bookingId);
        if (intervalId) {
            clearInterval(intervalId);
            this.intervals.delete(bookingId);
            console.log(`🛑 Stopped polling for booking ${bookingId}`);
        }
    },
    
    stopAll() {
        for (const [bookingId, intervalId] of this.intervals.entries()) {
            clearInterval(intervalId);
            console.log(`🛑 Stopped polling for booking ${bookingId}`);
        }
        this.intervals.clear();
    },
    
    async checkForMeetLink(bookingId, eventId) {
        console.log(`📡 Fetching event ${eventId} for booking ${bookingId}...`);
        
        try {
            const response = await fetch('https://luyzyzefgintksydmwoh.supabase.co/functions/v1/google-calendar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${(await supabase.auth.getSession()).data.session.access_token}`
                },
                body: JSON.stringify({
                    action: 'getEvent',
                    event_id: eventId,
                    booking_id: bookingId
                })
            });
            
            const result = await response.json();
            console.log('📥 Event fetch result:', result);
            
            if (result.success && result.meet_link) {
                console.log('📍 Meet link found:', result.meet_link);
                return true;
            }
            
            console.log('⚠️ No Meet link yet');
            return false;
            
        } catch (err) {
            console.error('❌ Error fetching event:', err);
            return false;
        }
    }
};

// Update the bookLesson function to start auto-refresh
// ADD THIS CODE INSIDE YOUR EXISTING bookLesson function, right after the booking succeeds:

/*
FIND THIS CODE IN bookLesson():
        if (!result.success) {
            throw new Error(result.error || 'Booking failed');
        }
        
        alert(...);

AND ADD THIS AFTER THE ALERT:

        // Start auto-refresh for Meet link
        if (result.booking && result.booking.google_calendar_event_id) {
            console.log('🔄 Starting auto-refresh for Meet link...');
            meetLinkRefresh.start(
                result.booking.id,
                result.booking.google_calendar_event_id
            );
        }

*/

// Update renderLessonCard to show "Meeting link loading" status

function renderLessonCard(lesson, isFirst = false, lang = 'en') { 
    const now = new Date();
    const lessonStart = new Date(lesson.scheduled_at);
    const lessonEnd = new Date(lessonStart.getTime() + lesson.duration_minutes * 60000);
    
    // Calculate time differences in minutes
    const minutesUntilStart = (lessonStart - now) / 60000;
    const minutesSinceEnd = (now - lessonEnd) / 60000;
    const hoursUntilStart = minutesUntilStart / 60;
    
    // Determine what to show
    const showMeetLink = minutesUntilStart <= 1440 && minutesSinceEnd <= 60 && lesson.google_meet_link;
    const showWaitingMessage = minutesUntilStart <= 1440 && !lesson.google_meet_link && lesson.google_calendar_event_id;
    const showReschedule = hoursUntilStart > 24; // >24h before
    const showCancel = minutesUntilStart > 60; // >1h before
    
    const within1h = minutesUntilStart > 0 && minutesUntilStart <= 60;
    
    // Status messages (bilingual)
    let statusBanner = '';
    if (minutesUntilStart < 0 && minutesSinceEnd < 0) {
        statusBanner = `<div class="lesson-status-banner in-progress"><i class="fas fa-circle"></i> ${
            lang === 'ja' ? 'レッスン進行中' : 'Lesson in progress'
        }</div>`;
    } else if (minutesSinceEnd > 0 && minutesSinceEnd <= 60) {
        statusBanner = `<div class="lesson-status-banner recently-ended"><i class="fas fa-info-circle"></i> ${
            lang === 'ja' ? 'レッスン終了 - Meetリンクはまだ利用可能' : 'Lesson ended recently - Meet link still available'
        }</div>`;
    } else if (!showCancel && !showReschedule) {
        statusBanner = `<div class="lesson-status-banner locked"><i class="fas fa-lock"></i> ${
            lang === 'ja' ? '変更不可 - サポートにお問い合わせください' : 'Too close to modify - contact support if needed'
        }</div>`;
    }
    
    const timeUntil = getTimeUntilLesson(lesson.scheduled_at, lang);
    const dateTime = formatLessonDateTime(lesson.scheduled_at, lang);
    
    return `
        <div class="lesson-item ${isFirst ? 'lesson-next' : ''}" data-lesson-id="${lesson.id}">
            ${statusBanner}
            
            <div class="lesson-info">
                <div class="lesson-datetime">
                    <i class="fas fa-calendar-alt"></i> ${dateTime}
                </div>
                <div class="lesson-countdown">
                    <i class="fas fa-clock"></i> ${timeUntil}
                </div>
            </div>
            
            <div class="lesson-actions">
                ${showMeetLink ? `
                    <button class="google-meet-btn ${within1h ? 'pulse' : ''}" 
                            onclick="window.open('${lesson.google_meet_link}', '_blank')"
                            title="${lang === 'ja' ? 'Google Meetに参加' : 'Join Google Meet'}">
                        <svg width="20" height="20" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                            <path fill="#4285F4" d="M45.12 24.5c0-1.56-.14-3.06-.4-4.5H24v8.51h11.84c-.51 2.75-2.06 5.08-4.39 6.64v5.52h7.11c4.16-3.83 6.56-9.47 6.56-16.17z"/>
                            <path fill="#34A853" d="M24 46c5.94 0 10.92-1.97 14.56-5.33l-7.11-5.52c-1.97 1.32-4.49 2.1-7.45 2.1-5.73 0-10.58-3.87-12.31-9.07H4.34v5.7C7.96 41.07 15.4 46 24 46z"/>
                            <path fill="#FBBC05" d="M11.69 28.18C11.25 26.86 11 25.45 11 24s.25-2.86.69-4.18v-5.7H4.34C2.85 17.09 2 20.45 2 24c0 3.55.85 6.91 2.34 9.88l7.35-5.7z"/>
                            <path fill="#EA4335" d="M24 10.75c3.23 0 6.13 1.11 8.41 3.29l6.31-6.31C34.91 4.18 29.93 2 24 2 15.4 2 7.96 6.93 4.34 14.12l7.35 5.7c1.73-5.2 6.58-9.07 12.31-9.07z"/>
                        </svg>
                        ${lang === 'ja' ? 'Google Meetに参加' : 'Join with Google Meet'}
                    </button>
                ` : showWaitingMessage ? `
                    <div class="meet-link-status">
                        <i class="fas fa-spinner fa-spin"></i>
                        ${lang === 'ja' ? 'Meetリンクは間もなく表示されます（自動更新中）' : 'Meet link will appear shortly (refreshing automatically)'}
                    </div>
                ` : ''}
                
                ${(showReschedule || showCancel) ? `
                    <div class="lesson-secondary-actions">
                        ${showReschedule ? `
                            <button class="lesson-action-btn reschedule-btn" 
        onclick="rescheduleLesson('${lesson.id}', '${lang}')"
                                    title="${lang === 'ja' ? 'レッスンを変更（24時間前まで無料）' : 'Reschedule lesson (free if >24h before)'}">
                                <i class="fas fa-calendar-edit"></i> ${lang === 'ja' ? '変更' : 'Reschedule'}
                            </button>
                        ` : ''}
                        
                        ${showCancel ? `
                            <button class="lesson-action-btn cancel-btn" 
        onclick="cancelLesson('${lesson.id}', '${lang}')"
                                    title="${lang === 'ja' ? 'レッスンをキャンセル（24時間前まで返金）' : 'Cancel lesson (refund if >24h before)'}">
                                <i class="fas fa-times-circle"></i> ${lang === 'ja' ? 'キャンセル' : 'Cancel'}
                            </button>
                        ` : ''}
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

// Start auto-refresh for existing bookings on page load
// ADD THIS TO initializeEnhancedLessonsCard():
/*
FIND THIS CODE:
function initializeEnhancedLessonsCard() {
    renderUpcomingLessonsCard(bookingState.userBookings || []);
    
    if (bookingState.userBookings && bookingState.userBookings.length > 0) {
        startCountdownUpdates();
    }
}

AND ADD THIS BEFORE THE CLOSING }:

    // Start auto-refresh for bookings without Meet links
    if (bookingState.userBookings) {
        bookingState.userBookings.forEach(booking => {
            if (!booking.google_meet_link && booking.google_calendar_event_id) {
                console.log(`🔄 Starting auto-refresh for existing booking ${booking.id}`);
                meetLinkRefresh.start(booking.id, booking.google_calendar_event_id);
            }
        });
    }
*/

// Clean up intervals when user leaves page
window.addEventListener('beforeunload', () => {
    meetLinkRefresh.stopAll();
});

console.log('✅ Auto-refresh Meet link system loaded');
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KLVF2ZG1WX"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-KLVF2ZG1WX');
</script>
  <meta charset="UTF-8">
  <title>Prokaiwa | Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Your Prokaiwa learning dashboard - track progress, access resources, and manage your English learning journey.">
  <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <!-- Chart.js for Pentagon Radar Chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* Dashboard-specific styles */
    /* Dashboard-specific container padding */
    #ja-dashboard-content,
    #en-dashboard-content {
      padding-bottom: 2rem; /* Ensures space at bottom of white container */
    }
    
    /* Reduce footer spacing for dashboard page */
    .site-footer {
      margin-top: 2rem; /* Reduced from default 4rem */
    }
    
    .dashboard-loading {
      text-align: center;
      padding: 4rem 2rem;
    }
    .dashboard-loading i {
      font-size: 2rem;
      color: var(--color-primary);
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .dashboard-error {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--color-text);
    }
    .dashboard-error i {
      font-size: 3rem;
      color: #dc3545;
      margin-bottom: 1rem;
    }
    .dashboard-error h2 {
      margin-bottom: 1rem;
    }
    .dashboard-error p {
      margin-bottom: 1.5rem;
      color: var(--color-text-light);
    }
    
    .welcome-banner {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: white;
      padding: 2rem;
      border-radius: var(--border-radius);
      margin-bottom: 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .welcome-banner h1 {
      font-size: 1.75rem;
      margin: 0 0 0.5rem 0;
      color: white;
    }
    .welcome-banner p {
      margin: 0;
      opacity: 0.9;
    }
    .welcome-stats {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
    }
    .welcome-stat {
      text-align: center;
    }
    .welcome-stat-value {
      font-size: 2rem;
      font-weight: 700;
      display: block;
    }
    .welcome-stat-label {
      font-size: 0.85rem;
      opacity: 0.9;
    }
    
    .practice-status-card {
      background: linear-gradient(135deg, #28a745 0%, #20863d 100%);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: var(--border-radius);
      margin-bottom: 2rem;
      text-align: center;
    }
    .practice-status-card.completed {
      background: linear-gradient(135deg, var(--color-gold) 0%, #b8860b 100%);
    }
    .practice-status-card h2 {
      color: white;
      margin: 0 0 0.25rem 0;
      font-size: 1.1rem;
    }
    .practice-status-card p {
      margin: 0;
      opacity: 0.95;
      font-size: 0.9rem;
    }
    .practice-status-icon {
      font-size: 2rem;
      margin-bottom: 0.25rem;
    }
    
    @media (max-width: 768px) {
      .practice-status-card {
        padding: 0.75rem 1.25rem; /* Even more compact on mobile */
        margin-bottom: 1.5rem;
      }
      .practice-status-card h2 {
        font-size: 1rem;
      }
      .practice-status-card p {
        font-size: 0.85rem;
      }
      .practice-status-icon {
        font-size: 1.5rem;
        margin-bottom: 0.2rem;
      }
    }
    
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .quick-action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1.25rem 1rem;
      background-color: var(--color-card-bg);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      text-decoration: none;
      color: var(--color-text);
      transition: all var(--transition-speed) ease;
      text-align: center;
      cursor: pointer;
    }
    .quick-action-btn:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-hover);
      border-color: var(--color-primary);
    }
    .quick-action-btn i {
      font-size: 1.5rem;
      color: var(--color-primary);
      margin-bottom: 0.5rem;
    }
    .quick-action-btn span {
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    /* Dashboard Grid - Custom layout using classes for reliability */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.5rem;
      /* Cards will align to tallest in row - looks more organized */
    }
    
    /* Row 1 & 2: Phrase (left), Skills (center - span 2 rows), Progress (right) */
    .card-skills {
      grid-column: 2 / 3;
      grid-row: 1 / 3;
      background: linear-gradient(135deg, rgba(0, 128, 128, 0.05) 0%, rgba(0, 128, 128, 0.02) 100%);
      border: 2px solid var(--color-primary);
      box-shadow: 0 8px 24px rgba(0, 128, 128, 0.15);
    }
    
    .card-phrase {
      grid-column: 1 / 2;
      grid-row: 1 / 2;
    }
    
    .card-progress {
      grid-column: 3 / 4;
      grid-row: 1 / 2;
    }
    
    .card-streak {
      grid-column: 1 / 2;
      grid-row: 2 / 3;
    }
    
    .card-achievements {
      grid-column: 3 / 4;
      grid-row: 2 / 3;
    }
    
    /* Row 3: Account Info (left), Upcoming Lessons (middle), Resources (right) */
    .card-account {
      grid-column: 1 / 2;
      grid-row: 3 / 4;
    }
    
    .card-lessons {
      grid-column: 2 / 3;
      grid-row: 3 / 4;
    }
    
    .card-resources {
      grid-column: 3 / 4;
      grid-row: 3 / 4;
    }
    
    /* Upgrade card spans all 3 columns */
    .card-upgrade {
      grid-column: 1 / 4;
      grid-row: 4 / 5;
    }
    
    .dashboard-card {
      background-color: var(--color-card-bg);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      padding: 1rem;
      transition: box-shadow var(--transition-speed) ease;
    }
    .dashboard-card:hover {
      box-shadow: var(--shadow);
    }
    .dashboard-card h3 {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.05rem;
      color: var(--color-accent);
      margin: 0 0 0.75rem 0;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--color-border);
    }
    .dashboard-card h3 i {
      color: var(--color-primary);
      font-size: 1rem;
    }
    
    /* Skills Chart - BIGGER pentagon without labels! */
    .skills-chart-container {
      position: relative;
      height: 420px;
      margin: 0;
      padding: 0.5rem 0 0.25rem 0; /* Reduced bottom padding */
    }
    .no-assessment-message {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--color-text-light);
    }
    .no-assessment-message i {
      font-size: 2.5rem;
      color: var(--color-primary);
      opacity: 0.5;
      margin-bottom: 0.5rem;
    }
    .no-assessment-message p {
      margin: 0.25rem 0;
      line-height: 1.4;
      font-size: 0.9rem;
    }
    .no-assessment-message p:first-of-type {
      font-weight: 600;
      font-size: 1rem;
    }
    .assessment-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0; /* Removed margin-top for tighter spacing */
      padding-top: 0.5rem;
      border-top: 1px solid var(--color-border);
      font-size: 0.85rem;
      color: var(--color-text-light);
    }
    .assessment-date {
      font-style: italic;
      font-size: 0.8rem;
    }
    .assessment-band {
      font-weight: 700;
      color: var(--color-primary);
      font-size: 0.95rem;
    }
    
    /* Learning Archetype Display */
    .learning-archetype {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-top: 0.75rem;
      padding: 0.75rem 1rem;
      background: linear-gradient(135deg, var(--color-primary-light) 0%, rgba(0, 128, 128, 0.05) 100%);
      border-left: 4px solid var(--color-primary);
      border-radius: 0 8px 8px 0;
    }
    .archetype-icon {
      font-size: 2rem;
      line-height: 1;
      flex-shrink: 0;
    }
    .archetype-content {
      flex: 1;
    }
    .archetype-name {
      font-weight: 700;
      font-size: 0.95rem;
      color: var(--color-primary-dark);
      margin-bottom: 0.25rem;
    }
    .archetype-description {
      font-size: 0.85rem;
      color: var(--color-text);
      line-height: 1.4;
    }
    
    .progress-ring-container {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 1rem;
    }
    .progress-ring {
      position: relative;
      width: 80px;
      height: 80px;
    }
    .progress-ring svg {
      transform: rotate(-90deg);
    }
    .progress-ring-bg {
      fill: none;
      stroke: var(--color-border);
      stroke-width: 8;
    }
    .progress-ring-fill {
      fill: none;
      stroke: var(--color-primary);
      stroke-width: 8;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.5s ease;
    }
    .progress-ring-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--color-text);
    }
    .progress-details h4 {
      margin: 0 0 0.25rem 0;
      color: var(--color-text);
    }
    .progress-details p {
      margin: 0;
      color: var(--color-text-light);
      font-size: 0.9rem;
    }
    
    .streak-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.4rem;
    }
    .streak-fire {
      font-size: 1.5rem;
    }
    .streak-count {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--color-text);
    }
    .streak-label {
      color: var(--color-text-light);
      font-size: 0.75rem;
    }
    /* Outer container that holds the calendar grid */
    .streak-calendar-container,
    #ja-streak-calendar,
    #en-streak-calendar {
      width: 100%;
      display: block;
    }
    .streak-calendar {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr)); /* minmax(0, 1fr) allows columns to shrink below content size */
      gap: 2px;
      width: 100%; /* Make grid fill full width */
      transition: max-height 0.3s ease;
      overflow-y: hidden; /* Only hide vertical overflow */
      overflow-x: visible; /* Allow horizontal content to show */
    }
    .streak-day-header {
      text-align: center;
      font-size: 0.55rem;
      color: var(--color-text-muted);
      padding: 1px;
      font-weight: 600;
      min-width: 0; /* Allow shrinking below content width */
    }
    .streak-day {
      aspect-ratio: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: var(--color-bg);
      border-radius: 3px;
      font-size: 0.6rem;
      color: var(--color-text-light);
      min-width: 0; /* Allow shrinking below content width */
      overflow: hidden; /* Prevent content from expanding cell */
    }
    .streak-day.active {
      background-color: var(--color-primary);
      color: white;
    }
    .streak-day.streak-hot {
      background-color: #E67E22; /* Orange for 3-6 day streaks */
      color: white;
      font-weight: 600;
    }
    .streak-day.streak-fire {
      background-color: #E74C3C; /* Fire red for 7+ day streaks */
      color: white;
      font-weight: 700;
      box-shadow: 0 0 8px rgba(231, 76, 60, 0.4);
    }
    .streak-day.today {
      border: 2px solid var(--color-gold);
    }
    .streak-day.future {
      opacity: 0.4;
    }
    
    .no-lessons {
      text-align: center;
      padding: 1.5rem;
      color: var(--color-text-light);
    }
    .no-lessons i {
      font-size: 1.75rem;
      margin-bottom: 0.4rem;
      opacity: 0.5;
    }
    .no-lessons p {
      margin: 0.5rem 0;
      font-size: 0.9rem;
    }
    
    .resource-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem;
      border-radius: 8px;
      transition: background-color var(--transition-speed) ease;
    }
    .resource-item:hover {
      background-color: var(--color-bg);
    }
    .resource-item i {
      font-size: 1.1rem;
      color: var(--color-primary);
      width: 25px;
      text-align: center;
    }
    .resource-item a {
      flex: 1;
      color: var(--color-text);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.9rem;
    }
    .resource-item a:hover {
      color: var(--color-primary);
    }
    .resource-item .coming-soon {
      color: var(--color-text-muted);
      font-style: italic;
      cursor: default;
    }
    .resource-item .coming-soon:hover {
      color: var(--color-text-muted);
    }
    .resource-tag {
      font-size: 0.65rem;
      padding: 0.15rem 0.4rem;
      background-color: var(--color-primary-light);
      color: var(--color-primary-dark);
      border-radius: 4px;
      text-transform: uppercase;
    }
    .resource-tag.coming {
      background-color: var(--color-bg);
      color: var(--color-text-muted);
    }
    
    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }
    .achievement {
      text-align: center;
      padding: 0.4rem;
    }
    .achievement-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 0.3rem;
      font-size: 1rem;
    }
    .achievement-icon.earned {
      background-color: var(--color-gold);
      color: white;
    }
    .achievement-icon.locked {
      background-color: var(--color-bg);
      color: var(--color-text-muted);
      opacity: 0.5;
    }
    .achievement-name {
      font-size: 0.7rem;
      color: var(--color-text-light);
      line-height: 1.1; /* Tighter line spacing for wrapped text */
      min-height: 2em; /* Reserve space for 2 lines to prevent jumping */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .achievement.locked .achievement-name {
      opacity: 0.5;
    }
    
    .plan-badge {
      display: inline-block;
      padding: 0.2rem 0.6rem;
      background-color: var(--color-primary);
      color: white;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
    }
    .plan-badge.pending {
      background-color: var(--color-gold);
    }
    .plan-badge.has-addon {
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-gold) 100%);
    }
    .addon-badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      background-color: var(--color-gold);
      color: white;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-left: 0.4rem;
    }
    .account-details {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .account-details li {
      padding: 0.4rem 0;
      border-bottom: 1px solid var(--color-border);
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
    }
    .account-details li:last-child {
      border-bottom: none;
    }
    .account-details strong {
      color: var(--color-text-light);
      font-weight: 500;
    }
    
    .upgrade-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-align: center;
    }
    .upgrade-card h3 {
      color: white;
      border-bottom-color: rgba(255,255,255,0.3);
    }
    .upgrade-card h3 i {
      color: white;
    }
    .upgrade-card p {
      margin-bottom: 1rem;
      opacity: 0.95;
    }
    .upgrade-card .cta-button {
      background: white;
      color: #667eea;
    }
    .upgrade-card .cta-button:hover {
      background: #f0f0f0;
      transform: translateY(-2px);
    }
    
    .tip-box {
      background-color: var(--color-primary-light);
      border-left: 4px solid var(--color-primary);
      padding: 0.75rem;
      border-radius: 0 8px 8px 0;
    }
    .tip-box p {
      margin: 0;
      font-size: 0.9rem;
    }
    .tip-box .tip-phrase {
      font-size: 1rem;
      font-weight: 600;
      color: var(--color-primary-dark);
      display: block;
      margin-top: 0.4rem;
    }
    
    @media (max-width: 1024px) {
      .dashboard-grid {
        grid-template-columns: 1fr 1fr;
      }
      
      /* Skills spans both columns at top */
      .card-skills {
        grid-column: 1 / 3;
        grid-row: 1 / 2;
      }
      
      /* Phrase and Progress side by side */
      .card-phrase {
        grid-column: 1 / 2;
        grid-row: 2 / 3;
      }
      
      .card-progress {
        grid-column: 2 / 3;
        grid-row: 2 / 3;
      }
      
      /* Streak and Achievements side by side */
      .card-streak {
        grid-column: 1 / 2;
        grid-row: 3 / 4;
      }
      
      .card-achievements {
        grid-column: 2 / 3;
        grid-row: 3 / 4;
      }
      
      /* Bottom 3 stack */
      .card-account {
        grid-column: 1 / 3;
        grid-row: 4 / 5;
      }
      
      .card-lessons {
        grid-column: 1 / 3;
        grid-row: 5 / 6;
      }
      
      .card-resources {
        grid-column: 1 / 3;
        grid-row: 6 / 7;
      }
      
      .card-upgrade {
        grid-column: 1 / 3;
      }
    }
    
    @media (max-width: 768px) {
      .welcome-banner {
        flex-direction: column;
        text-align: center;
        padding: 1.25rem 1.5rem; /* Reduced from 2rem */
      }
      .welcome-banner h1 {
        font-size: 1.4rem; /* Slightly smaller */
        margin-bottom: 0.25rem;
      }
      .welcome-banner p {
        font-size: 0.9rem; /* Slightly smaller */
        margin-bottom: 0.75rem;
      }
      .welcome-stats {
        justify-content: center;
        gap: 1.5rem; /* Reduced gap */
      }
      .welcome-stat-value {
        font-size: 1.5rem; /* Reduced from 2rem */
      }
      .welcome-stat-label {
        font-size: 0.75rem; /* Slightly smaller */
      }
      .quick-actions {
        grid-template-columns: repeat(2, 1fr);
      }
      .dashboard-grid {
        grid-template-columns: 1fr;
        padding-bottom: 1.5rem; /* Add bottom padding on mobile */
      }
      
      /* All cards stack in mobile */
      .card-skills,
      .card-phrase,
      .card-progress,
      .card-streak,
      .card-achievements,
      .card-account,
      .card-lessons,
      .card-resources,
      .card-upgrade {
        grid-column: 1;
        grid-row: auto;
      }
      
      .skills-chart-container {
        height: 300px;
      }
      
      /* Ensure proper spacing for dashboard content on mobile */
      #ja-dashboard-content,
      #en-dashboard-content {
        padding-bottom: 1.5rem;
      }
    }
    
    @media (prefers-color-scheme: dark) {
      .tip-box {
        background-color: var(--color-card-bg);
      }
      .resource-tag {
        background-color: var(--color-primary-dark);
        color: var(--color-primary-light);
      }
      .practice-status-card {
        background: linear-gradient(135deg, #1e7e34 0%, #155724 100%);
      }
      .practice-status-card.completed {
        background: linear-gradient(135deg, #b8860b 0%, #8b6914 100%);
      }
      .learning-archetype {
        background: linear-gradient(135deg, var(--color-card-bg) 0%, rgba(0, 168, 168, 0.1) 100%);
        border-left-color: var(--color-primary);
      }
      .archetype-name {
        color: var(--color-primary);
      }
      .archetype-description {
        color: var(--color-text-light);
      }
    }
    
    /* =============================================
   BOOKING MODAL STYLES
   ============================================= */

/* Modal Overlay */
.booking-modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 9998;
  animation: fadeIn 0.2s ease;
}

.booking-modal-overlay.show {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Modal Container */
.booking-modal {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 90%;
  max-width: 900px;
  max-height: 90vh;
  background: var(--color-card-bg);
  border-radius: var(--border-radius);
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  z-index: 9999;
  overflow: hidden;
  animation: slideUp 0.3s ease;
}

.booking-modal.show {
  display: flex;
  flex-direction: column;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translate(-50%, -40%);
  }
  to {
    opacity: 1;
    transform: translate(-50%, -50%);
  }
}

/* Modal Header */
.booking-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.5rem;
  border-bottom: 2px solid var(--color-border);
  background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
  color: white;
}

.booking-modal-header h2 {
  margin: 0;
  font-size: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.booking-modal-close {
  background: none;
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0.5rem;
  line-height: 1;
  transition: transform 0.2s;
}

.booking-modal-close:hover {
  transform: scale(1.2);
}

/* Modal Body */
.booking-modal-body {
  padding: 1.5rem;
  overflow-y: auto;
  flex: 1;
}

/* Booking Widget Styles (Compact for Modal) */
.booking-widget {
  background: transparent;
  border: none;
  padding: 0;
  margin: 0;
  box-shadow: none;
}

.booking-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid var(--color-border);
}

.booking-header h2 {
  margin: 0;
  color: var(--color-primary);
  font-size: 1.2rem;
  display: none; /* Hide since we have modal title */
}

.booking-credits {
  display: flex;
  gap: 1.5rem;
  align-items: center;
  width: 100%;
  justify-content: center;
}

.credit-badge {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: var(--color-primary-light);
  border-radius: 20px;
  font-weight: 600;
  color: var(--color-primary-dark);
}

.credit-badge i {
  font-size: 1.1rem;
}

.credit-number {
  font-size: 1.2rem;
  color: var(--color-primary);
}

.consultation-badge {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: var(--color-gold);
  border-radius: 20px;
  font-weight: 600;
  color: white;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}

/* Calendar Container */
.calendar-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 2rem;
  margin-top: 1rem;
}

/* Calendar (Left Side) */
.calendar-picker {
  display: flex;
  flex-direction: column;
}

.calendar-month-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.calendar-month-nav h3 {
  margin: 0;
  font-size: 1.1rem;
  color: var(--color-text);
}

.calendar-nav-btn {
  background: var(--color-primary);
  color: white;
  border: none;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.calendar-nav-btn:hover {
  background: var(--color-primary-dark);
  transform: scale(1.1);
}

.calendar-nav-btn:disabled {
  background: var(--color-border);
  cursor: not-allowed;
  transform: none;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 4px;
}

.calendar-day-header {
  text-align: center;
  font-size: 0.75rem;
  font-weight: 600;
  color: var(--color-text-muted);
  padding: 0.5rem 0;
}

.calendar-day {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s;
  border: 2px solid transparent;
}

.calendar-day:hover:not(.disabled):not(.other-month) {
  background: var(--color-primary-light);
  transform: scale(1.05);
}

.calendar-day.other-month {
  color: var(--color-text-muted);
  opacity: 0.3;
}

.calendar-day.today {
  border-color: var(--color-gold);
  font-weight: 700;
}

.calendar-day.selected {
  background: var(--color-primary);
  color: white;
  font-weight: 700;
}

.calendar-day.disabled {
  color: var(--color-text-muted);
  opacity: 0.3;
  cursor: not-allowed;
}

.calendar-day.has-booking {
  background: var(--color-success);
  color: white;
  position: relative;
}

.calendar-day.has-booking::after {
  content: '‚Ä¢';
  position: absolute;
  bottom: 2px;
  font-size: 1.5rem;
}

/* Time Slots (Right Side) */
.time-slots-container {
  display: flex;
  flex-direction: column;
}

.selected-date-display {
  font-size: 1rem;
  font-weight: 600;
  color: var(--color-text);
  margin-bottom: 1rem;
  padding: 0.75rem;
  background: var(--color-bg);
  border-radius: 8px;
  text-align: center;
}

.time-slots-loading {
  text-align: center;
  padding: 2rem;
  color: var(--color-text-light);
}

.time-slots-loading i {
  font-size: 2rem;
  color: var(--color-primary);
  margin-bottom: 0.5rem;
}

.time-slots {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.time-period {
  margin-bottom: 0.5rem;
}

.time-period h4 {
  font-size: 0.85rem;
  color: var(--color-text-light);
  margin: 0 0 0.5rem 0;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.time-slots-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
  gap: 0.5rem;
}

.time-slot {
  padding: 0.6rem;
  border: 2px solid var(--color-border);
  border-radius: 8px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s;
  background: white;
  font-weight: 500;
  font-size: 0.9rem;
}

.time-slot:hover {
  border-color: var(--color-primary);
  background: var(--color-primary-light);
  transform: translateY(-2px);
}

.time-slot.selected {
  background: var(--color-primary);
  color: white;
  border-color: var(--color-primary);
}

.time-slot.booked {
  background: var(--color-bg);
  color: var(--color-text-muted);
  border-color: var(--color-border);
  cursor: not-allowed;
  opacity: 0.5;
}

.no-slots-message {
  text-align: center;
  padding: 2rem;
  color: var(--color-text-light);
}

.no-slots-message i {
  font-size: 2rem;
  color: var(--color-border);
  margin-bottom: 0.5rem;
}

/* Booking Actions */
.booking-actions {
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--color-border);
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.lesson-type-selector {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.lesson-type-selector label {
  font-weight: 600;
  color: var(--color-text);
  font-size: 0.9rem;
}

.lesson-type-selector select {
  padding: 0.75rem;
  border: 2px solid var(--color-border);
  border-radius: 8px;
  font-size: 1rem;
  background: white;
  cursor: pointer;
}

.booking-summary {
  padding: 1rem;
  background: var(--color-bg);
  border-radius: 8px;
  border-left: 4px solid var(--color-primary);
}

.booking-summary-item {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.5rem;
  font-size: 0.95rem;
}

.booking-summary-item:last-child {
  margin-bottom: 0;
  padding-top: 0.5rem;
  border-top: 1px solid var(--color-border);
  font-weight: 700;
  font-size: 1.1rem;
}

.booking-summary-label {
  color: var(--color-text-light);
}

.booking-summary-value {
  color: var(--color-text);
  font-weight: 600;
}

.booking-summary-value.free {
  color: var(--color-success);
}

.booking-summary-value.paid {
  color: var(--color-primary);
}

.book-lesson-btn {
  width: 100%;
  padding: 1rem;
  background: var(--color-primary);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
}

.book-lesson-btn:hover:not(:disabled) {
  background: var(--color-primary-dark);
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 128, 128, 0.3);
}

.book-lesson-btn:disabled {
  background: var(--color-border);
  cursor: not-allowed;
  transform: none;
}

.book-lesson-btn i {
  margin-right: 0.5rem;
}

/* My Bookings Section */
.my-bookings {
  margin-top: 2rem;
  padding-top: 2rem;
  border-top: 2px solid var(--color-border);
}

.my-bookings h3 {
  margin: 0 0 1rem 0;
  color: var(--color-accent);
}

.bookings-list {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.booking-item {
  padding: 1rem;
  background: var(--color-bg);
  border-radius: 8px;
  border-left: 4px solid var(--color-primary);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.booking-info {
  flex: 1;
}

.booking-date {
  font-weight: 700;
  color: var(--color-text);
  margin-bottom: 0.25rem;
}

.booking-time {
  color: var(--color-text-light);
  font-size: 0.9rem;
}

.booking-type {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  background: var(--color-primary-light);
  color: var(--color-primary-dark);
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  margin-top: 0.5rem;
}

.booking-actions-btns {
  display: flex;
  gap: 0.5rem;
}

.booking-action-btn {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 6px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.reschedule-btn {
  background: var(--color-primary);
  color: white;
}

.reschedule-btn:hover {
  background: var(--color-primary-dark);
}

.cancel-btn {
  background: var(--color-error);
  color: white;
}

.cancel-btn:hover {
  background: #c0392b;
}

.no-bookings {
  text-align: center;
  padding: 2rem;
  color: var(--color-text-light);
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .booking-modal {
    width: 95%;
    max-height: 95vh;
  }
  
  .calendar-container {
    grid-template-columns: 1fr;
  }
  
  .booking-credits {
    flex-direction: column;
    gap: 0.5rem;
    align-items: flex-start;
  }
  
  .time-slots-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* Dark Mode */
@media (prefers-color-scheme: dark) {
  .booking-modal {
    background: var(--color-card-bg);
  }
  
  .time-slot {
    background: var(--color-card-bg);
  }
  
  .lesson-type-selector select {
    background: var(--color-card-bg);
    color: var(--color-text);
  }
}
  </style>
</head>
<body>
    <header class="site-header">
        <div class="container">
            <a href="index.html"><img src="assets/images/prokaiwa-logo.jpg" alt="Prokaiwa Logo" class="logo" /></a>
            <button class="burger-menu" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>
            <nav class="main-nav">
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="about.html">About</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><a href="#" id="logout-button-nav" class="logout-button">Log Out</a></li>
                    <li>
                        <div class="nav-lang-toggle">
                            <button data-lang="ja" aria-label="Êó•Êú¨Ë™û„Å´Âàá„ÇäÊõø„Åà">Êó•Êú¨Ë™û</button>
                            <button data-lang="en" aria-label="Switch to English">English</button>
                        </div>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <!-- BOOKING MODAL OVERLAY -->
        <div class="booking-modal-overlay" id="booking-modal-overlay" onclick="closeBookingModal()"></div>
        
        <!-- BOOKING MODAL -->
        <div class="booking-modal" id="booking-modal">
            <div class="booking-modal-header">
                <h2><i class="fas fa-calendar-alt"></i> <span id="modal-title">„É¨„ÉÉ„Çπ„É≥‰∫àÁ¥Ñ</span></h2>
                <button class="booking-modal-close" onclick="closeBookingModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="booking-modal-body">
                <!-- Booking widget content will be inserted here -->
                <div id="modal-booking-content"></div>
            </div>
        </div>

        <!-- JAPANESE VERSION -->
        <section id="ja-dashboard" class="lang-section" lang="ja">
            <div class="container legal-page-container">
                <!-- Loading State -->
                <div id="ja-dashboard-loading" class="dashboard-loading">
                    <i class="fas fa-spinner"></i>
                    <p>Ë™≠„ÅøËæº„Åø‰∏≠...</p>
                </div>

                <!-- Error State -->
                <div id="ja-dashboard-error" class="dashboard-error" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i>
                    <h2>„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</h2>
                    <p id="ja-error-message">„Éö„Éº„Ç∏„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ</p>
                    <button onclick="location.reload()" class="cta-button">ÂÜçË™≠„ÅøËæº„Åø</button>
                    <a href="login.html" class="cta-button cta-secondary" style="margin-left: 1rem;">„É≠„Ç∞„Ç§„É≥„Éö„Éº„Ç∏„Å∏</a>
                </div>

                <!-- Dashboard Content -->
                <div id="ja-dashboard-content" style="display: none;">
                    
                    <!-- Welcome Banner -->
                    <div class="welcome-banner">
                        <div>
                            <h1 id="ja-welcome-name">„Åä„Åã„Åà„Çä„Å™„Åï„ÅÑÔºÅ</h1>
                            <p>‰ªäÊó•„ÇÇËã±Ë™ûÂ≠¶Áøí„ÄÅÈ†ëÂºµ„Çä„Åæ„Åó„Çá„ÅÜÔºÅ</p>
                        </div>
                        <div class="welcome-stats">
                            <div class="welcome-stat">
                                <span class="welcome-stat-value" id="ja-stat-streak">0</span>
                                <span class="welcome-stat-label">Êó•ÈÄ£Á∂ö</span>
                            </div>
                            <div class="welcome-stat">
                                <span class="welcome-stat-value" id="ja-stat-total">0</span>
                                <span class="welcome-stat-label">Á∑¥ÁøíÂõûÊï∞</span>
                            </div>
                            <div class="welcome-stat">
                                <span class="welcome-stat-value" id="ja-stat-month">0</span>
                                <span class="welcome-stat-label">‰ªäÊúà</span>
                            </div>
                        </div>
                    </div>

                    <!-- Practice Status Card -->
                    <div class="practice-status-card" id="ja-practice-status">
                        <div class="practice-status-icon">‚è≥</div>
                        <h2>‰ªäÊó•„ÅÆÁ∑¥ÁøíÁä∂Ê≥Å„ÇíÁ¢∫Ë™ç‰∏≠...</h2>
                        <p>„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Çì„Åß„ÅÑ„Åæ„Åô</p>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <a href="https://line.me/R/ti/p/@845irjbc" target="_blank" class="quick-action-btn">
                            <i class="fab fa-line"></i>
                            <span>LINE„ÅßÁ∑¥Áøí</span>
                        </a>
                        <button class="quick-action-btn" id="ja-book-lesson-btn" onclick="openBookingModal('ja')">
                            <i class="fas fa-video"></i>
                            <span>„É¨„ÉÉ„Çπ„É≥‰∫àÁ¥Ñ</span>
                        </button>
                        <a href="#ja-resources" class="quick-action-btn">
                            <i class="fas fa-book"></i>
                            <span>Â≠¶ÁøíÊïôÊùê</span>
                        </a>
                        <a href="contact.html" class="quick-action-btn">
                            <i class="fas fa-envelope"></i>
                            <span>„ÅäÂïè„ÅÑÂêà„Çè„Åõ</span>
                        </a>
                    </div>

                    <!-- Dashboard Grid -->
                    <div class="dashboard-grid">
                        
                        <!-- Skills Assessment Card -->
                        <div class="dashboard-card card-skills">
                            <h3><i class="fas fa-chart-radar"></i>„Çπ„Ç≠„É´Ë©ï‰æ°</h3>
                            <div id="ja-skills-assessment">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Today's Tip -->
                        <div class="dashboard-card card-phrase">
                            <h3><i class="fas fa-lightbulb"></i>‰ªäÊó•„ÅÆ„Éï„É¨„Éº„Ç∫</h3>
                            <div class="tip-box">
                                <p>‰ªäÊó•„ÅØ„Åì„ÅÆ„Éï„É¨„Éº„Ç∫„Çí‰Ωø„Å£„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºö</p>
                                <span class="tip-phrase" id="ja-daily-phrase">"I'm looking forward to..."</span>
                                <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--color-text-light);" id="ja-phrase-example">
                                    ‰æãÔºöI'm looking forward to our next lesson!<br>
                                    ÔºàÊ¨°„ÅÆ„É¨„ÉÉ„Çπ„É≥„ÅåÊ•Ω„Åó„Åø„Åß„ÅôÔºÅÔºâ
                                </p>
                            </div>
                        </div>

                        <!-- Progress -->
                        <div class="dashboard-card card-progress">
                            <h3><i class="fas fa-chart-line"></i>‰ªäÊúà„ÅÆÈÄ≤Êçó</h3>
                            <div class="progress-ring-container">
                                <div class="progress-ring">
                                    <svg width="80" height="80">
                                        <circle class="progress-ring-bg" cx="40" cy="40" r="32"></circle>
                                        <circle class="progress-ring-fill" cx="40" cy="40" r="32" 
                                                stroke-dasharray="201" 
                                                id="ja-progress-ring"></circle>
                                    </svg>
                                    <span class="progress-ring-text" id="ja-progress-percent">0%</span>
                                </div>
                                <div class="progress-details">
                                    <h4 id="ja-progress-message">È†ëÂºµ„Çä„Åæ„Åó„Çá„ÅÜÔºÅ</h4>
                                    <p id="ja-progress-sub">‰ªäÊúà„ÅÆÁõÆÊ®ô„Å´Âêë„Åã„Å£„Å¶</p>
                                </div>
                            </div>
                            <p style="font-size: 0.9rem; color: var(--color-text-light);">
                                <i class="fas fa-check-circle" style="color: var(--color-primary);"></i>
                                ‰ªäÊúà <strong id="ja-sessions-completed">0</strong> / <span id="ja-sessions-total">20</span> ÂõûÂÆå‰∫Ü
                            </p>
                        </div>

                        <!-- Streak -->
                        <div class="dashboard-card card-streak">
                            <h3><i class="fas fa-fire"></i>Á∑¥ÁøíÁ∂ôÁ∂öË®òÈå≤</h3>
                            <div class="streak-header">
                                <span class="streak-fire" id="ja-streak-emoji">üî•</span>
                                <div>
                                    <span class="streak-count" id="ja-streak-count">0</span>
                                    <span class="streak-label">Êó•ÈÄ£Á∂öÔºÅ</span>
                                </div>
                            </div>
                            <div class="streak-calendar" id="ja-streak-calendar">
                                <!-- Calendar will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Achievements -->
                        <div class="dashboard-card card-achievements">
                            <h3><i class="fas fa-trophy"></i>ÈÅîÊàê„Éê„ÉÉ„Ç∏</h3>
                            <div class="achievements-grid" id="ja-achievements">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Account Info -->
                        <div class="dashboard-card card-account">
                            <h3><i class="fas fa-user-circle"></i>„Ç¢„Ç´„Ç¶„É≥„ÉàÊÉÖÂ†±</h3>
                            <div id="ja-plan-badges">
                                <span class="plan-badge" id="ja-plan-badge">„Éó„É©„É≥A</span>
                            </div>
                            <ul class="account-details">
                                <li><strong>Ê∞èÂêç</strong><span id="ja-profile-name">-</span></li>
                                <li><strong>„É°„Éº„É´</strong><span id="ja-profile-email">-</span></li>
                                <li><strong>„É¨„Éô„É´</strong><span id="ja-profile-level">-</span></li>
                                <li><strong>„Çπ„ÉÜ„Éº„Çø„Çπ</strong><span id="ja-profile-status">-</span></li>
                            </ul>
                            <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <a href="contact.html?subject=plan-change" class="cta-button cta-secondary" style="font-size: 0.85rem; padding: 0.5rem 1rem;">„Éó„É©„É≥Â§âÊõ¥</a>
                                <button id="ja-logout-btn" class="cta-button cta-secondary" style="font-size: 0.85rem; padding: 0.5rem 1rem;">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                            </div>
                        </div>

                        <!-- Upcoming Lessons -->
                        <div class="dashboard-card card-lessons" id="ja-upcoming-lessons-card" style="display: none;">
                            <h3><i class="fas fa-calendar-alt"></i>‰∫àÁ¥Ñ‰∏≠„ÅÆ„É¨„ÉÉ„Çπ„É≥</h3>
                            <div id="ja-upcoming-lessons">
                                <div class="no-lessons">
                                    <i class="fas fa-calendar-plus"></i>
                                    <p>‰∫àÁ¥Ñ‰∏≠„ÅÆ„É¨„ÉÉ„Çπ„É≥„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                                    <button onclick="openBookingModal('ja')" class="cta-button" style="margin-top: 1rem;">„É¨„ÉÉ„Çπ„É≥„Çí‰∫àÁ¥Ñ„Åô„Çã</button>
                                </div>
                            </div>
                        </div>

                        <!-- Learning Resources -->
                        <div class="dashboard-card card-resources" id="ja-resources">
                            <h3><i class="fas fa-folder-open"></i>Â≠¶ÁøíÊïôÊùê</h3>
                            <div class="resource-item">
                                <i class="fas fa-file-pdf"></i>
                                <a href="#" class="coming-soon">Êó•Â∏∏‰ºöË©±„Éï„É¨„Éº„Ç∫ÈõÜ</a>
                                <span class="resource-tag coming">Ê∫ñÂÇô‰∏≠</span>
                            </div>
                            <div class="resource-item">
                                <i class="fas fa-file-pdf"></i>
                                <a href="#" class="coming-soon">„Éì„Ç∏„Éç„ÇπËã±Ë™ûÂü∫Á§é</a>
                                <span class="resource-tag coming">Ê∫ñÂÇô‰∏≠</span>
                            </div>
                            <div class="resource-item">
                                <i class="fas fa-link"></i>
                                <a href="#" class="coming-soon">„Åä„Åô„Åô„ÇÅYouTube„ÉÅ„É£„É≥„Éç„É´</a>
                                <span class="resource-tag coming">Ê∫ñÂÇô‰∏≠</span>
                            </div>
                            <div class="resource-item">
                                <i class="fas fa-headphones"></i>
                                <a href="#" class="coming-soon">„É™„Çπ„Éã„É≥„Ç∞Á∑¥ÁøíÈü≥Â£∞</a>
                                <span class="resource-tag coming">Ê∫ñÂÇô‰∏≠</span>
                            </div>
                            <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--color-text-muted); text-align: center;">
                                <i class="fas fa-info-circle"></i> ÊïôÊùê„ÅØÈ†ÜÊ¨°ËøΩÂä†‰∫àÂÆö„Åß„Åô
                            </p>
                        </div>

                        <!-- Upgrade Card -->
                        <div class="dashboard-card upgrade-card card-upgrade" id="ja-upgrade-card" style="display: none;">
                            <h3><i class="fas fa-star"></i>„Éì„Éá„Ç™„É¨„ÉÉ„Çπ„É≥„ÇíËøΩÂä†</h3>
                            <p>Ë¨õÂ∏´„Å®Áõ¥Êé•Ë©±„Åó„Å¶„ÄÅ„Åï„Çâ„Å´‰∏äÈÅî„Åó„Åæ„Åõ„Çì„ÅãÔºü</p>
                            <a href="https://buy.stripe.com/28E9AS4UrcIP8JK7wbes002" target="_blank" class="cta-button">
                                „Ç´„Ç∏„É•„Ç¢„É´„É¨„ÉÉ„Çπ„É≥ ¬•3,000
                            </a>
                            <p style="margin-top: 0.75rem; font-size: 0.85rem; opacity: 0.9;">
                                <a href="https://buy.stripe.com/28E14mev16kr4tu5o3es003" target="_blank" style="color: white; text-decoration: underline;">
                                    „Éì„Ç∏„Éç„Çπ„É¨„ÉÉ„Çπ„É≥ ¬•5,000
                                </a>
                            </p>
                        </div>

                    </div>
                </div>
            </div>
        </section>

        <!-- ENGLISH VERSION -->
        <section id="en-dashboard" class="lang-section" lang="en">
            <div class="container legal-page-container">
                <!-- Loading State -->
                <div id="en-dashboard-loading" class="dashboard-loading">
                    <i class="fas fa-spinner"></i>
                    <p>Loading your dashboard...</p>
                </div>

                <!-- Error State -->
                <div id="en-dashboard-error" class="dashboard-error" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i>
                    <h2>Something went wrong</h2>
                    <p id="en-error-message">Could not load the page.</p>
                    <button onclick="location.reload()" class="cta-button">Refresh</button>
                    <a href="login.html" class="cta-button cta-secondary" style="margin-left: 1rem;">Go to Login</a>
                </div>

                <!-- Dashboard Content -->
                <div id="en-dashboard-content" style="display: none;">
                    
                    <!-- Welcome Banner -->
                    <div class="welcome-banner">
                        <div>
                            <h1 id="en-welcome-name">Welcome back!</h1>
                            <p>Let's continue your English learning journey!</p>
                        </div>
                        <div class="welcome-stats">
                            <div class="welcome-stat">
                                <span class="welcome-stat-value" id="en-stat-streak">0</span>
                                <span class="welcome-stat-label">Day Streak</span>
                            </div>
                            <div class="welcome-stat">
                                <span class="welcome-stat-value" id="en-stat-total">0</span>
                                <span class="welcome-stat-label">Total Sessions</span>
                            </div>
                            <div class="welcome-stat">
                                <span class="welcome-stat-value" id="en-stat-month">0</span>
                                <span class="welcome-stat-label">This Month</span>
                            </div>
                        </div>
                    </div>

                    <!-- Practice Status Card -->
                    <div class="practice-status-card" id="en-practice-status">
                        <div class="practice-status-icon">‚è≥</div>
                        <h2>Checking today's practice...</h2>
                        <p>Loading data</p>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <a href="https://line.me/R/ti/p/@845irjbc" target="_blank" class="quick-action-btn">
                            <i class="fab fa-line"></i>
                            <span>Practice on LINE</span>
                        </a>
                        <button class="quick-action-btn" id="en-book-lesson-btn" onclick="openBookingModal('en')">
                            <i class="fas fa-video"></i>
                            <span>Book Lesson</span>
                        </button>
                        <a href="#en-resources" class="quick-action-btn">
                            <i class="fas fa-book"></i>
                            <span>Resources</span>
                        </a>
                        <a href="contact.html" class="quick-action-btn">
                            <i class="fas fa-envelope"></i>
                            <span>Contact Us</span>
                        </a>
                    </div>

                    <!-- Dashboard Grid -->
                    <div class="dashboard-grid">
                        
                        <!-- Skills Assessment Card -->
                        <div class="dashboard-card card-skills">
                            <h3><i class="fas fa-chart-radar"></i>Skills Assessment</h3>
                            <div id="en-skills-assessment">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Today's Tip -->
                        <div class="dashboard-card card-phrase">
                            <h3><i class="fas fa-lightbulb"></i>Phrase of the Day</h3>
                            <div class="tip-box">
                                <p>Try using this phrase today:</p>
                                <span class="tip-phrase" id="en-daily-phrase">"I'm looking forward to..."</span>
                                <p style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--color-text-light);" id="en-phrase-example">
                                    Example: I'm looking forward to our next lesson!
                                </p>
                            </div>
                        </div>

                        <!-- Progress -->
                        <div class="dashboard-card card-progress">
                            <h3><i class="fas fa-chart-line"></i>Monthly Progress</h3>
                            <div class="progress-ring-container">
                                <div class="progress-ring">
                                    <svg width="80" height="80">
                                        <circle class="progress-ring-bg" cx="40" cy="40" r="32"></circle>
                                        <circle class="progress-ring-fill" cx="40" cy="40" r="32" 
                                                stroke-dasharray="201" 
                                                id="en-progress-ring"></circle>
                                    </svg>
                                    <span class="progress-ring-text" id="en-progress-percent">0%</span>
                                </div>
                                <div class="progress-details">
                                    <h4 id="en-progress-message">Let's go!</h4>
                                    <p id="en-progress-sub">Working toward your goal</p>
                                </div>
                            </div>
                            <p style="font-size: 0.9rem; color: var(--color-text-light);">
                                <i class="fas fa-check-circle" style="color: var(--color-primary);"></i>
                                <strong id="en-sessions-completed">0</strong> / <span id="en-sessions-total">20</span> sessions this month
                            </p>
                        </div>

                        <!-- Streak -->
                        <div class="dashboard-card card-streak">
                            <h3><i class="fas fa-fire"></i>Practice Streak</h3>
                            <div class="streak-header">
                                <span class="streak-fire" id="en-streak-emoji">üî•</span>
                                <div>
                                    <span class="streak-count" id="en-streak-count">0</span>
                                    <span class="streak-label">day streak!</span>
                                </div>
                            </div>
                            <div class="streak-calendar" id="en-streak-calendar">
                                <!-- Calendar will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Achievements -->
                        <div class="dashboard-card card-achievements">
                            <h3><i class="fas fa-trophy"></i>Achievements</h3>
                            <div class="achievements-grid" id="en-achievements">
                                <!-- Will be populated by JavaScript -->
                            </div>
                        </div>

                        <!-- Account Info -->
                        <div class="dashboard-card card-account">
                            <h3><i class="fas fa-user-circle"></i>Account Info</h3>
                            <div id="en-plan-badges">
                                <span class="plan-badge" id="en-plan-badge">Plan A</span>
                            </div>
                            <ul class="account-details">
                                <li><strong>Name</strong><span id="en-profile-name">-</span></li>
                                <li><strong>Email</strong><span id="en-profile-email">-</span></li>
                                <li><strong>Level</strong><span id="en-profile-level">-</span></li>
                                <li><strong>Status</strong><span id="en-profile-status">-</span></li>
                            </ul>
                            <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <a href="contact.html?subject=plan-change" class="cta-button cta-secondary" style="font-size: 0.85rem; padding: 0.5rem 1rem;">Change Plan</a>
                                <button id="en-logout-btn" class="cta-button cta-secondary" style="font-size: 0.85rem; padding: 0.5rem 1rem;">Log Out</button>
                            </div>
                        </div>

                        <!-- Upcoming Lessons -->
                        <div class="dashboard-card card-lessons" id="en-upcoming-lessons-card" style="display: none;">
                            <h3><i class="fas fa-calendar-alt"></i>Upcoming Lessons</h3>
                            <div id="en-upcoming-lessons">
                                <div class="no-lessons">
                                    <i class="fas fa-calendar-plus"></i>
                                    <p>No upcoming lessons scheduled</p>
                                    <button onclick="openBookingModal('en')" class="cta-button" style="margin-top: 1rem;">Book a Lesson</button>
                                </div>
                            </div>
                        </div>

                        <!-- Learning Resources -->
                        <div class="dashboard-card card-resources" id="en-resources">
                            <h3><i class="fas fa-folder-open"></i>Learning Resources</h3>
                            <div class="resource-item">
                                <i class="fas fa-file-pdf"></i>
                                <a href="#" class="coming-soon">Common Conversation Phrases</a>
                                <span class="resource-tag coming">Coming Soon</span>
                            </div>
                            <div class="resource-item">
                                <i class="fas fa-file-pdf"></i>
                                <a href="#" class="coming-soon">Business English Basics</a>
                                <span class="resource-tag coming">Coming Soon</span>
                            </div>
                            <div class="resource-item">
                                <i class="fas fa-link"></i>
                                <a href="#" class="coming-soon">Recommended YouTube Channels</a>
                                <span class="resource-tag coming">Coming Soon</span>
                            </div>
                            <div class="resource-item">
                                <i class="fas fa-headphones"></i>
                                <a href="#" class="coming-soon">Listening Practice Audio</a>
                                <span class="resource-tag coming">Coming Soon</span>
                            </div>
                            <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--color-text-muted); text-align: center;">
                                <i class="fas fa-info-circle"></i> More resources coming soon!
                            </p>
                        </div>

                        <!-- Upgrade Card -->
                        <div class="dashboard-card upgrade-card card-upgrade" id="en-upgrade-card" style="display: none;">
                            <h3><i class="fas fa-star"></i>Add Video Lessons</h3>
                            <p>Want to practice speaking with a teacher directly?</p>
                            <a href="https://buy.stripe.com/28E9AS4UrcIP8JK7wbes002" target="_blank" class="cta-button">
                                Casual Lesson ¬•3,000
                            </a>
                            <p style="margin-top: 0.75rem; font-size: 0.85rem; opacity: 0.9;">
                                <a href="https://buy.stripe.com/28E14mev16kr4tu5o3es003" target="_blank" style="color: white; text-decoration: underline;">
                                    Business Lesson ¬•5,000
                                </a>
                            </p>
                        </div>

                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="site-footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-column">
                    <h3>Company</h3>
                    <ul>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="contact.html">Contact</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Legal</h3>
                    <ul>
                        <li><a href="commerce-disclosure.html">Commerce Disclosure</a></li>
                        <li><a href="privacy-policy.html">Privacy Policy</a></li>
                        <li><a href="terms-of-service.html">Terms of Service</a></li>
                    </ul>
                </div>
                <div class="footer-column">
                    <h3>Connect</h3>
                    <div class="footer-social-icons">
                        <a href="https://page.line.me/845irjbc" class="social-icon" target="_blank" aria-label="LINE"><i class="fab fa-line"></i></a>
                        <a href="https://www.instagram.com/prokaiwa.english/" class="social-icon" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
                        <a href="https://x.com/ProkaiwaEnglish" class="social-icon" target="_blank" aria-label="X (formerly Twitter)"><i class="fab fa-x-twitter"></i></a>
                    </div>
                    <a href="mailto:prokaiwa.english@gmail.com" class="footer-email">prokaiwa.english@gmail.com</a>
                </div>
            </div>
            <p>¬© <span id="year"></span> Prokaiwa. All rights reserved.</p>
        </div>
    </footer>

    <script type="module">
        console.log('üöÄ DASHBOARD SCRIPT STARTING...');
        
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/+esm';

        // =============================================
        // CONFIGURATION
        // =============================================
        const SUPABASE_URL = 'https://luyzyzefgintksydmwoh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1eXp5emVmZ2ludGtzeWRtd29oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5NzYyMDUsImV4cCI6MjA2ODU1MjIwNX0.he5_j99ZtAj4K_zzgm11NEEv7TrbRJYndJXot25s_Kg';
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
            auth: {
                persistSession: true,
                storageKey: 'prokaiwa-supabase-auth',
                storage: window.localStorage,
                autoRefreshToken: true,
                detectSessionInUrl: true
            }
        });
        
        console.log('‚úÖ Supabase client created successfully');
        
        const MONTHLY_GOAL = 20;

        // Daily phrases
        const dailyPhrases = [
            { phrase: '"I\'m looking forward to..."', example_en: 'I\'m looking forward to our next lesson!', example_ja: 'Ê¨°„ÅÆ„É¨„ÉÉ„Çπ„É≥„ÅåÊ•Ω„Åó„Åø„Åß„ÅôÔºÅ' },
            { phrase: '"Could you please..."', example_en: 'Could you please repeat that?', example_ja: '„ÇÇ„ÅÜ‰∏ÄÂ∫¶Ë®Ä„Å£„Å¶„ÅÑ„Åü„Å†„Åë„Åæ„Åô„ÅãÔºü' },
            { phrase: '"I\'d like to..."', example_en: 'I\'d like to practice speaking more.', example_ja: '„ÇÇ„Å£„Å®„Çπ„Éî„Éº„Ç≠„É≥„Ç∞„ÇíÁ∑¥Áøí„Åó„Åü„ÅÑ„Åß„Åô„ÄÇ' },
            { phrase: '"What do you think about..."', example_en: 'What do you think about this idea?', example_ja: '„Åì„ÅÆ„Ç¢„Ç§„Éá„Ç¢„Å´„Å§„ÅÑ„Å¶„Å©„ÅÜÊÄù„ÅÑ„Åæ„Åô„ÅãÔºü' },
            { phrase: '"It depends on..."', example_en: 'It depends on the situation.', example_ja: 'Áä∂Ê≥Å„Å´„Çà„Çä„Åæ„Åô„ÄÇ' },
            { phrase: '"I\'m not sure, but..."', example_en: 'I\'m not sure, but I think so.', example_ja: 'Á¢∫„Åã„Åß„ÅØ„Å™„ÅÑ„Åß„Åô„Åå„ÄÅ„Åù„ÅÜÊÄù„ÅÑ„Åæ„Åô„ÄÇ' },
            { phrase: '"Let me think about it."', example_en: 'Let me think about it and get back to you.', example_ja: 'ËÄÉ„Åà„Å¶Âæå„ÅßÈÄ£Áµ°„Åó„Åæ„Åô„Å≠„ÄÇ' },
        ];

        // Learning Archetype definitions
        const learningArchetypes = [
            {
                code: 'perfect_master',
                icon: 'üíé',
                name_ja: '„Éë„Éº„Éï„Çß„ÇØ„Éà„Éû„Çπ„Çø„Éº',
                name_en: 'Perfect Master',
                description_ja: 'ÂÖ®„Çπ„Ç≠„É´ÂÆåÁíßÔºÅ„ÅÇ„Å™„Åü„ÅØËã±Ë™ûÂ≠¶Áøí„ÅÆÈ†ÇÁÇπ„Å´Á´ã„Å£„Å¶„ÅÑ„Åæ„Åô„ÄÇÁ¥†Êô¥„Çâ„Åó„ÅÑÂä™Âäõ„ÅÆÁµêÊô∂„Åß„ÅôÔºÅ',
                description_en: 'Perfect across all skills! You\'ve reached the pinnacle of English mastery. Exceptional work!',
                condition: (skills) => {
                    return skills.fluency === 10 && skills.grammar === 10 && skills.comprehension === 10 && 
                           skills.vocabulary === 10 && skills.pronunciation === 10;
                }
            },
            {
                code: 'advanced_achiever',
                icon: 'üèÜ',
                name_ja: '‰∏äÁ¥öÈÅîÊàêËÄÖ',
                name_en: 'Advanced Achiever',
                description_ja: 'È´ò„ÅÑ„É¨„Éô„É´„Åæ„ÅßÂà∞ÈÅî„Åó„Å¶„ÅÑ„Åæ„ÅôÔºÅ„Åì„ÅÆÂÆüÂäõ„ÇíÁ∂≠ÊåÅ„Åó„Å™„Åå„Çâ„ÄÅ„Åï„Çâ„Å™„ÇãÈ´ò„Åø„ÇíÁõÆÊåá„Åó„Åæ„Åó„Çá„ÅÜÔºÅ',
                description_en: 'You\'ve reached an advanced level! Maintain this excellence while aiming even higher!',
                condition: (skills) => {
                    const values = [skills.fluency, skills.grammar, skills.comprehension, skills.vocabulary, skills.pronunciation];
                    const advancedCount = values.filter(v => v >= 7).length;
                    return advancedCount >= 3;
                }
            },
            {
                code: 'natural_speaker',
                icon: 'üó£Ô∏è',
                name_ja: 'Â§©ÊÄß„ÅÆ„Çπ„Éî„Éº„Ç´„Éº',
                name_en: 'Natural Speaker',
                description_ja: 'ÊµÅÊö¢„Åï„Å®Áô∫Èü≥„ÅåÁâπ„Å´ÂÑ™„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„ÅÇ„Å™„Åü„ÅØÁîü„Åæ„Çå„Å™„Åå„Çâ„ÅÆ„Ç≥„Éü„É•„Éã„Ç±„Éº„Çø„Éº„Åß„Åô„Å≠ÔºÅ',
                description_en: 'Your fluency and pronunciation stand out. You\'re a natural communicator!',
                condition: (skills) => {
                    const speakingAvg = (skills.fluency + skills.pronunciation) / 2;
                    const otherAvg = (skills.grammar + skills.comprehension + skills.vocabulary) / 3;
                    return speakingAvg >= 6 && speakingAvg > otherAvg + 1.5;
                }
            },
            {
                code: 'grammar_guru',
                icon: 'üìö',
                name_ja: 'ÊñáÊ≥ï„Éû„Çπ„Çø„Éº',
                name_en: 'Grammar Guru',
                description_ja: 'ÊñáÊ≥ï„Å®Ë™ûÂΩôÂäõ„ÅåÂº∑„Åø„Åß„Åô„ÄÇÂàÜÊûêÁöÑ„Å™Â≠¶Áøí„Çπ„Çø„Ç§„É´„ÅåËã±Ë™û„ÅÆÊßãÈÄ†ÁêÜËß£„ÇíÊ∑±„ÇÅ„Å¶„ÅÑ„Åæ„ÅôÔºÅ',
                description_en: 'Grammar and vocabulary are your strengths. Your analytical approach builds strong language foundations!',
                condition: (skills) => {
                    const structureAvg = (skills.grammar + skills.vocabulary) / 2;
                    const otherAvg = (skills.fluency + skills.comprehension + skills.pronunciation) / 3;
                    return structureAvg >= 6 && structureAvg > otherAvg + 1.5;
                }
            },
            {
                code: 'comprehension_champion',
                icon: 'üëÇ',
                name_ja: 'ÁêÜËß£Âäõ„ÅÆÈÅî‰∫∫',
                name_en: 'Comprehension Champion',
                description_ja: 'ÁêÜËß£Âäõ„ÅåÊäúÁæ§„Åß„Åô„ÄÇËÅû„ÅçÂèñ„Çä„Å®ÊñáËÑàÊääÊè°„ÅÆÊâçËÉΩ„ÅåÈöõÁ´ã„Å£„Å¶„ÅÑ„Åæ„ÅôÔºÅ',
                description_en: 'Your comprehension excels. You have a gift for understanding context and nuance!',
                condition: (skills) => {
                    return skills.comprehension >= 7 && skills.comprehension >= Math.max(skills.fluency, skills.grammar, skills.vocabulary, skills.pronunciation) + 1;
                }
            },
            {
                code: 'rising_star',
                icon: '‚≠ê',
                name_ja: '„É©„Ç§„Ç∏„É≥„Ç∞„Çπ„Çø„Éº',
                name_en: 'Rising Star',
                description_ja: '„Åô„Åπ„Å¶„ÅÆ„Çπ„Ç≠„É´„ÅåÁùÄÂÆü„Å´ÊàêÈï∑‰∏≠ÔºÅ„Åì„ÅÆË™øÂ≠ê„ÅßÈ†ëÂºµ„Çå„Å∞„ÄÅÂøÖ„ÅöÁõÆÊ®ô„Å´Âà∞ÈÅî„Åß„Åç„Åæ„ÅôÔºÅ',
                description_en: 'All your skills are steadily improving! Keep up this momentum and you\'ll reach your goals!',
                condition: (skills) => {
                    const values = [skills.fluency, skills.grammar, skills.comprehension, skills.vocabulary, skills.pronunciation];
                    return values.every(v => v >= 4 && v <= 7);
                }
            },
            {
                code: 'foundation_builder',
                icon: 'üèóÔ∏è',
                name_ja: 'Âü∫Á§éÂõ∫„ÇÅ‰∏≠',
                name_en: 'Foundation Builder',
                description_ja: 'Âü∫Á§é„Çí„Åó„Å£„Åã„ÇäÁØâ„ÅÑ„Å¶„ÅÑ„ÇãÊÆµÈöé„Åß„Åô„ÄÇ„Åì„ÅÆÂúüÂè∞„ÅåÂ∞ÜÊù•„ÅÆÊàêÈï∑„ÇíÊîØ„Åà„Åæ„Åô„ÄÇÁùÄÂÆü„Å´ÈÄ≤„Åø„Åæ„Åó„Çá„ÅÜÔºÅ',
                description_en: 'You\'re building a solid foundation. This groundwork will support all your future growth. Keep going!',
                condition: (skills) => {
                    const values = [skills.fluency, skills.grammar, skills.comprehension, skills.vocabulary, skills.pronunciation];
                    const beginnerCount = values.filter(v => v <= 4).length;
                    return beginnerCount >= 3;
                }
            },
            {
                code: 'balanced_learner',
                icon: 'üéØ',
                name_ja: '„Éê„É©„É≥„ÇπÂûãÂ≠¶ÁøíËÄÖ',
                name_en: 'Balanced Learner',
                description_ja: '„Åô„Åπ„Å¶„ÅÆ„Çπ„Ç≠„É´„Åå„Éê„É©„É≥„Çπ„Çà„ÅèÊàêÈï∑„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Åì„ÅÆ‰∏áËÉΩ„Åï„ÅØÂÆüË∑µÁöÑ„Å™„Ç≥„Éü„É•„Éã„Ç±„Éº„Ç∑„Éß„É≥Âäõ„ÅÆË®º„Åß„ÅôÔºÅ',
                description_en: 'All your skills are developing evenly. This versatility shows strong practical communication ability!',
                condition: (skills) => {
                    const values = [skills.fluency, skills.grammar, skills.comprehension, skills.vocabulary, skills.pronunciation];
                    const max = Math.max(...values);
                    const min = Math.min(...values);
                    return (max - min) <= 2;
                }
            }
        ];

        // Achievement definitions
        const achievements = [
            { 
                code: 'first_session', 
                icon: 'fa-play', 
                name_ja: 'ÂàùÂõûÂÆå‰∫Ü', 
                name_en: 'First Session', 
                condition: (stats) => stats.total >= 1 
            },
            { 
                code: 'streak_3', 
                icon: 'fa-fire', 
                name_ja: '3Êó•ÈÄ£Á∂ö', 
                name_en: '3-Day Streak', 
                condition: (stats) => stats.maxStreak >= 3 
            },
            { 
                code: 'weekend_warrior', 
                icon: 'fa-calendar-week', 
                name_ja: 'ÈÄ±Êú´Êà¶Â£´', 
                name_en: 'Weekend Warrior', 
                condition: (stats) => {
                    const dates = stats.practiceDates || [];
                    let hasSaturday = false;
                    let hasSunday = false;
                    
                    for (const dateStr of dates) {
                        const day = new Date(dateStr).getDay();
                        if (day === 6) hasSaturday = true;
                        if (day === 0) hasSunday = true;
                        if (hasSaturday && hasSunday) return true;
                    }
                    return false;
                }
            },
            { 
                code: 'streak_7', 
                icon: 'fa-calendar-check', 
                name_ja: '7Êó•ÈÄ£Á∂ö', 
                name_en: '7-Day Streak', 
                condition: (stats) => stats.maxStreak >= 7 
            },
            { 
                code: 'sessions_10', 
                icon: 'fa-star', 
                name_ja: '10ÂõûÈÅîÊàê', 
                name_en: '10 Sessions', 
                condition: (stats) => stats.total >= 10 
            },
            { 
                code: 'consistency_champion', 
                icon: 'fa-trophy', 
                name_ja: 'Á∂ôÁ∂öÁéã', 
                name_en: 'Consistency Champion', 
                condition: (stats) => {
                    const dates = stats.practiceDates || [];
                    const monthCounts = {};
                    
                    for (const dateStr of dates) {
                        const yearMonth = dateStr.substring(0, 7);
                        monthCounts[yearMonth] = (monthCounts[yearMonth] || 0) + 1;
                    }
                    
                    return Object.values(monthCounts).some(count => count >= 20);
                }
            },
            { 
                code: 'streak_30', 
                icon: 'fa-medal', 
                name_ja: '30Êó•ÈÄ£Á∂ö', 
                name_en: '30-Day Streak', 
                condition: (stats) => stats.maxStreak >= 30 
            },
            { 
                code: 'golden_milestone', 
                icon: 'fa-award', 
                name_ja: '„Ç¥„Éº„É´„Éá„É≥ÈÅîÊàê', 
                name_en: 'Golden Milestone', 
                condition: (stats) => stats.total >= 50 
            },
            { 
                code: 'sessions_100', 
                icon: 'fa-crown', 
                name_ja: '100ÂõûÈÅîÊàê', 
                name_en: '100 Sessions', 
                condition: (stats) => stats.total >= 100 
            },
        ];

        // =============================================
        // HELPER FUNCTIONS
        // =============================================
        
        function getCurrentLang() {
            const stored = localStorage.getItem('prokaiwa-lang');
            if (stored) return stored;
            
            const browserLang = navigator.language || navigator.userLanguage;
            return browserLang.startsWith('ja') ? 'ja' : 'en';
        }

        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }

        function getMonthStart() {
            const now = new Date();
            return new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        }

        const planNames = {
            ja: { 
                'A': 'LINE„Éó„É©„ÇØ„ÉÜ„Ç£„Çπ„Éó„É©„É≥', 
                'B45': '„Éì„Éá„Ç™„É¨„ÉÉ„Çπ„É≥Ôºà45ÂàÜÔºâ',
                'B60': '„Éì„Éá„Ç™„É¨„ÉÉ„Çπ„É≥Ôºà60ÂàÜÔºâ',
                'C1': '„Éë„ÉØ„Éº„Éë„ÉÉ„ÇØ„Éª„É©„Ç§„Éà', 
                'C2': '„Éë„ÉØ„Éº„Éë„ÉÉ„ÇØ„Éª„Éó„É≠' 
            },
            en: { 
                'A': 'LINE Practice Plan', 
                'B45': 'Video Lesson (45min)',
                'B60': 'Video Lesson (60min)',
                'C1': 'Power Pack Lite', 
                'C2': 'Power Pack Pro' 
            }
        };

        const statusNames = {
            ja: { paid: 'ÊúâÂäπ', pending: 'ÊîØÊâï„ÅÑÂæÖ„Å°' },
            en: { paid: 'Active', pending: 'Payment Pending' }
        };

        const levelNames = {
            ja: { 'Super Beginner': 'Ë∂ÖÂàùÁ¥ö', 'Beginner': 'ÂàùÁ¥ö', 'Intermediate': '‰∏≠Á¥ö', 'Advanced': '‰∏äÁ¥ö' },
            en: { 'Super Beginner': 'Super Beginner', 'Beginner': 'Beginner', 'Intermediate': 'Intermediate', 'Advanced': 'Advanced' }
        };

        function showError(lang, message) {
            document.getElementById(`${lang}-dashboard-loading`).style.display = 'none';
            document.getElementById(`${lang}-dashboard-content`).style.display = 'none';
            document.getElementById(`${lang}-dashboard-error`).style.display = 'block';
            document.getElementById(`${lang}-error-message`).textContent = message;
        }

        // =============================================
        // LEARNING ARCHETYPE DETERMINATION
        // =============================================
        
        function getLearningArchetype(skillsData) {
            console.log('üéØ Determining learning archetype for:', skillsData);
            for (const archetype of learningArchetypes) {
                if (archetype.condition(skillsData)) {
                    console.log('‚úÖ Matched archetype:', archetype.code);
                    return archetype;
                }
            }
            console.log('‚ö†Ô∏è No match, using fallback: balanced_learner');
            return learningArchetypes[learningArchetypes.length - 1];
        }

        // =============================================
        // PENTAGON RADAR CHART
        // =============================================
        
        function renderSkillsChart(containerId, assessment, lang) {
            const container = document.getElementById(containerId);
            
            if (!assessment) {
                container.innerHTML = `
                    <div class="no-assessment-message">
                        <i class="fas fa-clipboard-list"></i>
                        <p><strong>${lang === 'ja' ? '„Åæ„Å†Ë©ï‰æ°„Åå„ÅÇ„Çä„Åæ„Åõ„Çì' : 'No assessment yet'}</strong></p>
                        <p>${lang === 'ja' 
                            ? 'Ë¨õÂ∏´„Åå„ÅÇ„Å™„Åü„ÅÆ„Çπ„Ç≠„É´„ÇíË©ï‰æ°„Åô„Çã„Å®„ÄÅ„Åì„Åì„Å´ÁµêÊûú„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇÊ•Ω„Åó„Åø„Å´„Åó„Å¶„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ„Å≠ÔºÅ' 
                            : 'Your teacher will evaluate your skills soon and your results will appear here. Stay tuned!'}</p>
                    </div>
                `;
                return;
            }
            
            const allPerfect = assessment.fluency === 10 && 
                                assessment.grammar === 10 && 
                                assessment.comprehension === 10 && 
                                assessment.vocabulary === 10 && 
                                assessment.pronunciation === 10;
            
            const skillsData = {
                fluency: assessment.fluency || 0,
                grammar: assessment.grammar || 0,
                comprehension: assessment.comprehension || 0,
                vocabulary: assessment.vocabulary || 0,
                pronunciation: assessment.pronunciation || 0
            };
            
            console.log('Rendering skills chart:', skillsData, 'All perfect:', allPerfect);
            
            const skillColors = {
                fluency: '#4A90E2',
                grammar: '#9B59B6',
                comprehension: '#E67E22',
                vocabulary: '#27AE60',
                pronunciation: '#E74C3C'
            };
            
            const skillLabels = lang === 'ja'
                ? ['ÊµÅÊö¢„Åï', 'ÊñáÊ≥ï', 'ÁêÜËß£Âäõ', 'Ë™ûÂΩô', 'Áô∫Èü≥']
                : ['Fluency', 'Grammar', 'Comprehension', 'Vocabulary', 'Pronunciation'];
            
            const skillValues = [
                skillsData.fluency,
                skillsData.grammar,
                skillsData.comprehension,
                skillsData.vocabulary,
                skillsData.pronunciation
            ];
            
            const pointColors = [
                skillColors.fluency,
                skillColors.grammar,
                skillColors.comprehension,
                skillColors.vocabulary,
                skillColors.pronunciation
            ];
            
            const borderColor = allPerfect ? '#008080' : 'rgba(74, 144, 226, 0.6)';
            const backgroundColor = allPerfect ? 'rgba(0, 128, 128, 0.3)' : 'rgba(74, 144, 226, 0.1)';
            
            const archetype = getLearningArchetype(skillsData);
            
            container.innerHTML = `
                <div class="skills-chart-container">
                    <canvas id="${containerId}-canvas"></canvas>
                </div>
                <div class="assessment-info">
                    <span class="assessment-date">
                        ${lang === 'ja' ? 'Ë©ï‰æ°Êó•Ôºö' : 'Assessed: '}
                        ${new Date(assessment.assessed_at).toLocaleDateString(lang === 'ja' ? 'ja-JP' : 'en-US')}
                    </span>
                    <span class="assessment-band">${assessment.band_level || '-'}</span>
                </div>
                <div class="learning-archetype">
                    <div class="archetype-icon">${archetype.icon}</div>
                    <div class="archetype-content">
                        <div class="archetype-name">${lang === 'ja' ? archetype.name_ja : archetype.name_en}</div>
                        <div class="archetype-description">${lang === 'ja' ? archetype.description_ja : archetype.description_en}</div>
                    </div>
                </div>
            `;
            
            const ctx = document.getElementById(`${containerId}-canvas`).getContext('2d');
            
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: skillLabels,
                    datasets: [{
                        label: lang === 'ja' ? '„Çπ„Ç≠„É´„É¨„Éô„É´' : 'Skill Level',
                        data: skillValues,
                        borderColor: borderColor,
                        backgroundColor: backgroundColor,
                        borderWidth: allPerfect ? 3 : 2,
                        pointBackgroundColor: pointColors,
                        pointBorderColor: pointColors,
                        pointBorderWidth: 2,
                        pointRadius: 8,
                        pointHoverRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    layout: {
                        padding: 10
                    },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 10,
                            min: 0,
                            ticks: {
                                stepSize: 2,
                                display: true,
                                backdropColor: 'transparent',
                                callback: function(value) {
                                    if (value === 0) return '0';
                                    if (value === 2) return '2';
                                    if (value === 5) return '5';
                                    if (value === 8) return '8';
                                    if (value === 10) return '10';
                                    return '';
                                },
                                font: { size: 12, weight: 'bold' },
                                color: '#666'
                            },
                            pointLabels: {
                                display: false
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)',
                                lineWidth: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    const score = context.parsed.r;
                                    let level = '';
                                    if (score === 0) level = lang === 'ja' ? 'Êú™Ë©ï‰æ°' : 'Not Rated';
                                    else if (score <= 2) level = lang === 'ja' ? 'Ë∂ÖÂàùÁ¥ö' : 'Super Beginner';
                                    else if (score <= 4) level = lang === 'ja' ? 'ÂàùÁ¥ö' : 'Beginner';
                                    else if (score <= 6) level = lang === 'ja' ? '‰∏≠Á¥ö' : 'Intermediate';
                                    else if (score <= 8) level = lang === 'ja' ? '‰∏äÁ¥ö' : 'Advanced';
                                    else if (score < 10) level = lang === 'ja' ? '‰∏äÁ¥ö+' : 'Advanced+';
                                    else level = lang === 'ja' ? 'ÂÆåÁíßÔºÅ' : 'Perfect!';
                                    
                                    return `${score}/10 (${level})`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // =============================================
        // AUTO-DETECT TODAY'S PRACTICE
        // =============================================

        async function checkTodaysPractice(userId, lang) {
            const statusCard = document.getElementById(`${lang}-practice-status`);
            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0);
            
            console.log(`[${lang}] Checking today's practice for user:`, userId);
            console.log(`[${lang}] Today start:`, todayStart.toISOString());
            
            try {
                const { data: todayResponse, error } = await supabase
                    .from('message_log')
                    .select('id, created_at')
                    .eq('user_id', userId)
                    .eq('message_type', 'student_response')
                    .gte('created_at', todayStart.toISOString())
                    .limit(1)
                    .maybeSingle();
                
                console.log(`[${lang}] Today's response query result:`, { data: todayResponse, error });
                
                if (error && error.code !== 'PGRST116') {
                    console.error('Error checking today\'s practice:', error);
                    return false;
                }
                
                const practicedToday = !!todayResponse;
                console.log(`[${lang}] Practiced today:`, practicedToday);
                
                if (practicedToday) {
                    statusCard.classList.add('completed');
                    statusCard.innerHTML = `
                        <div class="practice-status-icon">‚úÖ</div>
                        <h2>${lang === 'ja' ? '‰ªäÊó•„ÅÆÁ∑¥ÁøíÂÆå‰∫ÜÔºÅ' : 'Today\'s Practice Complete!'}</h2>
                        <p>${lang === 'ja' ? 'Á¥†Êô¥„Çâ„Åó„ÅÑÔºÅ‰ªäÊó•„ÇÇ„Çà„ÅèÈ†ëÂºµ„Çä„Åæ„Åó„ÅüÔºÅ' : 'Great job! You practiced today!'}</p>
                    `;
                } else {
                    statusCard.classList.remove('completed');
                    statusCard.innerHTML = `
                        <div class="practice-status-icon"><i class="fab fa-line" style="color: white;"></i></div>
                        <h2>${lang === 'ja' ? '„Åæ„Å†Á∑¥Áøí„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì' : 'No Practice Yet Today'}</h2>
                        <p>${lang === 'ja' ? 'LINE„Åß‰ªäÊó•„ÅÆ„Éó„É≠„É≥„Éó„Éà„Å´Á≠î„Åà„Åæ„Åó„Çá„ÅÜÔºÅ' : 'Head to LINE to respond to today\'s prompt!'}</p>
                    `;
                }
                
                return practicedToday;
                
            } catch (err) {
                console.error('Error checking practice:', err);
                return false;
            }
        }

        // =============================================
        // REAL PROGRESS FROM DATABASE
        // =============================================

        async function loadRealProgress(userId, lang) {
            console.log('=== loadRealProgress START ===');
            console.log('User ID:', userId);
            
            try {
                console.log('Fetching student_progress...');
                const { data: progress, error } = await supabase
                    .from('student_progress')
                    .select('*')
                    .eq('user_id', userId)
                    .single();
                
                console.log('student_progress result:', { data: progress, error });
                
                if (error) {
                    console.error('‚ùå Error loading progress:', error);
                    return null;
                }
                
                console.log('Fetching message_log...');
                const { data: messages, error: msgError } = await supabase
                    .from('message_log')
                    .select('created_at')
                    .eq('user_id', userId)
                    .eq('message_type', 'student_response')
                    .order('created_at', { ascending: false });
                
                console.log('message_log result:', { 
                    count: messages?.length || 0, 
                    error: msgError,
                    sample: messages?.slice(0, 3)
                });
                
                if (msgError) {
                    console.error('‚ùå Error loading messages:', msgError);
                }
                
                const practiceDates = messages 
                    ? [...new Set(messages.map(m => m.created_at.split('T')[0]))]
                    : [];
                
                console.log('Practice dates extracted:', practiceDates.length, 'unique dates');
                console.log('Sample dates:', practiceDates.slice(0, 5));
                
                const monthStart = getMonthStart();
                console.log('Month start:', monthStart);
                
                const thisMonthDates = practiceDates.filter(d => d >= monthStart);
                const thisMonthCount = thisMonthDates.length;
                
                console.log('This month count:', thisMonthCount, 'days');
                
                const streakData = calculateStreak(practiceDates);
                console.log('Streak calculated:', streakData);
                
                const result = {
                    current_day: progress.current_day,
                    current_week: progress.current_week,
                    total_prompts_sent: progress.total_prompts_sent,
                    thisMonthCount: thisMonthCount,
                    currentStreak: streakData.current,
                    maxStreak: streakData.max,
                    practiceDates: practiceDates
                };
                
                console.log('‚úÖ Final result:', result);
                console.log('=== loadRealProgress END ===');
                
                return result;
                
            } catch (err) {
                console.error('‚ùå ERROR in loadRealProgress:', err);
                return null;
            }
        }

        // =============================================
        // LOAD LATEST ASSESSMENT
        // =============================================

        async function loadLatestAssessment(userId) {
            console.log('=== loadLatestAssessment START ===');
            console.log('User ID:', userId);
            
            try {
                const { data: assessment, error } = await supabase
                    .from('student_assessments')
                    .select('*')
                    .eq('user_id', userId)
                    .order('assessed_at', { ascending: false })
                    .limit(1)
                    .maybeSingle();
                
                console.log('student_assessments result:', { data: assessment, error });
                
                if (error && error.code !== 'PGRST116') {
                    console.error('‚ùå Error loading assessment:', error);
                    return null;
                }
                
                if (assessment) {
                    console.log('‚úÖ Assessment found:', {
                        assessed_at: assessment.assessed_at,
                        band_level: assessment.band_level,
                        total_score: assessment.total_score
                    });
                } else {
                    console.log('‚ÑπÔ∏è No assessment found yet');
                }
                
                console.log('=== loadLatestAssessment END ===');
                return assessment;
                
            } catch (err) {
                console.error('‚ùå ERROR in loadLatestAssessment:', err);
                return null;
            }
        }

        // =============================================
        // STREAK CALCULATION
        // =============================================
        
        function calculateStreak(practiceDates) {
            if (!practiceDates || practiceDates.length === 0) return { current: 0, max: 0 };
            
            const sortedDates = [...practiceDates].sort((a, b) => new Date(b) - new Date(a));
            const today = getTodayString();
            const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
            
            let currentStreak = 0;
            let maxStreak = 0;
            let tempStreak = 0;
            let lastDate = null;
            
            const streakActive = sortedDates.includes(today) || sortedDates.includes(yesterday);
            
            if (streakActive) {
                for (const dateStr of sortedDates) {
                    const date = new Date(dateStr);
                    if (lastDate === null) {
                        currentStreak = 1;
                        lastDate = date;
                    } else {
                        const diffDays = (lastDate - date) / (1000 * 60 * 60 * 24);
                        if (diffDays === 1) {
                            currentStreak++;
                            lastDate = date;
                        } else {
                            break;
                        }
                    }
                }
            }
            
            lastDate = null;
            for (const dateStr of sortedDates) {
                const date = new Date(dateStr);
                if (lastDate === null) {
                    tempStreak = 1;
                    lastDate = date;
                } else {
                    const diffDays = (lastDate - date) / (1000 * 60 * 60 * 24);
                    if (diffDays === 1) {
                        tempStreak++;
                        lastDate = date;
                    } else {
                        maxStreak = Math.max(maxStreak, tempStreak);
                        tempStreak = 1;
                        lastDate = date;
                    }
                }
            }
            maxStreak = Math.max(maxStreak, tempStreak);
            
            return { current: currentStreak, max: maxStreak };
        }

        // =============================================
        // UI RENDERING
        // =============================================
        
        function renderStreakCalendar(containerId, practiceDates, lang) {
            const container = document.getElementById(containerId);
            const calendarId = `${containerId}-calendar-grid`;
            
            container.innerHTML = `<div id="${calendarId}" class="streak-calendar"></div>`;
            
            const calendarGrid = document.getElementById(calendarId);
            
            const days = lang === 'ja' 
                ? ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü']
                : ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            
            days.forEach(day => {
                const header = document.createElement('div');
                header.className = 'streak-day-header';
                header.textContent = day;
                calendarGrid.appendChild(header);
            });

            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            const today = now.getDate();
            
            const startDay = firstDay.getDay();
            for (let i = 0; i < startDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'streak-day';
                empty.style.visibility = 'hidden';
                calendarGrid.appendChild(empty);
            }
            
            const sortedDates = [...practiceDates].sort();
            
            for (let d = 1; d <= lastDay.getDate(); d++) {
                const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const day = document.createElement('div');
                day.className = 'streak-day';
                day.textContent = d;
                
                if (practiceDates.includes(dateStr)) {
                    let streakLength = 1;
                    const currentDate = new Date(dateStr);
                    
                    for (let i = 1; i <= 30; i++) {
                        const prevDate = new Date(currentDate);
                        prevDate.setDate(prevDate.getDate() - i);
                        const prevDateStr = prevDate.toISOString().split('T')[0];
                        
                        if (sortedDates.includes(prevDateStr)) {
                            streakLength++;
                        } else {
                            break;
                        }
                    }
                    
                    if (streakLength >= 7) {
                        day.classList.add('streak-fire');
                    } else if (streakLength >= 3) {
                        day.classList.add('streak-hot');
                    } else {
                        day.classList.add('active');
                    }
                }
                if (d === today) {
                    day.classList.add('today');
                }
                if (d > today) {
                    day.classList.add('future');
                }
                
                calendarGrid.appendChild(day);
            }
        }

        function renderAchievements(containerId, stats, lang) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            achievements.forEach(achievement => {
                const earned = achievement.condition(stats);
                const div = document.createElement('div');
                div.className = `achievement${earned ? '' : ' locked'}`;
                div.innerHTML = `
                    <div class="achievement-icon ${earned ? 'earned' : 'locked'}">
                        <i class="fas ${achievement.icon}"></i>
                    </div>
                    <span class="achievement-name">${lang === 'ja' ? achievement.name_ja : achievement.name_en}</span>
                `;
                container.appendChild(div);
            });
        }

        function updateProgressRing(lang, percentage) {
            const ring = document.getElementById(`${lang}-progress-ring`);
            const text = document.getElementById(`${lang}-progress-percent`);
            const message = document.getElementById(`${lang}-progress-message`);
            
            const circumference = 201;
            const offset = circumference - (percentage / 100) * circumference;
            
            ring.style.strokeDashoffset = offset;
            text.textContent = `${Math.round(percentage)}%`;
            
            if (lang === 'ja') {
                if (percentage >= 100) message.textContent = 'ÁõÆÊ®ôÈÅîÊàêÔºÅüéâ';
                else if (percentage >= 75) message.textContent = '„ÅÇ„Å®Â∞ë„ÅóÔºÅ';
                else if (percentage >= 50) message.textContent = 'È†ÜË™ø„Åß„ÅôÔºÅ';
                else if (percentage >= 25) message.textContent = '„ÅÑ„ÅÑË™øÂ≠êÔºÅ';
                else message.textContent = 'È†ëÂºµ„Çä„Åæ„Åó„Çá„ÅÜÔºÅ';
            } else {
                if (percentage >= 100) message.textContent = 'Goal reached! üéâ';
                else if (percentage >= 75) message.textContent = 'Almost there!';
                else if (percentage >= 50) message.textContent = 'Great progress!';
                else if (percentage >= 25) message.textContent = 'Good start!';
                else message.textContent = "Let's go!";
            }
        }

        function setDailyPhrase(lang) {
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
            const phrase = dailyPhrases[dayOfYear % dailyPhrases.length];
            
            document.getElementById(`${lang}-daily-phrase`).textContent = phrase.phrase;
            document.getElementById(`${lang}-phrase-example`).innerHTML = lang === 'ja'
                ? `‰æãÔºö${phrase.example_en}<br>Ôºà${phrase.example_ja}Ôºâ`
                : `Example: ${phrase.example_en}`;
        }

        // =============================================
        // MAIN DASHBOARD LOADER
        // =============================================
        
        async function loadDashboard() {
            const lang = getCurrentLang();
            const loadingDiv = document.getElementById(`${lang}-dashboard-loading`);
            const contentDiv = document.getElementById(`${lang}-dashboard-content`);

            console.log('Loading dashboard with Phase 1 features...');

            try {
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    console.error('Session error:', sessionError);
                }
                
                if (!session) {
                    console.log('No session found, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }
                
                const user = session.user;
                console.log('User authenticated:', user.email);

                const { data: profile, error: profileError } = await supabase
                    .from('questionnaire_responses')
                    .select('*')
                    .eq('user_id', user.id)
                    .single();
                
                if (profileError) {
                    console.error('Profile error:', profileError);
                    
                    if (profileError.code === 'PGRST116') {
                        console.log('No profile found, redirecting to questionnaire');
                        window.location.href = 'questionnaire.html';
                        return;
                    }
                    
                    showError(lang, lang === 'ja' 
                        ? '„Éó„É≠„Éï„Ç£„Éº„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ' 
                        : 'Failed to load profile.');
                    return;
                }

                const realProgress = await loadRealProgress(user.id, lang);
                const assessment = await loadLatestAssessment(user.id);
                
                await checkTodaysPractice(user.id, 'ja');
                await checkTodaysPractice(user.id, 'en');
                
                let stats = {
                    current: 0,
                    maxStreak: 0,
                    total: 0,
                    thisMonth: 0,
                    practiceDates: []
                };
                
                let practiceDates = [];
                
                if (realProgress) {
                    stats = {
                        current: realProgress.currentStreak,
                        maxStreak: realProgress.maxStreak,
                        total: realProgress.practiceDates.length,
                        thisMonth: realProgress.thisMonthCount,
                        practiceDates: realProgress.practiceDates
                    };
                    practiceDates = realProgress.practiceDates;
                }
                
                const progressPercent = Math.min((stats.thisMonth / MONTHLY_GOAL) * 100, 100);

                const hasVideoAddon = profile.addons?.includes('B45') || profile.addons?.includes('B60') || false;
                const hasVideoAccess = profile.plan !== 'A' || hasVideoAddon;

                ['ja', 'en'].forEach(l => {
                    const welcomeText = l === 'ja' 
                        ? `${profile.given_name_romaji || profile.name}„Åï„Çì„ÄÅ„Åä„Åã„Åà„Çä„Å™„Åï„ÅÑÔºÅ`
                        : `Welcome back, ${profile.given_name_romaji || profile.name}!`;
                    document.getElementById(`${l}-welcome-name`).textContent = welcomeText;

                    document.getElementById(`${l}-stat-streak`).textContent = stats.current;
                    document.getElementById(`${l}-stat-total`).textContent = stats.total;
                    document.getElementById(`${l}-stat-month`).textContent = stats.thisMonth;

                    document.getElementById(`${l}-profile-name`).textContent = profile.name;
                    document.getElementById(`${l}-profile-email`).textContent = profile.email;
                    document.getElementById(`${l}-profile-level`).textContent = levelNames[l][profile.level] || profile.level;
                    
                    const isPaid = profile.payment_status === 'paid';
                    document.getElementById(`${l}-profile-status`).textContent = isPaid 
                        ? statusNames[l].paid 
                        : statusNames[l].pending;

                    const planBadge = document.getElementById(`${l}-plan-badge`);
                    planBadge.textContent = planNames[l][profile.plan] || profile.plan;
                    if (!isPaid) planBadge.classList.add('pending');
                    if (hasVideoAddon) planBadge.classList.add('has-addon');

                    if (hasVideoAddon) {
                        const badgeContainer = document.getElementById(`${l}-plan-badges`);
                        badgeContainer.innerHTML += `<span class="addon-badge">+ ${l === 'ja' ? '„Éì„Éá„Ç™' : 'Video'}</span>`;
                    }

                    const bookLessonBtn = document.getElementById(`${l}-book-lesson-btn`);
                    const upcomingCard = document.getElementById(`${l}-upcoming-lessons-card`);
                    const upgradeCard = document.getElementById(`${l}-upgrade-card`);
                    
                    if (hasVideoAccess) {
                        upcomingCard.style.display = 'block';
                        upgradeCard.style.display = 'none';
                    } else {
                        bookLessonBtn.style.display = 'none';
                        upcomingCard.style.display = 'none';
                        upgradeCard.style.display = 'block';
                    }

                    document.getElementById(`${l}-sessions-completed`).textContent = stats.thisMonth;
                    document.getElementById(`${l}-sessions-total`).textContent = MONTHLY_GOAL;
                    updateProgressRing(l, progressPercent);

                    document.getElementById(`${l}-streak-count`).textContent = stats.current;
                    document.getElementById(`${l}-streak-emoji`).textContent = stats.current >= 7 ? 'üî•' : stats.current >= 3 ? 'üî•' : 'üí™';
                    renderStreakCalendar(`${l}-streak-calendar`, practiceDates, l);

                    renderAchievements(`${l}-achievements`, stats, l);

                    setDailyPhrase(l);
                    
                    renderSkillsChart(`${l}-skills-assessment`, assessment, l);
                });

                loadingDiv.style.display = 'none';
                contentDiv.style.display = 'block';

                const otherLang = lang === 'ja' ? 'en' : 'ja';
                document.getElementById(`${otherLang}-dashboard-loading`).style.display = 'none';
                document.getElementById(`${otherLang}-dashboard-content`).style.display = 'block';
                
                // Initialize booking widget
                await initializeBookingWidget(profile.id, user.id);
                
                console.log('‚úÖ Dashboard loaded with Phase 1 features!');
                
            } catch (error) {
                console.error('Dashboard load error:', error);
                showError(lang, lang === 'ja' 
                    ? '‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ' 
                    : 'An unexpected error occurred.');
            }
        }

        // =============================================
        // LANGUAGE TOGGLE SYSTEM
        // =============================================
        
        function setLanguage(lang) {
            localStorage.setItem('prokaiwa-lang', lang);
            
            document.querySelectorAll('.lang-section').forEach(section => {
                section.classList.remove('show');
            });
            document.getElementById(`${lang}-dashboard`).classList.add('show');
            
            document.querySelectorAll('.nav-lang-toggle button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.lang === lang) {
                    btn.classList.add('active');
                }
            });
        }
        
        document.querySelectorAll('.nav-lang-toggle button').forEach(button => {
            button.addEventListener('click', () => {
                setLanguage(button.dataset.lang);
            });
        });
        
        const initialLang = getCurrentLang();
        setLanguage(initialLang);

        // =============================================
        // EVENT LISTENERS & INITIALIZATION
        // =============================================
        
        async function handleLogout() {
            console.log('Logging out...');
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        }

        document.getElementById('logout-button-nav').addEventListener('click', (e) => {
            e.preventDefault();
            handleLogout();
        });
        document.getElementById('ja-logout-btn').addEventListener('click', handleLogout);
        document.getElementById('en-logout-btn').addEventListener('click', handleLogout);

        supabase.auth.onAuthStateChange((event, session) => {
            console.log('Auth state changed:', event);
            
            if (event === 'SIGNED_OUT') {
                window.location.href = 'login.html';
            } else if (event === 'TOKEN_REFRESHED') {
                console.log('Token refreshed successfully');
            }
        });

        loadDashboard();
        
        document.getElementById('year').textContent = new Date().getFullYear();
        
        const burgerMenu = document.querySelector('.burger-menu');
        const mainNav = document.querySelector('.main-nav');
        if (burgerMenu && mainNav) {
            burgerMenu.addEventListener('click', () => {
                mainNav.classList.toggle('open');
            });
        }

        // =============================================
        // BOOKING WIDGET - MODAL VERSION
        // =============================================

        let bookingState = {
            selectedDate: null,
            selectedTime: null,
            selectedLessonType: 'standard',
            availableSlots: [],
            userBookings: [],
            availableCredits: 0,
            eligibleForConsultation: false,
            currentMonth: new Date(),
            studentId: null,
            userId: null,
            currentLang: 'ja'
        };

        // MODAL FUNCTIONS
        window.openBookingModal = function(lang) {
            console.log('üìñ Opening booking modal for lang:', lang);
            bookingState.currentLang = lang;
            
            // Update modal title
            document.getElementById('modal-title').textContent = lang === 'ja' ? '„É¨„ÉÉ„Çπ„É≥‰∫àÁ¥Ñ' : 'Book a Lesson';
            
            // Render booking widget content
            const modalContent = document.getElementById('modal-booking-content');
            modalContent.innerHTML = getBookingWidgetHTML(lang);
            
            // Show modal
            document.getElementById('booking-modal-overlay').classList.add('show');
            document.getElementById('booking-modal').classList.add('show');
            
            // Scroll modal body to top (fixes reopening at bottom issue)
            const modalBody = document.querySelector('.booking-modal-body');
            if (modalBody) {
                modalBody.scrollTop = 0;
            }
            
            // Initialize widget
            renderCalendar(lang);
            setupBookingEventListeners(lang);
        };

        window.closeBookingModal = function() {
            console.log('üìï Closing booking modal');
            document.getElementById('booking-modal-overlay').classList.remove('show');
            document.getElementById('booking-modal').classList.remove('show');
        };

        // Close modal on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeBookingModal();
            }
        });

        function getBookingWidgetHTML(lang) {
            return `
                <div class="booking-widget">
                    <div class="booking-header">
                        <div class="booking-credits">
                            <div class="credit-badge">
                                <i class="fas fa-ticket-alt"></i>
                                <span>${lang === 'ja' ? 'Âà©Áî®ÂèØËÉΩ' : 'Available'}: <span class="credit-number" id="${lang}-credits-count">0</span></span>
                            </div>
                            <div class="consultation-badge" id="${lang}-consultation-badge" style="display: none;">
                                <i class="fas fa-gift"></i>
                                <span>${lang === 'ja' ? 'ÁÑ°ÊñôÁõ∏Ë´á' : 'Free Consultation'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="calendar-container">
                        <div class="calendar-picker">
                            <div class="calendar-month-nav">
                                <button class="calendar-nav-btn" id="${lang}-calendar-prev">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <h3 id="${lang}-calendar-month">2026Âπ¥ 1Êúà</h3>
                                <button class="calendar-nav-btn" id="${lang}-calendar-next">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            <div class="calendar-grid" id="${lang}-calendar-grid"></div>
                        </div>
                        
                        <div class="time-slots-container">
                            <div class="selected-date-display" id="${lang}-selected-date">
                                ${lang === 'ja' ? 'Êó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ' : 'Select a date'}
                            </div>
                            <div id="${lang}-time-slots"></div>
                        </div>
                    </div>
                    
                    <div class="booking-actions">
                        <div class="lesson-type-selector">
                            <label for="${lang}-lesson-type">${lang === 'ja' ? '„É¨„ÉÉ„Çπ„É≥„Çø„Ç§„Éó:' : 'Lesson Type:'}</label>
                            <select id="${lang}-lesson-type">
                                <option value="standard">${lang === 'ja' ? '50ÂàÜ „Çπ„Çø„É≥„ÉÄ„Éº„Éâ„É¨„ÉÉ„Çπ„É≥' : '50-min Standard Lesson'}</option>
                                <option value="consultation">${lang === 'ja' ? '20ÂàÜ ÁÑ°ÊñôÁõ∏Ë´áÔºàÂàùÂõû„ÅÆ„ÅøÔºâ' : '20-min Free Consultation (First-time)'}</option>
                            </select>
                        </div>
                        
                        <div class="booking-summary" id="${lang}-booking-summary"></div>
                        
                        <button class="book-lesson-btn" id="${lang}-book-btn" disabled>
                            <i class="fas fa-calendar-check"></i> ${lang === 'ja' ? '„É¨„ÉÉ„Çπ„É≥„Çí‰∫àÁ¥Ñ' : 'Book Lesson'}
                        </button>
                    </div>
                    
                    <div class="my-bookings">
                        <h3><i class="fas fa-list"></i> ${lang === 'ja' ? '‰∫àÁ¥ÑÊ∏à„Åø„É¨„ÉÉ„Çπ„É≥' : 'My Upcoming Lessons'}</h3>
                        <div class="bookings-list" id="${lang}-bookings-list"></div>
                    </div>
                </div>
            `;
        }

        async function initializeBookingWidget(studentId, userId) {
            console.log('üéØ Initializing booking widget...', { studentId, userId });
            
            bookingState.studentId = studentId;
            bookingState.userId = userId;
            
            await fetchBookingEligibility(studentId, 'ja');
            await fetchBookingEligibility(studentId, 'en');
            
            await fetchUserBookings(userId, 'ja');
            await fetchUserBookings(userId, 'en');
            
            console.log('‚úÖ Booking widget initialized');
        }

        async function fetchBookingEligibility(studentId, lang) {
            try {
                const { data, error } = await supabase
                    .rpc('check_booking_eligibility', {
                        p_student_id: studentId,
                        p_lesson_type: 'standard'
                    });
                
                if (error) throw error;
                
                bookingState.availableCredits = data.availableCredits || 0;
                bookingState.eligibleForConsultation = data.eligibleForConsultation || false;
                
                console.log('Credits:', bookingState.availableCredits);
                console.log('Consultation eligible:', bookingState.eligibleForConsultation);
                
            } catch (err) {
                console.error('Error fetching eligibility:', err);
            }
        }

        async function fetchUserBookings(userId, lang) {
            try {
                const { data: bookings, error } = await supabase
                    .from('lesson_bookings')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('status', 'scheduled')
                    .gte('scheduled_at', new Date().toISOString())
                    .order('scheduled_at', { ascending: true });
                
                if (error) throw error;
                
                bookingState.userBookings = bookings || [];
                
                console.log('User bookings:', bookingState.userBookings.length);
                
            } catch (err) {
                console.error('Error fetching bookings:', err);
            }
        }

        function renderCalendar(lang) {
            const month = bookingState.currentMonth;
            const year = month.getFullYear();
            const monthIndex = month.getMonth();
            
            const monthNames = lang === 'ja' 
                ? ['1Êúà', '2Êúà', '3Êúà', '4Êúà', '5Êúà', '6Êúà', '7Êúà', '8Êúà', '9Êúà', '10Êúà', '11Êúà', '12Êúà']
                : ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            document.getElementById(`${lang}-calendar-month`).textContent = 
                lang === 'ja' ? `${year}Âπ¥ ${monthNames[monthIndex]}` : `${monthNames[monthIndex]} ${year}`;
            
            const calendarGrid = document.getElementById(`${lang}-calendar-grid`);
            if (!calendarGrid) return;
            
            calendarGrid.innerHTML = '';
            
            const dayHeaders = lang === 'ja' 
                ? ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü']
                : ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                calendarGrid.appendChild(header);
            });
            
            const firstDay = new Date(year, monthIndex, 1).getDay();
            const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, monthIndex, 0).getDate();
            
            // TIMEZONE FIX: Get today in local timezone
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.textContent = daysInPrevMonth - i;
                calendarGrid.appendChild(day);
            }
            
            for (let date = 1; date <= daysInMonth; date++) {
                const dayDate = new Date(year, monthIndex, date);
                dayDate.setHours(0, 0, 0, 0);
                
                const day = document.createElement('div');
                day.className = 'calendar-day';
                day.textContent = date;
                
                // TIMEZONE FIX: Store date as YYYY-MM-DD (no time component)
                day.dataset.date = `${year}-${String(monthIndex + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                
                if (dayDate.getTime() === today.getTime()) {
                    day.classList.add('today');
                }
                
                if (bookingState.selectedDate && day.dataset.date === bookingState.selectedDate) {
                    day.classList.add('selected');
                }
                
                if (dayDate < today) {
                    day.classList.add('disabled');
                }
                
                const dayOfWeek = dayDate.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                    day.classList.add('disabled');
                }
                
                const hasBooking = bookingState.userBookings.some(booking => {
                    const bookingDate = new Date(booking.scheduled_at);
                    return bookingDate.toISOString().split('T')[0] === day.dataset.date;
                });
                
                if (hasBooking) {
                    day.classList.add('has-booking');
                }
                
                if (!day.classList.contains('disabled')) {
                    day.addEventListener('click', () => selectDate(day.dataset.date, lang));
                }
                
                calendarGrid.appendChild(day);
            }
            
            const totalCells = calendarGrid.children.length - 7;
            const remainingCells = 42 - totalCells;
            for (let date = 1; date <= remainingCells; date++) {
                const day = document.createElement('div');
                day.className = 'calendar-day other-month';
                day.textContent = date;
                calendarGrid.appendChild(day);
            }
            
            const prevBtn = document.getElementById(`${lang}-calendar-prev`);
            if (prevBtn) {
                const currentMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                prevBtn.disabled = month.getTime() <= currentMonth.getTime();
            }
        }

        async function selectDate(dateStr, lang) {
            console.log('üìÖ Selected date:', dateStr);
            
            bookingState.selectedDate = dateStr;
            bookingState.selectedTime = null;
            
            renderCalendar(lang);
            
            // TIMEZONE FIX: Parse date as local date
            const [year, month, day] = dateStr.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            
            const dateDisplay = lang === 'ja'
                ? `${year}Âπ¥${month}Êúà${day}Êó• (${['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'][date.getDay()]})`
                : date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            const displayElement = document.getElementById(`${lang}-selected-date`);
            if (displayElement) {
                displayElement.textContent = dateDisplay;
            }
            
            await fetchAvailableSlots(dateStr, lang);
        }

        async function fetchAvailableSlots(dateStr, lang) {
            const slotsContainer = document.getElementById(`${lang}-time-slots`);
            if (!slotsContainer) return;
            
            slotsContainer.innerHTML = '<div class="time-slots-loading"><i class="fas fa-spinner fa-spin"></i><p>Ë™≠„ÅøËæº„Åø‰∏≠...</p></div>';
            
            try {
                console.log('üîç Fetching available slots for:', dateStr);
                
                const response = await fetch('https://luyzyzefgintksydmwoh.supabase.co/functions/v1/lesson-booking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${(await supabase.auth.getSession()).data.session.access_token}`
                    },
                    body: JSON.stringify({
                        action: 'getAvailableSlots',
                        bookingData: {
                            date: dateStr
                        }
                    })
                });
                
                const result = await response.json();
                console.log('üì• Slots response:', result);
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch slots');
                }
                
                bookingState.availableSlots = result.slots || [];
                
                renderTimeSlots(lang);
                
            } catch (err) {
                console.error('‚ùå Error fetching slots:', err);
                slotsContainer.innerHTML = `
                    <div class="no-slots-message">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>${lang === 'ja' ? '„Çπ„É≠„ÉÉ„Éà„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü' : 'Failed to load time slots'}</p>
                        <p style="font-size: 0.85rem; color: var(--color-text-muted);">${err.message}</p>
                    </div>
                `;
            }
        }

        function renderTimeSlots(lang) {
            const slotsContainer = document.getElementById(`${lang}-time-slots`);
            if (!slotsContainer) return;
            
            if (bookingState.availableSlots.length === 0) {
                slotsContainer.innerHTML = `
                    <div class="no-slots-message">
                        <i class="fas fa-calendar-times"></i>
                        <p>${lang === 'ja' ? '„Åì„ÅÆÊó•„ÅØÁ©∫„ÅçÊôÇÈñì„Åå„ÅÇ„Çä„Åæ„Åõ„Çì' : 'No available slots for this date'}</p>
                    </div>
                `;
                return;
            }
            
            const morning = bookingState.availableSlots.filter(s => {
                const hour = parseInt(s.display.split(':')[0]);
                return hour < 12;
            });
            
            const afternoon = bookingState.availableSlots.filter(s => {
                const hour = parseInt(s.display.split(':')[0]);
                return hour >= 12 && hour < 18;
            });
            
            const evening = bookingState.availableSlots.filter(s => {
                const hour = parseInt(s.display.split(':')[0]);
                return hour >= 18;
            });
            
            let html = '<div class="time-slots">';
            
            if (morning.length > 0) {
                html += `
                    <div class="time-period">
                        <h4>${lang === 'ja' ? 'ÂçàÂâç' : 'Morning'}</h4>
                        <div class="time-slots-grid">
                            ${morning.map(slot => `
                                <div class="time-slot" data-time="${slot.time}" onclick="selectTimeSlot('${slot.time}', '${lang}')">
                                    ${slot.display}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (afternoon.length > 0) {
                html += `
                    <div class="time-period">
                        <h4>${lang === 'ja' ? 'ÂçàÂæå' : 'Afternoon'}</h4>
                        <div class="time-slots-grid">
                            ${afternoon.map(slot => `
                                <div class="time-slot" data-time="${slot.time}" onclick="selectTimeSlot('${slot.time}', '${lang}')">
                                    ${slot.display}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            if (evening.length > 0) {
                html += `
                    <div class="time-period">
                        <h4>${lang === 'ja' ? 'Â§ú' : 'Evening'}</h4>
                        <div class="time-slots-grid">
                            ${evening.map(slot => `
                                <div class="time-slot" data-time="${slot.time}" onclick="selectTimeSlot('${slot.time}', '${lang}')">
                                    ${slot.display}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            slotsContainer.innerHTML = html;
        }

        window.selectTimeSlot = function(timeStr, lang) {
            console.log('‚è∞ Selected time:', timeStr);
            
            bookingState.selectedTime = timeStr;
            
            document.querySelectorAll(`#${lang}-time-slots .time-slot`).forEach(slot => {
                slot.classList.remove('selected');
            });
            
            const selectedSlot = document.querySelector(`#${lang}-time-slots .time-slot[data-time="${timeStr}"]`);
            if (selectedSlot) {
                selectedSlot.classList.add('selected');
            }
            
            updateBookingSummary(lang);
            
            const bookBtn = document.getElementById(`${lang}-book-btn`);
            if (bookBtn) {
                bookBtn.disabled = false;
            }
        };

        function updateBookingSummary(lang) {
            const lessonType = bookingState.selectedLessonType;
            const summaryContainer = document.getElementById(`${lang}-booking-summary`);
            if (!summaryContainer) return;
            
            let duration, price, useCredit;
            
            if (lessonType === 'consultation') {
                duration = 20;
                price = 0;
                useCredit = false;
            } else {
                duration = 50;
                if (bookingState.availableCredits > 0) {
                    price = 0;
                    useCredit = true;
                } else {
                    price = 4000;
                    useCredit = false;
                }
            }
            
            const dateTime = new Date(bookingState.selectedTime);
            
            const html = `
                <div class="booking-summary-item">
                    <span class="booking-summary-label">${lang === 'ja' ? 'Êó•ÊôÇ' : 'Date & Time'}:</span>
                    <span class="booking-summary-value">${dateTime.toLocaleString(lang === 'ja' ? 'ja-JP' : 'en-US')}</span>
                </div>
                <div class="booking-summary-item">
                    <span class="booking-summary-label">${lang === 'ja' ? 'ÊôÇÈñì' : 'Duration'}:</span>
                    <span class="booking-summary-value">${duration} ${lang === 'ja' ? 'ÂàÜ' : 'minutes'}</span>
                </div>
                <div class="booking-summary-item">
                    <span class="booking-summary-label">${lang === 'ja' ? 'ÊñôÈáë' : 'Price'}:</span>
                    <span class="booking-summary-value ${price === 0 ? 'free' : 'paid'}">
                        ${price === 0 
                            ? (lang === 'ja' ? 'ÁÑ°Êñô' : 'FREE') + (useCredit ? ` (${lang === 'ja' ? '„ÇØ„É¨„Ç∏„ÉÉ„Éà‰ΩøÁî®' : 'Using Credit'})` : '') 
                            : `¬•${price.toLocaleString()}`}
                    </span>
                </div>
            `;
            
            summaryContainer.innerHTML = html;
        }

        async function bookLesson(lang) {
            const btn = document.getElementById(`${lang}-book-btn`);
            if (!btn) return;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ' + (lang === 'ja' ? '‰∫àÁ¥Ñ‰∏≠...' : 'Booking...');
            
            try {
                const lessonType = bookingState.selectedLessonType === 'consultation' ? 'first_time_free' : 'standard';
                
                console.log('üì§ Booking lesson:', {
                    studentId: bookingState.studentId,
                    scheduledAt: bookingState.selectedTime,
                    lessonType: lessonType,
                    duration: bookingState.selectedLessonType === 'consultation' ? 20 : 50
                });
                
                const response = await fetch('https://luyzyzefgintksydmwoh.supabase.co/functions/v1/lesson-booking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${(await supabase.auth.getSession()).data.session.access_token}`
                    },
                    body: JSON.stringify({
                        action: 'create',
                        bookingData: {
                            studentId: bookingState.studentId,
                            scheduledAt: bookingState.selectedTime,
                            lessonType: lessonType,
                            duration: bookingState.selectedLessonType === 'consultation' ? 20 : 50
                        }
                    })
                });
                
                const result = await response.json();
                console.log('üì• Booking response:', result);
                
                if (!result.success) {
                    throw new Error(result.error || 'Booking failed');
                }
                
                alert(lang === 'ja' ? '‰∫àÁ¥Ñ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅÁ¢∫Ë™ç„É°„Éº„É´„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ' : 'Booking confirmed! Check your email for details.');
                
                bookingState.selectedDate = null;
                bookingState.selectedTime = null;
                
                await fetchBookingEligibility(bookingState.studentId, lang);
                await fetchUserBookings(bookingState.userId, lang);
                
                closeBookingModal();
                
            } catch (err) {
                console.error('‚ùå Booking error:', err);
                alert(lang === 'ja' ? `‰∫àÁ¥Ñ„Ç®„É©„Éº: ${err.message}` : `Booking error: ${err.message}`);
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-calendar-check"></i> ' + (lang === 'ja' ? '„É¨„ÉÉ„Çπ„É≥„Çí‰∫àÁ¥Ñ' : 'Book Lesson');
            }
        }

        function renderUserBookings(lang) {
            const container = document.getElementById(`${lang}-bookings-list`);
            if (!container) return;
            
            if (bookingState.userBookings.length === 0) {
                container.innerHTML = `
                    <div class="no-bookings">
                        <i class="fas fa-calendar-alt"></i>
                        <p>${lang === 'ja' ? '‰∫àÁ¥Ñ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì' : 'No upcoming bookings'}</p>
                    </div>
                `;
                return;
            }
            
            const html = bookingState.userBookings.map(booking => {
                const date = new Date(booking.scheduled_at);
                const dateStr = date.toLocaleDateString(lang === 'ja' ? 'ja-JP' : 'en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });
                const timeStr = date.toLocaleTimeString(lang === 'ja' ? 'ja-JP' : 'en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const typeLabel = booking.lesson_type === 'first_time_free'
                    ? (lang === 'ja' ? 'ÁÑ°ÊñôÁõ∏Ë´á' : 'Free Consultation')
                    : (lang === 'ja' ? '„É¨„ÉÉ„Çπ„É≥' : 'Lesson');
                
                return `
                    <div class="booking-item">
                        <div class="booking-info">
                            <div class="booking-date">${dateStr}</div>
                            <div class="booking-time">${timeStr} (${booking.duration_minutes} ${lang === 'ja' ? 'ÂàÜ' : 'min'})</div>
                            <span class="booking-type">${typeLabel}</span>
                        </div>
                        <div class="booking-actions-btns">
                            <button class="booking-action-btn cancel-btn" onclick="cancelBooking('${booking.id}', '${lang}')">
                                ${lang === 'ja' ? '„Ç≠„É£„É≥„Çª„É´' : 'Cancel'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
        }

        window.cancelBooking = async function(bookingId, lang) {
            const confirmMsg = lang === 'ja'
                ? '„Åì„ÅÆ‰∫àÁ¥Ñ„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü'
                : 'Are you sure you want to cancel this booking?';
            
            if (!confirm(confirmMsg)) return;
            
            const reasonMsg = lang === 'ja'
                ? '„Ç≠„É£„É≥„Çª„É´ÁêÜÁî±„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà‰ªªÊÑèÔºâÔºö'
                : 'Cancellation reason (optional):';
            
            const reason = prompt(reasonMsg) || 'No reason provided';
            
            try {
                const response = await fetch('https://luyzyzefgintksydmwoh.supabase.co/functions/v1/lesson-booking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${(await supabase.auth.getSession()).data.session.access_token}`
                    },
                    body: JSON.stringify({
                        action: 'cancel',
                        bookingData: {
                            bookingId: bookingId,
                            reason: reason
                        }
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Cancellation failed');
                }
                
                alert(lang === 'ja' ? '„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åó„Åü„ÄÇ' + (result.refund || '') : 'Booking cancelled. ' + (result.refund || ''));
                
                await fetchBookingEligibility(bookingState.studentId, lang);
                await fetchUserBookings(bookingState.userId, lang);
                renderCalendar(lang);
                
            } catch (err) {
                console.error('Cancellation error:', err);
                alert(lang === 'ja' ? `„Ç≠„É£„É≥„Çª„É´„Ç®„É©„Éº: ${err.message}` : `Cancellation error: ${err.message}`);
            }
        };

        function setupBookingEventListeners(lang) {
            const prevBtn = document.getElementById(`${lang}-calendar-prev`);
            const nextBtn = document.getElementById(`${lang}-calendar-next`);
            const lessonTypeSelect = document.getElementById(`${lang}-lesson-type`);
            const bookBtn = document.getElementById(`${lang}-book-btn`);
            
            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    bookingState.currentMonth.setMonth(bookingState.currentMonth.getMonth() - 1);
                    renderCalendar(lang);
                });
            }
            
            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    bookingState.currentMonth.setMonth(bookingState.currentMonth.getMonth() + 1);
                    renderCalendar(lang);
                });
            }
            
            if (lessonTypeSelect) {
                lessonTypeSelect.addEventListener('change', (e) => {
                    bookingState.selectedLessonType = e.target.value;
                    if (bookingState.selectedTime) {
                        updateBookingSummary(lang);
                    }

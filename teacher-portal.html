<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Teacher Portal | Prokaiwa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    /* Teacher Portal Styles */
    body {
      background: #f5f5f5;
    }
    
    .teacher-header {
      background: var(--color-surface);
      padding: 1rem 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    
    .teacher-header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .teacher-header h1 {
      font-size: 1.5rem;
      color: var(--color-primary);
      margin: 0;
    }
    
    .teacher-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .logout-btn {
      background: var(--color-accent);
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: var(--color-surface);
      padding: 1.5rem;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .stat-card h3 {
      font-size: 2rem;
      color: var(--color-primary);
      margin: 0 0 0.5rem 0;
    }
    
    .stat-card p {
      color: var(--color-text-light);
      margin: 0;
    }
    
    .feedback-section {
      background: var(--color-surface);
      padding: 2rem;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    
    .feedback-section h2 {
      color: var(--color-accent);
      margin-top: 0;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--color-border);
    }
    
    .student-card {
      background: #fafafa;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      transition: all 0.3s;
    }
    
    .student-card.expanded {
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .student-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    
    .student-name {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text);
    }
    
    .student-meta {
      color: var(--color-text-light);
      font-size: 0.9rem;
      margin-top: 0.25rem;
    }
    
    .expand-btn {
      background: var(--color-primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .student-details {
      display: none;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--color-border);
    }
    
    .student-card.expanded .student-details {
      display: block;
    }
    
    /* Filter Bar Styles */
    .filter-bar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    .filter-label {
      font-weight: 600;
      color: var(--color-text);
      margin-right: 0.5rem;
    }
    
    .filter-btn {
      padding: 0.5rem 1rem;
      border: 1px solid var(--color-border);
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    
    .filter-btn:hover {
      background: #f5f5f5;
    }
    
    .filter-btn.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }
    
    .message-count {
      margin-left: auto;
      color: var(--color-text-light);
      font-size: 0.9rem;
      font-style: italic;
    }
    
    .response-item {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    .response-item h4 {
      margin: 0 0 0.5rem 0;
      color: var(--color-primary);
    }
    
    .response-text {
      color: var(--color-text);
      margin: 0.5rem 0;
    }
    
    .audio-player {
      margin-top: 0.5rem;
    }
    
    .feedback-box {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 2px solid var(--color-border);
    }
    
    .template-selector {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .template-btn {
      padding: 0.5rem 1rem;
      border: 1px solid var(--color-border);
      background: white;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .template-btn.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }
    
    .feedback-textarea {
      width: 100%;
      min-height: 300px;
      padding: 1rem;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.95rem;
      resize: vertical;
    }
    
    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .send-btn {
      background: var(--color-primary);
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
    }
    
    .send-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .mark-done-btn {
      background: #4caf50;
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--color-text-light);
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--color-text-light);
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: var(--color-border);
    }
    
    .priority-badge {
      background: #ff9800;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="teacher-header">
    <div class="container">
      <h1>üìö Prokaiwa Teacher Portal</h1>
      <div class="teacher-info">
        <span id="teacher-name">Loading...</span>
        <button class="logout-btn" id="logout-btn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Stats Dashboard -->
    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <h3 id="total-students">-</h3>
        <p>Total Students</p>
      </div>
      <div class="stat-card">
        <h3 id="today-feedback">-</h3>
        <p>Need Feedback Today</p>
      </div>
      <div class="stat-card">
        <h3 id="completed-today">-</h3>
        <p>Completed Today</p>
      </div>
      <div class="stat-card">
        <h3 id="estimated-time">-</h3>
        <p>Estimated Time</p>
      </div>
    </div>

    <!-- Power Pro Section (C2) -->
    <div class="feedback-section" id="plan-c2-section">
      <h2>‚ö° Power Pro - Daily Quick</h2>
      <div id="plan-c2-students" class="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading students...
      </div>
    </div>

    <!-- Power Lite Section (C1) -->
    <div class="feedback-section" id="plan-c1-section">
      <h2>üí° Power Lite - Bi-Weekly</h2>
      <div id="plan-c1-students" class="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading students...
      </div>
    </div>

    <!-- LINE Practice Section (A) -->
    <div class="feedback-section" id="plan-a-section">
      <h2>üì± LINE Practice - Weekly Comprehensive</h2>
      <div id="plan-a-students" class="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading students...
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Initialize Supabase client
    const supabaseClient = supabase.createClient(
      'https://luyzyzefgintksydmwoh.supabase.co', 
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1eXp5emVmZ2ludGtzeWRtd29oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5NzYyMDUsImV4cCI6MjA2ODU1MjIwNX0.he5_j99ZtAj4K_zzgm11NEEv7TrbRJYndJXot25s_Kg'
    );

    let currentTeacher = null;
    let feedbackQueue = { planA: [], planC1: [], planC2: [] };
    let completedToday = new Set();
    let currentFilters = {}; // Track filter per student

    // Feedback Templates
    const templates = {
      weekly: `Week [X] Review üåü

üìà PROGRESS: Completed [X]/7 prompts

üéØ WHAT YOU DID WELL:
- [Natural phrases/pronunciation wins]
- [Grammar improvements]

üìù AREAS TO WORK ON:
- [Common mistakes]
- [Pronunciation practice needed]

üí° THIS WEEK'S FOCUS: [Specific goal]

Keep up the great work! üí™`,

      biweekly: `Day [X] Check-in ‚ú®

Quick review of your last [X] responses:

‚úÖ GOING WELL:
- [Highlight 1-2 wins]

‚ö†Ô∏è WATCH FOR:
- [1 pattern to improve]

üí° PRACTICE TIP: [Quick actionable advice]`,

      daily: `Great work today! üëè

‚úÖ [Specific thing they did well]

üí° Quick tip: [One correction/suggestion]

Tomorrow's focus: [Preview]`
    };

    // ============================================
    // AUTHENTICATION & INITIALIZATION
    // ============================================

    async function checkAuth() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      
      if (!session) {
        window.location.href = '/teacher-login.html';
        return;
      }
      
      // Get teacher info
      const { data: teacher, error } = await supabaseClient
        .from('teachers')
        .select('*')
        .eq('auth_user_id', session.user.id)
        .single();
      
      if (error || !teacher || !teacher.is_active) {
        await supabaseClient.auth.signOut();
        window.location.href = '/teacher-login.html';
        return;
      }
      
      currentTeacher = teacher;
      document.getElementById('teacher-name').textContent = teacher.full_name;
      
      // Load completed feedback from today
      await loadCompletedToday();
      
      // Load feedback queue
      await loadFeedbackQueue();
    }

    // ============================================
    // LOAD COMPLETED FEEDBACK FROM TODAY
    // ============================================

    async function loadCompletedToday() {
      try {
        const todayStart = new Date();
        todayStart.setHours(0, 0, 0, 0);
        
        const { data: todaysFeedback, error } = await supabaseClient
          .from('feedback_log')
          .select('student_id')
          .eq('teacher_id', currentTeacher.id)
          .gte('sent_at', todayStart.toISOString());
        
        if (error) throw error;
        
        // Populate completedToday Set
        completedToday = new Set(todaysFeedback.map(f => f.student_id));
        
      } catch (err) {
        console.error('Error loading completed feedback:', err);
      }
    }

    // ============================================
    // LOAD FEEDBACK QUEUE
    // ============================================

    async function loadFeedbackQueue() {
      try {
        // Get all assigned students with their progress
        const { data: assignments, error: assignError } = await supabaseClient
          .from('student_teacher_assignments')
          .select(`
            student_id,
            questionnaire_responses (
              id,
              user_id,
              given_name_romaji,
              name,
              line_id,
              plan
            )
          `)
          .eq('teacher_id', currentTeacher.id);

        if (assignError) throw assignError;

        const students = assignments.map(a => a.questionnaire_responses).filter(Boolean);

        // Get progress for all students using user_id
        const userIds = students.map(s => s.user_id).filter(Boolean);
        const { data: progressData, error: progressError } = await supabaseClient
          .from('student_progress')
          .select('*')
          .in('user_id', userIds);

        if (progressError) throw progressError;

        // Categorize by plan and feedback need
        feedbackQueue = { planA: [], planC1: [], planC2: [] };

        for (const student of students) {
          const progress = progressData.find(p => p.user_id === student.user_id);
          if (!progress) continue;

          const studentData = {
            ...student,
            ...progress,
            needsFeedback: checkIfNeedsFeedback(student.plan, progress)
          };

          if (studentData.needsFeedback) {
            if (student.plan === 'A') feedbackQueue.planA.push(studentData);
            else if (student.plan === 'C1') feedbackQueue.planC1.push(studentData);
            else if (student.plan === 'C2') feedbackQueue.planC2.push(studentData);
          }
        }

        // Render the queue
        renderFeedbackQueue();
        updateStats();

      } catch (err) {
        console.error('Error loading feedback queue:', err);
        alert('Error loading students. Please refresh the page.');
      }
    }

    // ============================================
    // CHECK IF STUDENT NEEDS FEEDBACK
    // ============================================

    function checkIfNeedsFeedback(plan, progress) {
      const { current_day, total_prompts_sent } = progress;

      if (plan === 'A') {
        // Weekly: Day 7, 14, 21, 28
        return total_prompts_sent % 7 === 0 && current_day === 7;
      } else if (plan === 'C1') {
        // Bi-weekly: Days 3 and 7
        return current_day === 3 || current_day === 7;
      } else if (plan === 'C2') {
        // Daily
        return true;
      }

      return false;
    }

    // ============================================
    // RENDER FEEDBACK QUEUE
    // ============================================

    function renderFeedbackQueue() {
      renderPlanSection('plan-c2-students', feedbackQueue.planC2, 'daily');
      renderPlanSection('plan-c1-students', feedbackQueue.planC1, 'biweekly');
      renderPlanSection('plan-a-students', feedbackQueue.planA, 'weekly');
    }

    function renderPlanSection(containerId, students, templateType) {
      const container = document.getElementById(containerId);
      
      if (students.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-check-circle"></i>
            <p>No students need feedback today!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = students.map(student => createStudentCard(student, templateType)).join('');

      // Add event listeners
      students.forEach(student => {
        const card = document.getElementById(`student-${student.id}`);
        const expandBtn = card.querySelector('.expand-btn');
        const sendBtn = card.querySelector('.send-btn');
        const markDoneBtn = card.querySelector('.mark-done-btn');
        const templateBtns = card.querySelectorAll('.template-btn');

        expandBtn.addEventListener('click', () => toggleCard(student.id));
        sendBtn.addEventListener('click', () => sendFeedback(student.id));
        markDoneBtn.addEventListener('click', () => markComplete(student.id));
        
        templateBtns.forEach(btn => {
          btn.addEventListener('click', () => loadTemplate(student.id, btn.dataset.template));
        });
      });
    }

    function createStudentCard(student, templateType) {
      const isDone = completedToday.has(student.id);
      const isPriority = student.current_day === 7 && student.current_week === 1;

      return `
        <div class="student-card" id="student-${student.id}">
          <div class="student-header">
            <div>
              <div class="student-name">
                ${student.given_name_romaji || student.name}
                ${isPriority ? '<span class="priority-badge">‚≠ê NEW</span>' : ''}
                ${isDone ? '<span class="priority-badge" style="background:#4caf50;">‚úì DONE</span>' : ''}
              </div>
              <div class="student-meta">
                Day ${student.current_day}/Week ${student.current_week} | 
                Total prompts: ${student.total_prompts_sent}
              </div>
            </div>
            <button class="expand-btn">
              ${isDone ? 'View' : 'Send Feedback'} ‚ñº
            </button>
          </div>
          
          <div class="student-details">
            <!-- Filter Bar -->
            <div class="filter-bar" id="filter-bar-${student.id}">
              <span class="filter-label">Show:</span>
              <button class="filter-btn active" data-filter="recent" data-student="${student.id}">
                Since Last Feedback
              </button>
              <button class="filter-btn" data-filter="3" data-student="${student.id}">
                3 Days
              </button>
              <button class="filter-btn" data-filter="7" data-student="${student.id}">
                7 Days
              </button>
              <button class="filter-btn" data-filter="14" data-student="${student.id}">
                14 Days
              </button>
              <button class="filter-btn" data-filter="30" data-student="${student.id}">
                30 Days
              </button>
              <button class="filter-btn" data-filter="all" data-student="${student.id}">
                All
              </button>
              <span class="message-count" id="msg-count-${student.id}"></span>
            </div>
            
            <div id="responses-${student.id}">
              <p>Loading conversation...</p>
            </div>
            
            <div class="feedback-box">
              <h3>Send Feedback</h3>
              <div class="template-selector">
                <button class="template-btn active" data-template="${templateType}">
                  Load Template
                </button>
                <button class="template-btn" data-template="blank">
                  Start Blank
                </button>
              </div>
              
              <textarea 
                class="feedback-textarea" 
                id="feedback-${student.id}"
                placeholder="Write your feedback here..."
              >${templates[templateType]}</textarea>
              
              <div class="action-buttons">
                <button class="send-btn" ${isDone ? 'disabled' : ''}>
                  <i class="fas fa-paper-plane"></i> Send to LINE
                </button>
                <button class="mark-done-btn" ${isDone ? 'disabled' : ''}>
                  <i class="fas fa-check"></i> Mark Complete
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ============================================
    // CARD INTERACTIONS
    // ============================================

    async function toggleCard(studentId) {
      const card = document.getElementById(`student-${studentId}`);
      const isExpanded = card.classList.contains('expanded');

      // Close all other cards
      document.querySelectorAll('.student-card').forEach(c => c.classList.remove('expanded'));

      if (!isExpanded) {
        card.classList.add('expanded');
        
        // Initialize filter to 'recent' if not set
        if (!currentFilters[studentId]) {
          currentFilters[studentId] = 'recent';
        }
        
        await loadStudentResponses(studentId, currentFilters[studentId]);
        
        // Add filter button listeners
        const filterBtns = card.querySelectorAll('.filter-btn');
        filterBtns.forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const filter = e.target.dataset.filter;
            const sid = e.target.dataset.student;
            
            // Update active state
            filterBtns.forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            
            // Update current filter and reload
            currentFilters[sid] = filter;
            await loadStudentResponses(sid, filter);
          });
        });
        
        // Auto-focus feedback textarea
        setTimeout(() => {
          const textarea = document.getElementById(`feedback-${studentId}`);
          if (textarea && !completedToday.has(studentId)) {
            textarea.focus();
          }
        }, 100);
      }
    }

    // ============================================
    // LOAD STUDENT RESPONSES WITH FILTER
    // ============================================

    async function loadStudentResponses(studentId, daysFilter = 'recent') {
      const container = document.getElementById(`responses-${studentId}`);
      const msgCountEl = document.getElementById(`msg-count-${studentId}`);
      container.innerHTML = '<p style="text-align:center; padding:1rem; color:#999;"><i class="fas fa-spinner fa-spin"></i> Loading...</p>';

      try {
        const student = [...feedbackQueue.planA, ...feedbackQueue.planC1, ...feedbackQueue.planC2]
          .find(s => s.id === studentId);
        
        if (!student || !student.user_id) {
          container.innerHTML = '<p>Error: Could not find student data.</p>';
          return;
        }

        // Calculate date range based on filter
        let startDate;
        
        if (daysFilter === 'recent') {
          // Get last feedback date OR 3 days ago
          const { data: lastFeedback } = await supabaseClient
            .from('feedback_log')
            .select('sent_at')
            .eq('student_id', studentId)
            .order('sent_at', { ascending: false })
            .limit(1)
            .single();
          
          if (lastFeedback) {
            startDate = new Date(lastFeedback.sent_at);
          } else {
            // No feedback yet, show last 3 days
            startDate = new Date(Date.now() - 3 * 24 * 60 * 60 * 1000);
          }
        } else if (daysFilter === 'all') {
          startDate = new Date('2000-01-01'); // Very old date
        } else {
          // Specific number of days
          const days = parseInt(daysFilter);
          startDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
        }

        // Get messages
        const { data: messages, error } = await supabaseClient
          .from('message_log')
          .select('*')
          .eq('user_id', student.user_id)
          .in('message_type', ['prompt', 'student_response'])
          .gte('created_at', startDate.toISOString())
          .order('created_at', { ascending: true });

        if (error) throw error;

        // Get teacher feedback
        const { data: teacherFeedback, error: feedbackError } = await supabaseClient
          .from('feedback_log')
          .select('*')
          .eq('student_id', studentId)
          .gte('sent_at', startDate.toISOString())
          .order('sent_at', { ascending: true });

        if (feedbackError) console.error('Error loading feedback:', feedbackError);

        // Combine messages and feedback
        const allMessages = [
          ...messages.map(m => ({ ...m, type: 'message', created_at: m.created_at })),
          ...(teacherFeedback || []).map(f => ({ ...f, type: 'feedback', created_at: f.sent_at }))
        ].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

        // Update message count
        if (msgCountEl) {
          msgCountEl.textContent = `Showing ${allMessages.length} message${allMessages.length !== 1 ? 's' : ''}`;
        }

        if (allMessages.length === 0) {
          container.innerHTML = '<p style="text-align:center; padding:2rem; color:#999;">No conversation history in this time range.</p>';
          return;
        }

        // Group messages by date
        const messagesByDate = {};
        allMessages.forEach(msg => {
          const date = new Date(msg.created_at).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          });
          if (!messagesByDate[date]) messagesByDate[date] = [];
          messagesByDate[date].push(msg);
        });

        // Render as conversation
        let html = '';
        Object.entries(messagesByDate).reverse().forEach(([date, msgs]) => {
          html += `<div style="margin-bottom: 2rem;">
            <h4 style="color: #666; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">
              üìÖ ${date}
            </h4>`;
          
          msgs.forEach(msg => {
            const time = new Date(msg.created_at).toLocaleTimeString('en-US', { 
              hour: '2-digit', 
              minute: '2-digit' 
            });
            
            if (msg.type === 'message' && msg.message_type === 'prompt') {
              // Prompt from bot
              html += `
                <div style="margin: 1rem 0; padding: 1rem; background: #f0f8ff; border-left: 3px solid #4A90E2; border-radius: 4px;">
                  <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">
                    [${time}] ü§ñ <strong>Prompt:</strong>
                  </div>
                  <p style="margin: 0; color: #333;">"${msg.message_text}"</p>
                </div>`;
            } else if (msg.type === 'message' && msg.message_type === 'student_response') {
              // Student response
              html += `
                <div style="margin: 1rem 0; padding: 1rem; background: #fff; border: 1px solid #e0e0e0; border-radius: 4px;">
                  <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">
                    [${time}] üë§ <strong>${student.given_name_romaji || student.name}:</strong>
                  </div>`;
              
              if (msg.message_text) {
                html += `<p style="margin: 0.5rem 0; color: #333;">"${msg.message_text}"</p>`;
              }
              
              if (msg.media_type === 'audio') {
                html += `
                  <div style="margin-top: 0.5rem;">
                    <audio controls style="width: 100%; max-width: 400px;">
                      <source src="https://luyzyzefgintksydmwoh.supabase.co/functions/v1/get-line-media?messageId=${msg.message_id}">
                      Your browser does not support audio playback.
                    </audio>
                  </div>`;
              }
              
              if (msg.media_type === 'video') {
                html += `
                  <div style="margin-top: 0.5rem;">
                    <video controls style="width: 100%; max-width: 400px; border-radius: 8px;">
                      <source src="https://luyzyzefgintksydmwoh.supabase.co/functions/v1/get-line-media?messageId=${msg.message_id}">
                      Your browser does not support video playback.
                    </video>
                  </div>`;
              }
              
              if (msg.media_type === 'image') {
                html += `
                  <div style="margin-top: 0.5rem;">
                    <img src="https://luyzyzefgintksydmwoh.supabase.co/functions/v1/get-line-media?messageId=${msg.message_id}" 
                         style="max-width: 100%; border-radius: 8px; cursor: pointer;"
                         onclick="window.open(this.src, '_blank')"
                         alt="Student response image">
                  </div>`;
              }
              
              html += `</div>`;
            } else if (msg.type === 'feedback') {
              // Teacher feedback
              html += `
                <div style="margin: 1rem 0; padding: 1rem; background: #f0fff0; border-left: 3px solid #4caf50; border-radius: 4px;">
                  <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">
                    [${time}] üë®‚Äçüè´ <strong>Teacher Feedback:</strong>
                  </div>
                  <p style="margin: 0; color: #333; white-space: pre-wrap;">${msg.feedback_text}</p>
                </div>`;
            }
          });
          
          html += `</div>`;
        });

        container.innerHTML = html;

      } catch (err) {
        console.error('Error loading conversation:', err);
        container.innerHTML = '<p style="color:red;">Error loading conversation history.</p>';
      }
    }

    function loadTemplate(studentId, templateType) {
      const textarea = document.getElementById(`feedback-${studentId}`);
      const card = document.getElementById(`student-${studentId}`);
      const templateBtns = card.querySelectorAll('.template-btn');

      templateBtns.forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      if (templateType === 'blank') {
        textarea.value = '';
      } else {
        textarea.value = templates[templateType];
      }
    }

    // ============================================
    // SEND FEEDBACK
    // ============================================

    async function sendFeedback(studentId) {
      const textarea = document.getElementById(`feedback-${studentId}`);
      const feedbackText = textarea.value.trim();

      if (!feedbackText) {
        alert('Please write some feedback first!');
        return;
      }

      if (!confirm('Send this feedback to the student via LINE?')) {
        return;
      }

      const sendBtn = event.target;
      const originalHTML = sendBtn.innerHTML;
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

      try {
        // Call Edge Function to send to LINE
        const response = await fetch('https://luyzyzefgintksydmwoh.supabase.co/functions/v1/send-teacher-feedback', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${(await supabaseClient.auth.getSession()).data.session.access_token}`
          },
          body: JSON.stringify({
            studentId,
            feedbackText,
            teacherId: currentTeacher.id
          })
        });

        if (!response.ok) throw new Error('Failed to send feedback');

        // Auto-mark as complete
        completedToday.add(studentId);
        
        alert('Feedback sent successfully!');
        
        // Reload the queue to update UI
        await loadFeedbackQueue();

      } catch (err) {
        console.error('Error sending feedback:', err);
        alert('Error sending feedback. Please try again.');
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalHTML;
      }
    }

    async function markComplete(studentId) {
      completedToday.add(studentId);
      await loadFeedbackQueue();
      updateStats();
    }

    // ============================================
    // UPDATE STATS
    // ============================================

    function updateStats() {
      const totalStudents = feedbackQueue.planA.length + feedbackQueue.planC1.length + feedbackQueue.planC2.length;
      const completed = completedToday.size;
      
      // Estimate time: 12 min for weekly, 5 min for biweekly, 3 min for daily
      const remainingA = feedbackQueue.planA.filter(s => !completedToday.has(s.id)).length;
      const remainingC1 = feedbackQueue.planC1.filter(s => !completedToday.has(s.id)).length;
      const remainingC2 = feedbackQueue.planC2.filter(s => !completedToday.has(s.id)).length;
      
      const estimatedMinutes = 
        (remainingA * 12) +
        (remainingC1 * 5) +
        (remainingC2 * 3);
      
      const hours = Math.floor(estimatedMinutes / 60);
      const minutes = estimatedMinutes % 60;

      document.getElementById('total-students').textContent = totalStudents;
      document.getElementById('today-feedback').textContent = totalStudents;
      document.getElementById('completed-today').textContent = `${completed}/${totalStudents}`;
      document.getElementById('estimated-time').textContent = estimatedMinutes > 0 
        ? (hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`)
        : '0m';
    }

    // ============================================
    // LOGOUT
    // ============================================

    document.getElementById('logout-btn').addEventListener('click', async () => {
      if (confirm('Are you sure you want to logout?')) {
        await supabaseClient.auth.signOut();
        window.location.href = '/teacher-login.html';
      }
    });

    // ============================================
    // INITIALIZE
    // ============================================

    checkAuth();

    // Auto-refresh every 5 minutes
    setInterval(loadFeedbackQueue, 5 * 60 * 1000);
  </script>
</body>
</html>

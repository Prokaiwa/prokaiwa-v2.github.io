<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Teacher Portal | Prokaiwa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="assets/images/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <style>
    /* Teacher Portal Styles */
    body {
      background: #f5f5f5;
    }
    
    .teacher-header {
      background: var(--color-surface);
      padding: 1rem 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    
    .teacher-header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .teacher-header h1 {
      font-size: 1.5rem;
      color: var(--color-primary);
      margin: 0;
    }
    
    .teacher-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .logout-btn {
      background: var(--color-accent);
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: var(--color-surface);
      padding: 1.5rem;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .stat-card h3 {
      font-size: 2rem;
      color: var(--color-primary);
      margin: 0 0 0.5rem 0;
    }
    
    .stat-card p {
      color: var(--color-text-light);
      margin: 0;
    }
    
    .feedback-section {
      background: var(--color-surface);
      padding: 2rem;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }
    
    .feedback-section h2 {
      color: var(--color-accent);
      margin-top: 0;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--color-border);
    }
    
    .student-card {
      background: #fafafa;
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      transition: all 0.3s;
    }
    
    .student-card.expanded {
      background: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .student-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    
    .student-name {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text);
    }
    
    .student-meta {
      color: var(--color-text-light);
      font-size: 0.9rem;
      margin-top: 0.25rem;
    }
    
    .expand-btn {
      background: var(--color-primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .student-details {
      display: none;
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--color-border);
    }
    
    .student-card.expanded .student-details {
      display: block;
    }
    
    /* Filter Bar Styles */
    .filter-bar {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    .filter-label {
      font-weight: 600;
      color: var(--color-text);
      margin-right: 0.5rem;
    }
    
    .filter-btn {
      padding: 0.5rem 1rem;
      border: 1px solid var(--color-border);
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    
    .filter-btn:hover {
      background: #f5f5f5;
    }
    
    .filter-btn.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }
    
    .message-count {
      margin-left: auto;
      color: var(--color-text-light);
      font-size: 0.9rem;
      font-style: italic;
    }
    
    .response-item {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    .response-item h4 {
      margin: 0 0 0.5rem 0;
      color: var(--color-primary);
    }
    
    .response-text {
      color: var(--color-text);
      margin: 0.5rem 0;
    }
    
    .audio-player {
      margin-top: 0.5rem;
    }
    
    .feedback-box {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 2px solid var(--color-border);
    }
    
    .template-selector {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .template-btn {
      padding: 0.5rem 1rem;
      border: 1px solid var(--color-border);
      background: white;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .template-btn.active {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }
    
    .feedback-textarea {
      width: 100%;
      min-height: 300px;
      padding: 1rem;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.95rem;
      resize: vertical;
    }
    
    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .send-btn {
      background: var(--color-primary);
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
    }
    
    .send-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .mark-done-btn {
      background: #4caf50;
      color: white;
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .loading {
      text-align: center;
      padding: 2rem;
      color: var(--color-text-light);
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem;
      color: var(--color-text-light);
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      color: var(--color-border);
    }
    
    .priority-badge {
      background: #ff9800;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }
  /* ============================================ */
/* MOBILE RESPONSIVE STYLES */
/* ============================================ */

 /* Default - Desktop */
.filter-buttons-desktop {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.filter-select-mobile {
  display: none;
}

.filter-text-mobile {
  display: none;
}   
@media (max-width: 768px) {
  /* Header */
  .teacher-header h1 {
    font-size: 1.2rem;
  }
  
  .teacher-info {
    flex-direction: column;
    align-items: flex-end;
    gap: 0.5rem;
  }
  
  #teacher-name {
    font-size: 0.9rem;
  }
  
  .logout-btn {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
  }
  
  /* Stats Grid - Single column on mobile */
  .stats-grid {
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }
  
  .stat-card {
    padding: 1rem;
  }
  
  .stat-card h3 {
    font-size: 1.5rem;
  }
  
  .stat-card p {
    font-size: 0.85rem;
  }
  
  /* Feedback Sections */
  .feedback-section {
    padding: 1.25rem;
    margin-bottom: 1.5rem;
  }
  
  .feedback-section h2 {
    font-size: 1.1rem;
  }
  
  /* Student Cards */
  .student-card {
    padding: 1rem;
  }
  
  .student-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 1rem;
  }
  
  .student-name {
    font-size: 1.1rem;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
  }
  
  .student-meta {
    font-size: 0.85rem;
    margin-top: 0.5rem;
  }
  
  .priority-badge {
    font-size: 0.75rem;
    padding: 0.2rem 0.6rem;
    margin-left: 0;
    display: inline-block;
  }
  
  .expand-btn {
    width: 100%;
    padding: 0.6rem 1rem;
  }
  
  /* Filter Bar */
  .filter-bar {
    gap: 0.4rem;
  }
  
  .filter-label {
    width: 100%;
    margin-bottom: 0.25rem;
  }
  
  /* Hide desktop filter buttons on mobile */
  .filter-buttons-desktop {
    display: none;
  }
  
  /* Show mobile dropdown */
  .filter-select-mobile {
    display: block;
    width: 100%;
    padding: 0.6rem;
    font-size: 0.95rem;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    background: white;
    cursor: pointer;
  }
  
  .message-count {
    width: 100%;
    margin-left: 0;
    margin-top: 0.5rem;
    text-align: center;
  }
  
  /* Template Selector */
  .template-selector {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .template-btn {
    width: 100%;
  }
  
  /* Feedback Textarea */
  .feedback-textarea {
    min-height: 200px;
    font-size: 0.9rem;
  }
  
  /* Action Buttons */
  .action-buttons {
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .send-btn,
  .mark-done-btn {
    width: 100%;
    padding: 0.75rem;
    font-size: 0.95rem;
  }
  
  /* Conversation Messages */
  .student-details h3 {
    font-size: 1rem;
  }
  
  .feedback-box h3 {
    font-size: 1rem;
  }
}

/* Extra small phones */
@media (max-width: 380px) {
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  .filter-btn {
    font-size: 0.75rem;
    padding: 0.35rem 0.5rem;
  }
}
    /* Assessment Modal */
.assessment-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  z-index: 1000;
  overflow-y: auto;
}

.assessment-modal.active {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2rem;
}

.assessment-content {
  background: var(--color-surface);
  border-radius: 12px;
  width: 100%;
  max-width: 700px;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
}

.assessment-header {
  padding: 2rem 2rem 1rem;
  border-bottom: 2px solid var(--color-border);
  position: sticky;
  top: 0;
  background: var(--color-surface);
  z-index: 10;
}

.assessment-header h2 {
  margin: 0 0 0.5rem 0;
  color: var(--color-primary);
}

.assessment-header p {
  margin: 0;
  color: var(--color-text-light);
}

.assessment-close {
  position: absolute;
  top: 1rem;
  right: 1.5rem;
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--color-text-light);
  cursor: pointer;
  width: 2rem;
  height: 2rem;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  transition: all 0.2s;
  z-index: 20;
}

.assessment-close:hover {
  background: var(--color-border);
  color: var(--color-text);
}

.assessment-body {
  padding: 2rem;
}

.skill-section {
  margin-bottom: 2rem;
  padding-bottom: 2rem;
  border-bottom: 1px solid var(--color-border);
}

.skill-section:last-child {
  border-bottom: none;
}

.skill-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.skill-name {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--color-text);
}

.skill-icon {
  font-size: 1.5rem;
  margin-right: 0.5rem;
}

.skill-scores {
  display: flex;
  gap: 1rem;
  font-size: 0.85rem;
  color: var(--color-text-light);
}

.skill-scores span {
  background: var(--color-bg);
  padding: 0.25rem 0.75rem;
  border-radius: 12px;
}

.show-guide-btn {
  background: var(--color-primary-light);
  color: var(--color-primary);
  border: none;
  padding: 0.4rem 0.75rem;
  border-radius: 6px;
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 600;
}

.show-guide-btn:hover {
  background: var(--color-primary);
  color: white;
}

.slider-container {
  position: relative;
  margin: 1rem 0;
}

.skill-slider {
  width: 100%;
  height: 8px;
  border-radius: 4px;
  background: var(--color-border);
  outline: none;
  -webkit-appearance: none;
  cursor: pointer;
}

.skill-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--color-primary);
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  transition: all 0.2s;
}

.skill-slider::-webkit-slider-thumb:hover {
  transform: scale(1.2);
  box-shadow: 0 4px 12px rgba(0, 128, 128, 0.4);
}

.skill-slider::-moz-range-thumb {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--color-primary);
  cursor: pointer;
  border: none;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  transition: all 0.2s;
}

.slider-labels {
  display: flex;
  justify-content: space-between;
  font-size: 0.75rem;
  color: var(--color-text-muted);
  margin-top: 0.5rem;
}

.current-score {
  text-align: center;
  margin-top: 0.5rem;
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--color-primary);
}

.band-labels {
  display: flex;
  justify-content: space-between;
  font-size: 0.7rem;
  color: var(--color-text-muted);
  margin-top: 0.25rem;
  padding: 0 0.5rem;
}

.assessment-summary {
  background: var(--color-primary-light);
  padding: 1.5rem;
  border-radius: 8px;
  margin-bottom: 2rem;
}

.summary-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  margin-top: 1rem;
}

.summary-item {
  text-align: center;
}

.summary-value {
  font-size: 1.75rem;
  font-weight: 700;
  color: var(--color-primary);
  display: block;
}

.summary-label {
  font-size: 0.85rem;
  color: var(--color-text-light);
}

.notes-section {
  margin-bottom: 2rem;
}

.notes-section label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: var(--color-text);
}

.notes-textarea {
  width: 100%;
  min-height: 120px;
  padding: 1rem;
  border: 1px solid var(--color-border);
  border-radius: 8px;
  font-family: var(--font-primary);
  font-size: 0.95rem;
  resize: vertical;
}

.assessment-actions {
  display: flex;
  gap: 1rem;
  padding: 1.5rem 2rem;
  background: var(--color-bg);
  border-top: 1px solid var(--color-border);
  position: sticky;
  bottom: 0;
}

.submit-assessment-btn {
  flex: 1;
  background: var(--color-primary);
  color: white;
  border: none;
  padding: 1rem;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
}

.submit-assessment-btn:hover {
  background: var(--color-primary-dark);
  transform: translateY(-2px);
}

.submit-assessment-btn:disabled {
  background: #ccc;
  cursor: not-allowed;
  transform: none;
}

.cancel-assessment-btn {
  background: var(--color-surface);
  color: var(--color-text);
  border: 1px solid var(--color-border);
  padding: 1rem 2rem;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
}

.guide-popup {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 2000;
  overflow-y: auto;
}

.guide-popup.active {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2rem;
}

.guide-content {
  background: var(--color-surface);
  border-radius: 12px;
  width: 100%;
  max-width: 600px;
  padding: 2rem;
  position: relative;
  max-height: 80vh;
  overflow-y: auto;
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
}

.guide-close {
  position: sticky;
  top: 1rem;
  right: 1rem;
  float: right;
  margin-bottom: -1rem;
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--color-text-light);
  cursor: pointer;
  z-index: 10;
  padding: 0.5rem;
}

.guide-close:hover {
  color: var(--color-text);
  background: var(--color-border);
  border-radius: 4px;
}

.guide-content h3 {
  color: var(--color-primary);
  margin-top: 0;
}

.guide-level {
  margin-bottom: 1.5rem;
  padding: 1rem;
  background: var(--color-bg);
  border-radius: 8px;
}

.guide-level h4 {
  margin: 0 0 0.5rem 0;
  color: var(--color-accent);
}

.guide-level p {
  margin: 0;
  color: var(--color-text);
  line-height: 1.6;
}

@media (max-width: 768px) {
  .assessment-modal.active {
    padding: 0;
  }
  
  .assessment-content {
    max-width: 100%;
    max-height: 100vh;
    border-radius: 0;
  }
  
  .assessment-header,
  .assessment-body,
  .assessment-actions {
    padding: 1.5rem;
  }
  
  .summary-grid {
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }
  
  .assessment-actions {
    flex-direction: column;
  }
  
  .skill-scores {
    flex-direction: column;
    gap: 0.5rem;
  }
}
    /* Video Lessons Section */
.video-lessons-section {
  background: var(--color-surface);
  padding: 2rem;
  border-radius: var(--border-radius);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin-bottom: 2rem;
}

.video-lessons-section h2 {
  color: var(--color-accent);
  margin-top: 0;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid var(--color-border);
}

.pending-alert {
  background: #ff9800;
  color: white;
  padding: 1rem 1.5rem;
  border-radius: 8px;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
  transition: all 0.2s;
}

.pending-alert:hover {
  background: #f57c00;
  transform: translateY(-2px);
}

.pending-alert i {
  font-size: 1.5rem;
  margin-right: 1rem;
}

.lesson-card {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 8px;
  padding: 1.5rem;
  margin-bottom: 1rem;
  color: var(--color-text);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.lesson-card.needs-link {
  border-left: 4px solid #ff9800;
  animation: pulse-border 2s infinite;
}

@keyframes pulse-border {
  0%, 100% { border-left-color: #ff9800; }
  50% { border-left-color: #ffc107; }
}

.lesson-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.lesson-student {
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--color-primary);
}

.lesson-datetime {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin: 0.5rem 0;
  color: var(--color-text-light);
}

.lesson-datetime i {
  color: var(--color-primary);
}

.lesson-status {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  border-radius: 12px;
  font-size: 0.85rem;
  font-weight: 600;
}

.lesson-status.has-link {
  background: #4caf50;
  color: white;
}

.lesson-status.no-link {
  background: #ff9800;
  color: white;
}

.lesson-actions {
  display: flex;
  gap: 0.5rem;
  margin-top: 1rem;
}

.add-link-btn {
  background: var(--color-primary);
  color: white;
  border: none;
  padding: 0.6rem 1.2rem;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.2s;
}

.add-link-btn:hover {
  background: var(--color-primary-dark);
  transform: translateY(-2px);
}

.join-meeting-btn {
  background: #4caf50;
  color: white;
  border: none;
  padding: 0.6rem 1.2rem;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.join-meeting-btn:hover {
  background: #45a049;
}

/* Meet Link Modal */
.meet-link-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 2000;
  overflow-y: auto;
}

.meet-link-modal.active {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2rem;
}

.meet-link-content {
  background: var(--color-surface);
  border-radius: 12px;
  width: 100%;
  max-width: 500px;
  padding: 2rem;
  position: relative;
}

.meet-link-content h3 {
  margin-top: 0;
  color: var(--color-primary);
}

.meet-link-input {
  width: 100%;
  padding: 0.75rem;
  border: 2px solid var(--color-border);
  border-radius: 8px;
  font-size: 1rem;
  margin: 1rem 0;
}

.meet-link-input:focus {
  outline: none;
  border-color: var(--color-primary);
}

.meet-link-actions {
  display: flex;
  gap: 1rem;
  margin-top: 1.5rem;
}

.save-link-btn {
  flex: 1;
  background: var(--color-primary);
  color: white;
  border: none;
  padding: 0.75rem;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
}

.cancel-link-btn {
  background: var(--color-border);
  color: var(--color-text);
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
}

@media (max-width: 768px) {
  .lesson-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
  
  .lesson-actions {
    flex-direction: column;
    width: 100%;
  }
  
  .add-link-btn,
  .join-meeting-btn {
    width: 100%;
    justify-content: center;
  }
}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="teacher-header">
    <div class="container">
      <h1>üìö Prokaiwa Teacher Portal</h1>
      <div class="teacher-info">
        <span id="teacher-name">Loading...</span>
        <button class="logout-btn" id="logout-btn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Stats Dashboard -->
    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <h3 id="total-students">-</h3>
        <p>Total Students</p>
      </div>
      <div class="stat-card">
        <h3 id="today-feedback">-</h3>
        <p>Need Feedback Today</p>
      </div>
      <div class="stat-card">
        <h3 id="completed-today">-</h3>
        <p>Completed Today</p>
      </div>
      <div class="stat-card">
        <h3 id="estimated-time">-</h3>
        <p>Estimated Time</p>
      </div>
    </div>
    
    <!-- Pending Bookings Alert -->
    <div id="pending-alert" style="display: none;">
      <!-- Will be populated if there are pending bookings -->
    </div>

    <!-- Video Lessons Section -->
    <div class="video-lessons-section" id="video-lessons-section">
      <h2>üìπ Upcoming Video Lessons</h2>
      <div id="video-lessons-list">
        <p style="text-align: center; opacity: 0.8;">
          <i class="fas fa-spinner fa-spin"></i> Loading lessons...
        </p>
      </div>
    </div>


    <!-- Power Pro Section (C2) -->
    <div class="feedback-section" id="plan-c2-section">
      <h2>‚ö° Power Pro - Daily Quick</h2>
      <div id="plan-c2-students" class="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading students...
      </div>
    </div>

    <!-- Power Lite Section (C1) -->
    <div class="feedback-section" id="plan-c1-section">
      <h2>üí° Power Lite - Bi-Weekly</h2>
      <div id="plan-c1-students" class="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading students...
      </div>
    </div>

    <!-- LINE Practice Section (A) -->
    <div class="feedback-section" id="plan-a-section">
      <h2>üì± LINE Practice - Weekly Comprehensive</h2>
      <div id="plan-a-students" class="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading students...
      </div>
    </div>
    <!-- Assessment Modal -->
  <div id="assessment-modal" class="assessment-modal">
    <div class="assessment-content">
      <div class="assessment-header">
        <h2>Assess Student Skills</h2>
        <p id="assessment-student-name">Loading...</p>
        <button class="assessment-close" onclick="closeAssessmentModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="assessment-body">
        <!-- Summary -->
        <div class="assessment-summary">
          <h3 style="margin: 0 0 0.5rem 0;">Overall Assessment</h3>
          <div class="summary-grid">
            <div class="summary-item">
              <span class="summary-value" id="total-score">0</span>
              <span class="summary-label">Total Score</span>
            </div>
            <div class="summary-item">
              <span class="summary-value" id="overall-band">-</span>
              <span class="summary-label">Level Band</span>
            </div>
            <div class="summary-item">
              <span class="summary-value" id="score-change">-</span>
              <span class="summary-label">Change</span>
            </div>
          </div>
        </div>

        <!-- Fluency -->
        <div class="skill-section">
          <div class="skill-header">
            <div>
              <span class="skill-icon">üåä</span>
              <span class="skill-name">Fluency</span>
            </div>
            <div class="skill-scores">
              <span>Previous: <strong id="fluency-prev">-</strong></span>
              <span>Suggested: <strong id="fluency-suggested">-</strong></span>
            </div>
          </div>
          <button class="show-guide-btn" onclick="showGuide('fluency')">
            <i class="fas fa-book"></i> Show Guide
          </button>
          <div class="slider-container">
            <input type="range" min="0" max="10" value="5" class="skill-slider" id="fluency-slider">
            <div class="slider-labels">
              <span>0</span>
              <span>2</span>
              <span>5</span>
              <span>8</span>
              <span>10</span>
            </div>
            <div class="band-labels">
              <span>Super Beg</span>
              <span>Beginner</span>
              <span>Intermediate</span>
              <span>Advanced</span>
            </div>
            <div class="current-score" id="fluency-score">5</div>
          </div>
        </div>

        <!-- Grammar -->
        <div class="skill-section">
          <div class="skill-header">
            <div>
              <span class="skill-icon">üìê</span>
              <span class="skill-name">Grammar</span>
            </div>
            <div class="skill-scores">
              <span>Previous: <strong id="grammar-prev">-</strong></span>
              <span>Suggested: <strong id="grammar-suggested">-</strong></span>
            </div>
          </div>
          <button class="show-guide-btn" onclick="showGuide('grammar')">
            <i class="fas fa-book"></i> Show Guide
          </button>
          <div class="slider-container">
            <input type="range" min="0" max="10" value="5" class="skill-slider" id="grammar-slider">
            <div class="slider-labels">
              <span>0</span>
              <span>2</span>
              <span>5</span>
              <span>8</span>
              <span>10</span>
            </div>
            <div class="band-labels">
              <span>Super Beg</span>
              <span>Beginner</span>
              <span>Intermediate</span>
              <span>Advanced</span>
            </div>
            <div class="current-score" id="grammar-score">5</div>
          </div>
        </div>

        <!-- Comprehension -->
        <div class="skill-section">
          <div class="skill-header">
            <div>
              <span class="skill-icon">üß†</span>
              <span class="skill-name">Comprehension</span>
            </div>
            <div class="skill-scores">
              <span>Previous: <strong id="comprehension-prev">-</strong></span>
              <span>Suggested: <strong id="comprehension-suggested">-</strong></span>
            </div>
          </div>
          <button class="show-guide-btn" onclick="showGuide('comprehension')">
            <i class="fas fa-book"></i> Show Guide
          </button>
          <div class="slider-container">
            <input type="range" min="0" max="10" value="5" class="skill-slider" id="comprehension-slider">
            <div class="slider-labels">
              <span>0</span>
              <span>2</span>
              <span>5</span>
              <span>8</span>
              <span>10</span>
            </div>
            <div class="band-labels">
              <span>Super Beg</span>
              <span>Beginner</span>
              <span>Intermediate</span>
              <span>Advanced</span>
            </div>
            <div class="current-score" id="comprehension-score">5</div>
          </div>
        </div>

        <!-- Vocabulary -->
        <div class="skill-section">
          <div class="skill-header">
            <div>
              <span class="skill-icon">üí¨</span>
              <span class="skill-name">Vocabulary</span>
            </div>
            <div class="skill-scores">
              <span>Previous: <strong id="vocabulary-prev">-</strong></span>
              <span>Suggested: <strong id="vocabulary-suggested">-</strong></span>
            </div>
          </div>
          <button class="show-guide-btn" onclick="showGuide('vocabulary')">
            <i class="fas fa-book"></i> Show Guide
          </button>
          <div class="slider-container">
            <input type="range" min="0" max="10" value="5" class="skill-slider" id="vocabulary-slider">
            <div class="slider-labels">
              <span>0</span>
              <span>2</span>
              <span>5</span>
              <span>8</span>
              <span>10</span>
            </div>
            <div class="band-labels">
              <span>Super Beg</span>
              <span>Beginner</span>
              <span>Intermediate</span>
              <span>Advanced</span>
            </div>
            <div class="current-score" id="vocabulary-score">5</div>
          </div>
        </div>

        <!-- Pronunciation -->
        <div class="skill-section">
          <div class="skill-header">
            <div>
              <span class="skill-icon">üé§</span>
              <span class="skill-name">Pronunciation</span>
            </div>
            <div class="skill-scores">
              <span>Previous: <strong id="pronunciation-prev">-</strong></span>
              <span>Suggested: <strong id="pronunciation-suggested">-</strong></span>
            </div>
          </div>
          <button class="show-guide-btn" onclick="showGuide('pronunciation')">
            <i class="fas fa-book"></i> Show Guide
          </button>
          <div class="slider-container">
            <input type="range" min="0" max="10" value="5" class="skill-slider" id="pronunciation-slider">
            <div class="slider-labels">
              <span>0</span>
              <span>2</span>
              <span>5</span>
              <span>8</span>
              <span>10</span>
            </div>
            <div class="band-labels">
              <span>Super Beg</span>
              <span>Beginner</span>
              <span>Intermediate</span>
              <span>Advanced</span>
            </div>
            <div class="current-score" id="pronunciation-score">5</div>
          </div>
        </div>

        <!-- Notes -->
        <div class="notes-section">
          <label for="assessment-notes">Teacher Notes (Optional)</label>
          <textarea id="assessment-notes" class="notes-textarea" placeholder="Add any observations, strengths, or areas to focus on..."></textarea>
        </div>
      </div>

      <div class="assessment-actions">
        <button class="cancel-assessment-btn" onclick="closeAssessmentModal()">Cancel</button>
        <button class="submit-assessment-btn" id="submit-assessment-btn" onclick="submitAssessment()">
          <i class="fas fa-save"></i> Save Assessment
        </button>
      </div>
    </div>
  </div>

  <!-- Guide Popup -->
  <div id="guide-popup" class="guide-popup">
    <div class="guide-content">
      <button class="guide-close" onclick="closeGuide()">
        <i class="fas fa-times"></i>
      </button>
      <div id="guide-body">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>
  </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Initialize Supabase client
    const supabaseClient = supabase.createClient(
      'https://luyzyzefgintksydmwoh.supabase.co', 
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1eXp5emVmZ2ludGtzeWRtd29oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5NzYyMDUsImV4cCI6MjA2ODU1MjIwNX0.he5_j99ZtAj4K_zzgm11NEEv7TrbRJYndJXot25s_Kg'
    );

    let currentTeacher = null;
    let feedbackQueue = { planA: [], planC1: [], planC2: [] };
    let completedToday = new Set();
    let currentFilters = {}; // Track filter per student

    // Feedback Templates
    const templates = {
      weekly: `Week [X] Review - Comprehensive Feedback üåü

üìä WEEKLY OVERVIEW:
Completed [X]/7 prompts this week
Overall improvement: [Brief summary of progress]

üéØ MAJOR STRENGTHS THIS WEEK:
1. [Specific example with day/prompt reference]
2. [Another strength - be specific]
3. [Another strength - be specific]

üìù PATTERNS TO IMPROVE:
1. [Common error/pattern across multiple days]
   ‚Üí Example: [Specific instance from Day X]
   ‚Üí Practice tip: [How to fix it]
   
2. [Another pattern]
   ‚Üí Example: [Specific instance]
   ‚Üí Practice tip: [How to fix it]

üîç SKILL BREAKDOWN:

üí¨ Fluency & Natural Speaking:
[Observations about speaking flow, hesitation, conversation pace]

üìê Grammar & Sentence Structure:
[Common mistakes, improvements, patterns to watch]

üéØ Vocabulary Range:
[New words used well, vocabulary gaps, suggestions]

üé§ Pronunciation & Clarity:
[Specific sounds/words to practice, accent patterns]

üß† Comprehension & Responses:
[How well you understood prompts, response appropriateness]

üí° THIS WEEK'S FOCUS REVIEW:
[What we worked on this week: _____ ]
[Results: _____ ]

üéØ ACTION ITEMS FOR NEXT WEEK:
1. [Specific, actionable practice goal]
2. [Specific, actionable practice goal]
3. [Specific, actionable practice goal]

üîÆ NEXT WEEK'S THEME:
Topic: [Preview of next week's conversation focus]
Goal: [What we'll practice]

Excellent work this week! Your consistency is paying off! üí™‚ú®`,

      biweekly: `Day [X] Check-in ‚ú®

Quick review of your last [X] responses:

‚úÖ GOING WELL:
- [Highlight 1-2 wins]

‚ö†Ô∏è WATCH FOR:
- [1 pattern to improve]

üí° PRACTICE TIP: [Quick actionable advice]`,

      daily: `Great work today! üëè

‚úÖ [Specific thing they did well]

üí° Quick tip: [One correction/suggestion]

Keep practicing! üåü`
    };

    // ============================================
    // AUTHENTICATION & INITIALIZATION
    // ============================================

    async function checkAuth() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      
      if (!session) {
        window.location.href = '/teacher-login.html';
        return;
      }
      
// Get teacher info
      const { data: teacher, error } = await supabaseClient
        .from('teachers')
        .select('*')
        .eq('auth_user_id', session.user.id)
        .single();
      
      if (error || !teacher || !teacher.is_active) {
        await supabaseClient.auth.signOut();
        window.location.href = '/teacher-login.html';
        return;
      }
      
      currentTeacher = teacher;
      document.getElementById('teacher-name').textContent = teacher.full_name;
      
      // Load completed feedback from today
      await loadCompletedToday();
      
      // Load feedback queue
      await loadFeedbackQueue();
      
      // Load video lessons
      await loadVideoLessons();
    }
    
    // ============================================
    // LOAD COMPLETED FEEDBACK FROM TODAY
    // ============================================
    async function loadCompletedToday() {
      try {
        const todayStart = new Date();
        todayStart.setHours(0, 0, 0, 0);
        
        const { data: todaysFeedback, error } = await supabaseClient
          .from('feedback_log')
          .select('student_id')
          .eq('teacher_id', currentTeacher.id)
          .gte('sent_at', todayStart.toISOString());
        
        if (error) throw error;
        
        // Populate completedToday Set
        completedToday = new Set(todaysFeedback.map(f => f.student_id));
        
      } catch (err) {
        console.error('Error loading completed feedback:', err);
      }
    }

    // ============================================
    // LOAD FEEDBACK QUEUE
    // ============================================

    async function loadFeedbackQueue() {
      try {
        // Get all assigned students with their progress
        const { data: assignments, error: assignError } = await supabaseClient
          .from('student_teacher_assignments')
          .select(`
            student_id,
            questionnaire_responses (
              id,
              user_id,
              given_name_romaji,
              name,
              line_id,
              plan
            )
          `)
          .eq('teacher_id', currentTeacher.id);

        if (assignError) throw assignError;

        const students = assignments.map(a => a.questionnaire_responses).filter(Boolean);

        // Get progress for all students using user_id
        const userIds = students.map(s => s.user_id).filter(Boolean);
        const { data: progressData, error: progressError } = await supabaseClient
          .from('student_progress')
          .select('*')
          .in('user_id', userIds);

        if (progressError) throw progressError;

        // Categorize by plan and feedback need
        feedbackQueue = { planA: [], planC1: [], planC2: [] };

        for (const student of students) {
          const progress = progressData.find(p => p.user_id === student.user_id);
          if (!progress) continue;

          const studentData = {
  ...student,
  ...progress,
  needsFeedback: await checkIfNeedsFeedback(student.plan, progress, student.user_id)
};

          if (studentData.needsFeedback) {
            if (student.plan === 'A') feedbackQueue.planA.push(studentData);
            else if (student.plan === 'C1') feedbackQueue.planC1.push(studentData);
            else if (student.plan === 'C2') feedbackQueue.planC2.push(studentData);
          }
        }

        // Render the queue
        renderFeedbackQueue();
        updateStats();

      } catch (err) {
        console.error('Error loading feedback queue:', err);
        alert('Error loading students. Please refresh the page.');
      }
    }

    // ============================================
    // CHECK IF STUDENT NEEDS FEEDBACK
    // ============================================

    async function checkIfNeedsFeedback(plan, progress, userId) {
  const { current_day, total_prompts_sent } = progress;

  if (plan === 'A') {
    // Weekly: Day 7, 14, 21, 28
    return total_prompts_sent % 7 === 0 && current_day === 7;
  } else if (plan === 'C1') {
    // Bi-weekly: Days 3 and 7
    return current_day === 3 || current_day === 7;
  } else if (plan === 'C2') {
    // Daily - but only if they responded today
    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0);
    
    const { data: todayResponse, error: responseError } = await supabaseClient
  .from('message_log')
  .select('id')
  .eq('user_id', userId)
  .eq('message_type', 'student_response')
  .gte('created_at', todayStart.toISOString())
  .maybeSingle();

if (responseError && responseError.code !== 'PGRST116') {
  console.error('Error checking student response:', responseError);
}
    
    return !!todayResponse; // True only if they responded today
  }

  return false;
}

    // ============================================
    // RENDER FEEDBACK QUEUE
    // ============================================

    function renderFeedbackQueue() {
      renderPlanSection('plan-c2-students', feedbackQueue.planC2, 'daily');
      renderPlanSection('plan-c1-students', feedbackQueue.planC1, 'biweekly');
      renderPlanSection('plan-a-students', feedbackQueue.planA, 'weekly');
    }

    function renderPlanSection(containerId, students, templateType) {
      const container = document.getElementById(containerId);
      
      if (students.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-check-circle"></i>
            <p>No students need feedback today!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = students.map(student => createStudentCard(student, templateType)).join('');

      // Add event listeners ONLY for buttons that DON'T have inline onclick
      students.forEach(student => {
        const card = document.getElementById(`student-${student.id}`);
        const sendBtn = card.querySelector('.send-btn');
        const markDoneBtn = card.querySelector('.mark-done-btn');
        const templateBtns = card.querySelectorAll('.template-btn');

        // NOTE: expandBtn now uses inline onclick="toggleCard()", so we don't add a listener here
        sendBtn.addEventListener('click', () => sendFeedback(student.id));
        markDoneBtn.addEventListener('click', () => markComplete(student.id));
        
        templateBtns.forEach(btn => {
          btn.addEventListener('click', () => loadTemplate(student.id, btn.dataset.template));
        });
      });
    }

    function createStudentCard(student, templateType) {
      const isDone = completedToday.has(student.id);
      const isPriority = student.current_day === 7 && student.current_week === 1;

      return `
        <div class="student-card" id="student-${student.id}">
          <div class="student-header">
            <div>
              <div class="student-name">
                ${student.given_name_romaji || student.name}
                ${isPriority ? '<span class="priority-badge">‚≠ê NEW</span>' : ''}
                ${isDone ? '<span class="priority-badge" style="background:#4caf50;">‚úì DONE</span>' : ''}
              </div>
              <div class="student-meta">
                Day ${student.current_day}/Week ${student.current_week} | 
                Total prompts: ${student.total_prompts_sent}
              </div>
            </div>
<div style="display: flex; gap: 0.5rem;">
  <button class="expand-btn" onclick="toggleCard(${student.id})">
    ${isDone ? 'View' : 'Send Feedback'} ‚ñº
  </button>
  <button class="expand-btn" onclick="event.stopPropagation(); openAssessmentModal(${student.id})" style="background: var(--color-gold);">
    üìä Assess Skills
  </button>
</div>
         </div> 
          <div class="student-details">
            <!-- Filter Bar -->
<div class="filter-bar" id="filter-bar-${student.id}">
  <span class="filter-label">Show:</span>
  
  <!-- Desktop: Buttons -->
  <div class="filter-buttons-desktop">
    <button class="filter-btn active" data-filter="recent" data-student="${student.id}">
      Since Last Feedback
    </button>
    <button class="filter-btn" data-filter="3" data-student="${student.id}">
      3 Days
    </button>
    <button class="filter-btn" data-filter="7" data-student="${student.id}">
      7 Days
    </button>
    <button class="filter-btn" data-filter="14" data-student="${student.id}">
      14 Days
    </button>
    <button class="filter-btn" data-filter="30" data-student="${student.id}">
      30 Days
    </button>
    <button class="filter-btn" data-filter="all" data-student="${student.id}">
      All
    </button>
  </div>
  
  <!-- Mobile: Dropdown -->
<select class="filter-select-mobile" id="filter-${student.id}" data-student="${student.id}">
    <option value="recent" selected>Since Last Feedback</option>
    <option value="3">Last 3 Days</option>
    <option value="7">Last 7 Days</option>
    <option value="14">Last 14 Days</option>
    <option value="30">Last 30 Days</option>
    <option value="all">All Messages</option>
  </select>
  
  <span class="message-count" id="msg-count-${student.id}"></span>
</div>
            
            <div id="responses-${student.id}">
              <p>Loading conversation...</p>
            </div>
            
            <div class="feedback-box">
              <h3>Send Feedback</h3>
              <div class="template-selector">
                <button class="template-btn active" data-template="${templateType}">
                  Load Template
                </button>
                <button class="template-btn" data-template="blank">
                  Start Blank
                </button>
              </div>
              
              <textarea 
                class="feedback-textarea" 
                id="feedback-${student.id}"
                placeholder="Write your feedback here..."
              >${templates[templateType]}</textarea>
              
              <div class="action-buttons">
                <button class="send-btn" ${isDone ? 'disabled' : ''}>
                  <i class="fas fa-paper-plane"></i> Send to LINE
                </button>
                <button class="mark-done-btn" ${isDone ? 'disabled' : ''}>
                  <i class="fas fa-check"></i> Mark Complete
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // ============================================
    // CARD INTERACTIONS
    // ============================================

    async function toggleCard(studentId) {
      const card = document.getElementById(`student-${studentId}`);
      const isExpanded = card.classList.contains('expanded');

      // Close all other cards
      document.querySelectorAll('.student-card').forEach(c => c.classList.remove('expanded'));

      if (!isExpanded) {
        card.classList.add('expanded');
        
        // Initialize filter to 'recent' if not set
        if (!currentFilters[studentId]) {
          currentFilters[studentId] = 'recent';
        }
        
        await loadStudentResponses(studentId, currentFilters[studentId]);
        
        // Add filter button listeners (desktop)
const filterBtns = card.querySelectorAll('.filter-btn');
filterBtns.forEach(btn => {
  btn.addEventListener('click', async (e) => {
    const filter = e.target.dataset.filter;
    const sid = parseInt(e.target.dataset.student);
    
    // Update active state
    filterBtns.forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    
    // Update current filter and reload
    currentFilters[sid] = filter;
    await loadStudentResponses(sid, filter);
  });
});

// Add dropdown listener (mobile)
const filterSelect = card.querySelector('.filter-select-mobile');
if (filterSelect) {
  filterSelect.addEventListener('change', async (e) => {
    const filter = e.target.value;
    const sid = parseInt(e.target.dataset.student);
    
    // Update current filter and reload
    currentFilters[sid] = filter;
    await loadStudentResponses(sid, filter);
  });
}
      }
    }

    // ============================================
    // LOAD STUDENT RESPONSES WITH FILTER
    // ============================================

    async function loadStudentResponses(studentId, daysFilter = 'recent') {
      const container = document.getElementById(`responses-${studentId}`);
      const msgCountEl = document.getElementById(`msg-count-${studentId}`);
      container.innerHTML = '<p style="text-align:center; padding:1rem; color:#999;"><i class="fas fa-spinner fa-spin"></i> Loading...</p>';

      try {
        const student = [...feedbackQueue.planA, ...feedbackQueue.planC1, ...feedbackQueue.planC2]
          .find(s => s.id === studentId);
        
        if (!student || !student.user_id) {
          container.innerHTML = '<p>Error: Could not find student data.</p>';
          return;
        }

        // Calculate date range based on filter
        let startDate;
        
        if (daysFilter === 'recent') {
          // Get last feedback date
          const { data: lastFeedback } = await supabaseClient
            .from('feedback_log')
            .select('sent_at')
            .eq('student_id', studentId)
            .order('sent_at', { ascending: false })
            .limit(1)
            .single();
          
          if (lastFeedback) {
            // Show the entire day of the last feedback (start of that day)
            const feedbackDate = new Date(lastFeedback.sent_at);
            feedbackDate.setHours(0, 0, 0, 0);
            startDate = feedbackDate;
          } else {
            // No feedback yet, show last 3 days
            startDate = new Date(Date.now() - 3 * 24 * 60 * 60 * 1000);
          }
        } else if (daysFilter === 'all') {
          startDate = new Date('2000-01-01'); // Very old date
        } else {
          // Specific number of days
          const days = parseInt(daysFilter);
          startDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
        }

        // Get messages
        const { data: messages, error } = await supabaseClient
          .from('message_log')
          .select('*')
          .eq('user_id', student.user_id)
          .in('message_type', ['prompt', 'student_response'])
          .gte('created_at', startDate.toISOString())
          .order('created_at', { ascending: true });

        if (error) throw error;

        // Get teacher feedback
        const { data: teacherFeedback, error: feedbackError } = await supabaseClient
          .from('feedback_log')
          .select('*')
          .eq('student_id', studentId)
          .gte('sent_at', startDate.toISOString())
          .order('sent_at', { ascending: true });

        if (feedbackError) console.error('Error loading feedback:', feedbackError);

        // Combine messages and feedback
        const allMessages = [
          ...messages.map(m => ({ ...m, type: 'message', created_at: m.created_at })),
          ...(teacherFeedback || []).map(f => ({ ...f, type: 'feedback', created_at: f.sent_at }))
        ].sort((a, b) => new Date(a.created_at) - new Date(b.created_at));

        // Update message count
        if (msgCountEl) {
          msgCountEl.textContent = `Showing ${allMessages.length} message${allMessages.length !== 1 ? 's' : ''}`;
        }

        if (allMessages.length === 0) {
          container.innerHTML = '<p style="text-align:center; padding:2rem; color:#999;">No conversation history in this time range.</p>';
          return;
        }

        // Group messages by date
        const messagesByDate = {};
        allMessages.forEach(msg => {
          const date = new Date(msg.created_at).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          });
          if (!messagesByDate[date]) messagesByDate[date] = [];
          messagesByDate[date].push(msg);
        });

        // Render as conversation
        let html = '';
        Object.entries(messagesByDate).reverse().forEach(([date, msgs]) => {
          html += `<div style="margin-bottom: 2rem;">
            <h4 style="color: #666; border-bottom: 1px solid #ddd; padding-bottom: 0.5rem;">
              üìÖ ${date}
            </h4>`;
          
          msgs.forEach(msg => {
            const time = new Date(msg.created_at).toLocaleTimeString('en-US', { 
              hour: '2-digit', 
              minute: '2-digit' 
            });
            
            if (msg.type === 'message' && msg.message_type === 'prompt') {
              // Prompt from bot
              html += `
                <div style="margin: 1rem 0; padding: 1rem; background: #f0f8ff; border-left: 3px solid #4A90E2; border-radius: 4px;">
                  <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">
                    [${time}] ü§ñ <strong>Prompt:</strong>
                  </div>
                  <p style="margin: 0; color: #333;">"${msg.message_text}"</p>
                </div>`;
            } else if (msg.type === 'message' && msg.message_type === 'student_response') {
              // Student response
              html += `
                <div style="margin: 1rem 0; padding: 1rem; background: #fff; border: 1px solid #e0e0e0; border-radius: 4px;">
                  <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">
                    [${time}] üë§ <strong>${student.given_name_romaji || student.name}:</strong>
                  </div>`;
              
              if (msg.message_text) {
                html += `<p style="margin: 0.5rem 0; color: #333;">"${msg.message_text}"</p>`;
              }
              
              if (msg.media_type === 'audio') {
                html += `
                  <div style="margin-top: 0.5rem;">
                    <audio controls style="width: 100%; max-width: 400px;">
                      <source src="https://luyzyzefgintksydmwoh.supabase.co/functions/v1/get-line-media?messageId=${msg.message_id}">
                      Your browser does not support audio playback.
                    </audio>
                  </div>`;
              }
              
              if (msg.media_type === 'video') {
                html += `
                  <div style="margin-top: 0.5rem;">
                    <video controls style="width: 100%; max-width: 400px; border-radius: 8px;">
                      <source src="https://luyzyzefgintksydmwoh.supabase.co/functions/v1/get-line-media?messageId=${msg.message_id}">
                      Your browser does not support video playback.
                    </video>
                  </div>`;
              }
              
              if (msg.media_type === 'image') {
                html += `
                  <div style="margin-top: 0.5rem;">
                    <img src="https://luyzyzefgintksydmwoh.supabase.co/functions/v1/get-line-media?messageId=${msg.message_id}" 
                         style="max-width: 100%; border-radius: 8px; cursor: pointer;"
                         onclick="window.open(this.src, '_blank')"
                         alt="Student response image">
                  </div>`;
              }
              
              html += `</div>`;
            } else if (msg.type === 'feedback') {
              // Teacher feedback
              html += `
                <div style="margin: 1rem 0; padding: 1rem; background: #f0fff0; border-left: 3px solid #4caf50; border-radius: 4px;">
                  <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">
                    [${time}] üë®‚Äçüè´ <strong>Teacher Feedback:</strong>
                  </div>
                  <p style="margin: 0; color: #333; white-space: pre-wrap;">${msg.feedback_text}</p>
                </div>`;
            }
          });
          
          html += `</div>`;
        });

        container.innerHTML = html;

      } catch (err) {
        console.error('Error loading conversation:', err);
        container.innerHTML = '<p style="color:red;">Error loading conversation history.</p>';
      }
    }

    function loadTemplate(studentId, templateType) {
      const textarea = document.getElementById(`feedback-${studentId}`);
      const card = document.getElementById(`student-${studentId}`);
      const templateBtns = card.querySelectorAll('.template-btn');

      templateBtns.forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      if (templateType === 'blank') {
        textarea.value = '';
      } else {
        textarea.value = templates[templateType];
      }
    }

    // ============================================
    // SEND FEEDBACK
    // ============================================

    async function sendFeedback(studentId) {
      const textarea = document.getElementById(`feedback-${studentId}`);
      const feedbackText = textarea.value.trim();

      if (!feedbackText) {
        alert('Please write some feedback first!');
        return;
      }

      if (!confirm('Send this feedback to the student via LINE?')) {
        return;
      }

      const sendBtn = event.target;
      const originalHTML = sendBtn.innerHTML;
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

      try {
        // Call Edge Function to send to LINE
        const response = await fetch('https://luyzyzefgintksydmwoh.supabase.co/functions/v1/send-teacher-feedback', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${(await supabaseClient.auth.getSession()).data.session.access_token}`
          },
          body: JSON.stringify({
            studentId,
            feedbackText,
            teacherId: currentTeacher.id
          })
        });

        if (!response.ok) throw new Error('Failed to send feedback');

        // Auto-mark as complete
        completedToday.add(studentId);
        
        alert('Feedback sent successfully!');
        
        // Reload the queue to update UI
        await loadFeedbackQueue();

      } catch (err) {
        console.error('Error sending feedback:', err);
        alert('Error sending feedback. Please try again.');
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalHTML;
      }
    }

    async function markComplete(studentId) {
      completedToday.add(studentId);
      await loadFeedbackQueue();
      updateStats();
    }

    // ============================================
    // UPDATE STATS
    // ============================================

    function updateStats() {
      const totalStudents = feedbackQueue.planA.length + feedbackQueue.planC1.length + feedbackQueue.planC2.length;
      const completed = completedToday.size;
      
      // Estimate time: 12 min for weekly, 5 min for biweekly, 3 min for daily
      const remainingA = feedbackQueue.planA.filter(s => !completedToday.has(s.id)).length;
      const remainingC1 = feedbackQueue.planC1.filter(s => !completedToday.has(s.id)).length;
      const remainingC2 = feedbackQueue.planC2.filter(s => !completedToday.has(s.id)).length;
      
      const estimatedMinutes = 
        (remainingA * 12) +
        (remainingC1 * 5) +
        (remainingC2 * 3);
      
      const hours = Math.floor(estimatedMinutes / 60);
      const minutes = estimatedMinutes % 60;

      document.getElementById('total-students').textContent = totalStudents;
      document.getElementById('today-feedback').textContent = totalStudents;
      document.getElementById('completed-today').textContent = `${completed}/${totalStudents}`;
      document.getElementById('estimated-time').textContent = estimatedMinutes > 0 
        ? (hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`)
        : '0m';
    }

    // ============================================
    // LOGOUT
    // ============================================

    document.getElementById('logout-btn').addEventListener('click', async () => {
      if (confirm('Are you sure you want to logout?')) {
        await supabaseClient.auth.signOut();
        window.location.href = '/teacher-login.html';
      }
    });

    // ============================================
    // INITIALIZE
    // ============================================

    checkAuth();

    // Auto-refresh every 5 minutes
    setInterval(() => {
      loadFeedbackQueue();
      loadVideoLessons();  // üÜï ADD THIS LINE
    }, 5 * 60 * 1000);
    // ============================================
// ASSESSMENT MODAL FUNCTIONS
// ============================================

let currentAssessmentStudent = null;

// Skill guides
const skillGuides = {
  fluency: {
    title: 'üåä Fluency Scoring Guide',
    levels: [
      { score: '0-2', desc: 'Cannot make sentences / constant stopping' },
      { score: '3-5', desc: 'Simple sentences with lots of pauses. Example: "I... uh... go to... restaurant"' },
      { score: '6-8', desc: 'Smooth simple sentences, hesitates on complex ideas. Example: "Yesterday I went to a new restaurant downtown. The food was really good."' },
      { score: '9-10', desc: 'Sounds natural, occasional pause for complex thoughts. Example: "I\'ve been meaning to try that place for ages! How was the ambiance?"' }
    ]
  },
  grammar: {
    title: 'üìê Grammar Scoring Guide',
    levels: [
      { score: '0-2', desc: 'No grammar structure visible' },
      { score: '3-5', desc: 'Basic errors in simple sentences. Example: "I go yesterday" / "She very happy"' },
      { score: '6-8', desc: 'Simple sentences mostly correct, complex attempts have errors. Example: "I went yesterday" ‚úì but "If I would have..." ‚úó' },
      { score: '9-10', desc: 'Near-perfect, maybe misses a preposition occasionally' }
    ]
  },
  comprehension: {
    title: 'üß† Comprehension Scoring Guide',
    levels: [
      { score: '0-2', desc: 'Cannot understand basic prompts' },
      { score: '3-5', desc: 'Understands "What did you eat?" but not "How did the meal make you feel?"' },
      { score: '6-8', desc: 'Gets general meaning, misses some subtleties' },
      { score: '9-10', desc: 'Catches everything, including implied meanings' }
    ]
  },
  vocabulary: {
    title: 'üí¨ Vocabulary Scoring Guide',
    levels: [
      { score: '0-2', desc: 'Only knows a few words ("hello", "yes", "no")' },
      { score: '3-5', desc: '"Good", "bad", "like", "not like" - very basic' },
      { score: '6-8', desc: 'Can describe daily life but struggles with abstract concepts' },
      { score: '9-10', desc: 'Uses "grab a bite", "catch up", "on the fence" naturally' }
    ]
  },
  pronunciation: {
    title: 'üé§ Pronunciation Scoring Guide',
    levels: [
      { score: '0-2', desc: 'Incomprehensible' },
      { score: '3-5', desc: 'Very heavy accent affecting understanding. Example: "My name is..." sounds like "Mai naim ee..."' },
      { score: '6-8', desc: 'Accent present but understandable, misses word stress sometimes' },
      { score: '9-10', desc: 'Could be mistaken for native speaker' }
    ]
  }
};

async function openAssessmentModal(studentId) {
  currentAssessmentStudent = studentId;
  
  // Find student data
  const student = [...feedbackQueue.planA, ...feedbackQueue.planC1, ...feedbackQueue.planC2]
    .find(s => s.id === studentId);
  
  if (!student) {
    alert('Error: Student not found');
    return;
  }
  
  // Update modal header
  document.getElementById('assessment-student-name').textContent = 
    `${student.given_name_romaji || student.name} - ${student.level || 'Not set'}`;
  
  // Load previous assessment
  try {
    const { data: prevAssessment, error } = await supabaseClient
      .from('student_assessments')
      .select('*')
      .eq('student_id', studentId)
      .order('assessed_at', { ascending: false })
      .limit(1)
      .maybeSingle();
    
    if (error && error.code !== 'PGRST116') {
      console.error('Error loading previous assessment:', error);
    }
    
    // Set previous scores or defaults
    const skills = ['fluency', 'grammar', 'comprehension', 'vocabulary', 'pronunciation'];
    skills.forEach(skill => {
      const prevScore = prevAssessment ? prevAssessment[skill] : '-';
      document.getElementById(`${skill}-prev`).textContent = prevScore;
      
      // Set suggested score (previous + 1 if exists, else based on level)
      let suggested = 5; // default
      if (prevAssessment) {
        suggested = Math.min(prevAssessment[skill] + 1, 10);
      } else {
        // Initial assessment based on student level
        const levelMap = {
          'Super Beginner': 2,
          'Beginner': 4,
          'Intermediate': 7,
          'Advanced': 9
        };
        suggested = levelMap[student.level] || 5;
      }
      
      document.getElementById(`${skill}-suggested`).textContent = suggested;
      document.getElementById(`${skill}-slider`).value = suggested;
      document.getElementById(`${skill}-score`).textContent = suggested;
    });
    
  } catch (err) {
    console.error('Error loading assessment data:', err);
  }
  
  // Set up slider listeners
  const skills = ['fluency', 'grammar', 'comprehension', 'vocabulary', 'pronunciation'];
  skills.forEach(skill => {
    const slider = document.getElementById(`${skill}-slider`);
    slider.oninput = () => {
      document.getElementById(`${skill}-score`).textContent = slider.value;
      updateAssessmentSummary();
    };
  });
  
  // Initial summary calculation
  updateAssessmentSummary();
  
  // Show modal
  document.getElementById('assessment-modal').classList.add('active');
}

function closeAssessmentModal() {
  document.getElementById('assessment-modal').classList.remove('active');
  currentAssessmentStudent = null;
}

function updateAssessmentSummary() {
  const skills = ['fluency', 'grammar', 'comprehension', 'vocabulary', 'pronunciation'];
  let total = 0;
  
  skills.forEach(skill => {
    const value = parseInt(document.getElementById(`${skill}-slider`).value);
    total += value;
  });
  
  document.getElementById('total-score').textContent = `${total}/50`;
  
  // Determine band
  let band = 'Super Beginner';
  if (total >= 39) band = 'Advanced';
  else if (total >= 26) band = 'Intermediate';
  else if (total >= 13) band = 'Beginner';
  
  document.getElementById('overall-band').textContent = band;
  
  // Calculate change (if previous scores exist)
  const prevTotal = skills.reduce((sum, skill) => {
    const prev = document.getElementById(`${skill}-prev`).textContent;
    return sum + (prev !== '-' ? parseInt(prev) : 0);
  }, 0);
  
  if (prevTotal > 0) {
    const change = total - prevTotal;
    const changeEl = document.getElementById('score-change');
    changeEl.textContent = change >= 0 ? `+${change}` : change;
    changeEl.style.color = change >= 0 ? 'var(--color-success)' : 'var(--color-error)';
  } else {
    document.getElementById('score-change').textContent = 'Initial';
  }
}

async function submitAssessment() {
  if (!currentAssessmentStudent) {
    alert('Error: No student selected');
    return;
  }
  
  const submitBtn = document.getElementById('submit-assessment-btn');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
  
  try {
    // Get student data
    const student = [...feedbackQueue.planA, ...feedbackQueue.planC1, ...feedbackQueue.planC2]
      .find(s => s.id === currentAssessmentStudent);
    
    if (!student || !student.user_id) {
      throw new Error('Student user_id not found');
    }
    
    // Collect scores
    const assessment = {
      user_id: student.user_id,
      student_id: currentAssessmentStudent,
      assessed_by: currentTeacher.id,
      fluency: parseInt(document.getElementById('fluency-slider').value),
      grammar: parseInt(document.getElementById('grammar-slider').value),
      comprehension: parseInt(document.getElementById('comprehension-slider').value),
      vocabulary: parseInt(document.getElementById('vocabulary-slider').value),
      pronunciation: parseInt(document.getElementById('pronunciation-slider').value),
      teacher_notes: document.getElementById('assessment-notes').value.trim() || null,
      assessment_type: 'monthly'
    };
    
    // Save to database
    const { data, error } = await supabaseClient
      .from('student_assessments')
      .insert([assessment])
      .select()
      .single();
    
    if (error) throw error;
    
    alert('Assessment saved successfully! ‚úÖ');
    closeAssessmentModal();
    
  } catch (err) {
    console.error('Error saving assessment:', err);
    alert('Error saving assessment. Please try again.');
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Assessment';
  }
}

function showGuide(skillName) {
  const guide = skillGuides[skillName];
  if (!guide) return;
  
  let html = `<h3>${guide.title}</h3>`;
  guide.levels.forEach(level => {
    html += `
      <div class="guide-level">
        <h4>Score ${level.score}</h4>
        <p>${level.desc}</p>
      </div>
    `;
  });
  
  document.getElementById('guide-body').innerHTML = html;
  document.getElementById('guide-popup').classList.add('active');
}

function closeGuide() {
  document.getElementById('guide-popup').classList.remove('active');
}

// Close modals on outside click
document.addEventListener('click', (e) => {
  if (e.target.classList.contains('assessment-modal')) {
    closeAssessmentModal();
  }
  if (e.target.classList.contains('guide-popup')) {
    closeGuide();
  }
});
    // ============================================
// VIDEO LESSONS FUNCTIONS
// ============================================

let currentBooking = null;

async function loadVideoLessons() {
  try {
    const now = new Date().toISOString();
    
    // Get all upcoming lessons
    const { data: bookings, error } = await supabaseClient
      .from('lesson_bookings')
      .select(`
        *,
        questionnaire_responses (
          given_name_romaji,
          name
        )
      `)
      .eq('status', 'scheduled')
      .gte('scheduled_at', now)
      .order('scheduled_at', { ascending: true });
    
    if (error) throw error;
    
    const container = document.getElementById('video-lessons-list');
    const alertContainer = document.getElementById('pending-alert');
    
    if (!bookings || bookings.length === 0) {
      container.innerHTML = '<p style="text-align: center; opacity: 0.8;">No upcoming video lessons scheduled.</p>';
      alertContainer.style.display = 'none';
      return;
    }
    
    // Count bookings without Meet links
    const pendingCount = bookings.filter(b => !b.google_meet_link).length;
    
    // Show alert if there are pending bookings
    if (pendingCount > 0) {
      alertContainer.innerHTML = `
        <div class="pending-alert" onclick="document.getElementById('video-lessons-section').scrollIntoView({ behavior: 'smooth' })">
          <div style="display: flex; align-items: center;">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
              <strong>${pendingCount} booking${pendingCount > 1 ? 's' : ''} need${pendingCount === 1 ? 's' : ''} a Google Meet link!</strong>
              <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 0.25rem;">
                Click to view and add meeting links
              </div>
            </div>
          </div>
          <i class="fas fa-chevron-down"></i>
        </div>
      `;
      alertContainer.style.display = 'block';
    } else {
      alertContainer.style.display = 'none';
    }
    
    // Render lesson cards
    const html = bookings.map(booking => {
      const student = booking.questionnaire_responses;
      const studentName = student?.given_name_romaji || student?.name || 'Unknown Student';
      const date = new Date(booking.scheduled_at);
      const hasLink = !!booking.google_meet_link;
      const isToday = date.toDateString() === new Date().toDateString();
      const isWithin24h = (date - new Date()) < 24 * 60 * 60 * 1000;
      
      return `
        <div class="lesson-card ${!hasLink ? 'needs-link' : ''}">
          <div class="lesson-header">
            <div>
              <div class="lesson-student">${studentName}</div>
              <div class="lesson-datetime">
                <div>
                  <i class="fas fa-calendar"></i>
                  ${date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}
                </div>
                <div>
                  <i class="fas fa-clock"></i>
                  ${date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                </div>
                <div>
                  <i class="fas fa-hourglass-half"></i>
                  ${booking.duration_minutes} min
                </div>
              </div>
              ${isToday ? '<div style="color: #ff9800; font-weight: 600; margin-top: 0.5rem;"><i class="fas fa-bell"></i> Today!</div>' : ''}
              ${isWithin24h && !isToday ? '<div style="color: #2196f3; font-weight: 600; margin-top: 0.5rem;"><i class="fas fa-info-circle"></i> Within 24 hours</div>' : ''}
            </div>
            <span class="lesson-status ${hasLink ? 'has-link' : 'no-link'}">
              ${hasLink ? '‚úì Meet Link Added' : '‚ö† No Meet Link'}
            </span>
          </div>
          
          <div class="lesson-actions">
  ${booking.google_calendar_event_id ? `
    <a href="https://calendar.google.com/calendar/u/0/r/eventedit/${booking.google_calendar_event_id}" 
       target="_blank" 
       class="add-link-btn">
      <i class="fas fa-calendar-plus"></i>
      ${hasLink ? 'Edit in Calendar' : 'Add Meet Link in Calendar'}
    </a>
  ` : `
    <a href="https://calendar.google.com/calendar/u/0/r/day/${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}" 
       target="_blank" 
       class="add-link-btn">
      <i class="fas fa-calendar"></i>
      Open Google Calendar
    </a>
  `}
  ${hasLink ? `
    <a href="${booking.google_meet_link}" target="_blank" class="join-meeting-btn">
      <svg width="16" height="16" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
        <path fill="#4285F4" d="M45.12 24.5c0-1.56-.14-3.06-.4-4.5H24v8.51h11.84c-.51 2.75-2.06 5.08-4.39 6.64v5.52h7.11c4.16-3.83 6.56-9.47 6.56-16.17z"/>
        <path fill="#34A853" d="M24 46c5.94 0 10.92-1.97 14.56-5.33l-7.11-5.52c-1.97 1.32-4.49 2.1-7.45 2.1-5.73 0-10.58-3.87-12.31-9.07H4.34v5.7C7.96 41.07 15.4 46 24 46z"/>
        <path fill="#FBBC05" d="M11.69 28.18C11.25 26.86 11 25.45 11 24s.25-2.86.69-4.18v-5.7H4.34C2.85 17.09 2 20.45 2 24c0 3.55.85 6.91 2.34 9.88l7.35-5.7z"/>
        <path fill="#EA4335" d="M24 10.75c3.23 0 6.13 1.11 8.41 3.29l6.31-6.31C34.91 4.18 29.93 2 24 2 15.4 2 7.96 6.93 4.34 14.12l7.35 5.7c1.73-5.2 6.58-9.07 12.31-9.07z"/>
      </svg>
      Join with Google Meet
    </a>
  ` : ''}
</div>
        </div>
      `;
    }).join('');
    
    container.innerHTML = html;
    
  } catch (err) {
    console.error('Error loading video lessons:', err);
    document.getElementById('video-lessons-list').innerHTML = 
      '<p style="text-align: center; color: #f44336;">Error loading lessons. Please refresh the page.</p>';
  }
}

function openMeetLinkModal(bookingId, studentName, datetime) {
  currentBooking = bookingId;
  document.getElementById('modal-booking-details').innerHTML = `
    <strong>${studentName}</strong><br>
    ${datetime}
  `;
  document.getElementById('meet-link-input').value = '';
  document.getElementById('meet-link-modal').classList.add('active');
}

function closeMeetLinkModal() {
  document.getElementById('meet-link-modal').classList.remove('active');
  currentBooking = null;
}

async function saveMeetLink() {
  if (!currentBooking) return;
  
  const meetLink = document.getElementById('meet-link-input').value.trim();
  
  if (!meetLink) {
    alert('Please enter a Google Meet link');
    return;
  }
  
  if (!meetLink.includes('meet.google.com')) {
    alert('Please enter a valid Google Meet link');
    return;
  }
  
  try {
    const { error } = await supabaseClient
      .from('lesson_bookings')
      .update({ google_meet_link: meetLink })
      .eq('id', currentBooking);
    
    if (error) throw error;
    
    alert('Google Meet link saved successfully! ‚úÖ');
    closeMeetLinkModal();
    loadVideoLessons();
    
  } catch (err) {
    console.error('Error saving Meet link:', err);
    alert('Error saving link. Please try again.');
  }
}

// Close modal on outside click
document.addEventListener('click', (e) => {
  if (e.target.id === 'meet-link-modal') {
    closeMeetLinkModal();
  }
});
  </script>
</body>
</html>
